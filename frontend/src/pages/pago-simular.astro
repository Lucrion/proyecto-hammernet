---
import EnvLoader from '../components/EnvLoader.astro';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Pago Seguro</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet" />
    <EnvLoader />
    <style>
      :root { --purple:#6a1b9a; --pink:#e91e63; --teal:#20c997; --gray:#6b7280; --light:#f8fafc; }
      body { font-family:'Open Sans',system-ui,Arial,sans-serif; background:#f5f7fb; }
      .stripe{display:grid;grid-template-columns:1fr 1fr 1fr;height:10px}
      .purple{background:var(--purple)} .pink{background:var(--pink)} .green{background:var(--teal)}
      .brand{margin:24px 32px}
      .brand .big{color:var(--purple);font-weight:700;font-size:22px}
      .brand .sub{color:var(--pink);font-weight:600;font-size:12px;margin-top:2px}
      .center{display:flex;justify-content:center}
      .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(16,24,40,.08);width:100%;max-width:560px;padding:24px;margin-top:16px}
      .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
      .label{color:#7b8395;font-size:12px}
      .merchant{display:flex;align-items:center;gap:8px;color:#1f2937;font-weight:600}
      .amount{color:#0f172a;font-weight:700;font-size:20px}
      .section{color:#7b8395;font-size:12px;margin:12px 0}
      .option{border:1px solid #e5e7eb;border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:4px;cursor:pointer}
      .option:hover{border-color:#cbd5e1}
      .opt-title{color:#111827;font-weight:600}
      .opt-sub{color:#7b8395;font-size:12px}
      .link{color:#2563eb;text-align:center;margin-top:16px}
      .footer{display:flex;align-items:center;gap:6px; color:#7b8395; font-size:12px; margin:24px 32px}
      .shield{width:16px;height:16px;background:#f59e0b;border-radius:50%}
    </style>
  </head>
  <body>
    <div class="stripe"><div class="purple"></div><div class="pink"></div><div class="green"></div></div>
    <div class="brand"><div class="big">webpay.</div><div class="sub">transbank.</div></div>
    <div class="center">
      <div class="card" style="max-width:980px;width:100%">
        <div class="row" style="gap:24px;align-items:flex-start">
          <div style="flex:1 1 50%">
            <div class="row">
              <div>
                <div class="label">Est√°s pagando en:</div>
                <div class="merchant"><img src="/images/logos/logo.webp" alt="Ferreter√≠a Patricio" style="width:22px;height:22px;border-radius:999px;object-fit:cover" onerror="this.src='/images/logos/herramientas.webp'"/><span id="merchantName">Ferreter√≠a Patricio</span></div>
              </div>
              <div>
                <div class="label">Monto a pagar:</div>
                <div class="amount" id="amountText">$0</div>
              </div>
            </div>
            <div class="section">Selecciona tu medio de pago:</div>
            <div style="display:flex; gap:12px">
              <div id="btnDebito" class="option" style="flex:1; border-color:#e5e7eb">
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <span style="color:#6b7280">üí≥</span>
                  <span id="debitoCheck" style="display:none; width:18px; height:18px; border-radius:999px; background:#6a1b9a; color:#fff; font-size:12px; line-height:18px; text-align:center">‚úì</span>
                </div>
                <div class="opt-title" style="text-align:center; color:#6b7280">D√©bito</div>
              </div>
              <div id="btnCredito" class="option" style="flex:1; border-color:#b37bd7">
                <div style="display:flex; justify-content:space-between; align-items:center">
                  <span style="color:#6a1b9a">üí≥</span>
                  <span id="creditoCheck" style="display:inline-block; width:18px; height:18px; border-radius:999px; background:#6a1b9a; color:#fff; font-size:12px; line-height:18px; text-align:center">‚úì</span>
                </div>
                <div class="opt-title" style="text-align:center; color:#6a1b9a">Cr√©dito</div>
              </div>
            </div>
            <div class="link"><a id="linkAnular" href="#">Anular compra y volver</a></div>
          </div>
          <div style="flex:1 1 50%">
            <div class="opt-title" style="margin-bottom:12px">Ingresa los datos de tu tarjeta:</div>
            <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:20px 18px;margin-bottom:12px; width:100%; min-height:160px">
              <div style="display:flex;justify-content:space-between;color:#7b8395;font-size:12px">
                <span style="display:flex;align-items:center;gap:6px"><img id="previewBrand" src="" alt="brand" style="width:20px;height:20px;display:none"/><span>Tarjeta</span></span>
                <span id="previewMethod">Cr√©dito</span>
              </div>
              <div id="previewNum" style="color:#1f2937;margin-top:12px;font-size:22px;letter-spacing:1px">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
              <div id="previewExp" style="color:#7b8395;font-size:12px">MM/AA</div>
            </div>
            
            <label class="label">N√∫mero de tarjeta</label>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px">
              <input id="inpCard" type="text" maxlength="19" placeholder="4111 1111 1111 1111" class="flex-1 border rounded px-3 py-2" />
            </div>
            <div class="row" style="gap:10px">
              <div style="flex:1">
                <label class="label">Fecha de expiraci√≥n</label>
                <input id="inpExp" type="text" maxlength="5" placeholder="MM/AA" class="w-full border rounded px-3 py-2" />
              </div>
              <div style="flex:1">
                <label class="label">CVV</label>
                <input id="inpCVV" maxlength="3" type="password"  placeholder="‚Ä¢‚Ä¢‚Ä¢" class="w-full border rounded px-3 py-2" />
              </div>
            </div>
            <label class="label">RUT</label>
            <input id="inpRut" type="text" maxlength="12" placeholder="12.345.678-9" class="w-full  border rounded px-3 py-2" style="margin-bottom:10px" />
            <label class="label">Nombre del titular</label>
            <input id="inpHolder" type="text" maxlength="80" placeholder="Nombre como aparece en la tarjeta" class="w-full border rounded px-3 py-2" style="margin-bottom:10px" />
            <button id="btnPagar" class="w-full" style="margin-top:14px;background:#6a1b9a;color:#fff;border:none;border-radius:10px;padding:12px 14px;font-weight:600">Pagar</button>
          </div>
        </div>9
      </div>
    </div>
    <div class="footer">
    <div id="banner" class="center" style="margin-top:8px"><div id="bannerBox" class="hidden" style="background:#eef2ff;color:#1e293b;padding:8px 12px;border-radius:8px"></div></div>
    <script>
      (function(){
        const params = new URLSearchParams(window.location.search);
        const ventaId = Number(params.get('venta_id')||'');
        const token = params.get('token')||'';
        const API_BASE = window.API_BASE || '/api';
        const info = document.getElementById('info');
        const banner = document.getElementById('banner');
        const showBanner = (status, data) => {
          let cls = 'bg-gray-200 text-gray-800';
          let msg = 'Procesando pago';
          const reason = data?.reason || data?.message || '';
          if (status === 'AUTHORIZED') { cls = 'bg-green-100 text-green-800'; msg = `Pago aprobado. Boleta electr√≥nica ${data?.buy_order || ''}`; }
          else if (status === 'REJECTED' || status === 'FAILED') { cls = 'bg-red-100 text-red-800'; msg = `Pago rechazado${reason?`: ${reason}`:''}`; }
          else if (status === 'ABORTED') { cls = 'bg-yellow-100 text-yellow-800'; msg = 'Pago cancelado por el cliente'; }
          else if (status === 'TIMEOUT') { cls = 'bg-yellow-100 text-yellow-800'; msg = 'Pago expirado por tiempo'; }
          else if (status === 'ERROR') { cls = 'bg-red-100 text-red-800'; msg = `Error de autenticaci√≥n${reason?`: ${reason}`:''}`; }
          const box = document.getElementById('bannerBox');
          box.className = `p-3 rounded ${cls}`;
          box.textContent = msg;
          box.classList.remove('hidden');
        };
        try { info.textContent = ''; } catch {}
        function parsePrecio(val){ try{ if (typeof val === 'number') return val; const s = String(val||'').replace(/[^0-9.,-]/g,''); if(!s) return 0; // Prefer punto como separador decimal
          const parts = s.split(','); const main = parts[0].replace(/\./g,''); const frac = parts[1]||''; const numStr = main + (frac?'.'+frac:''); const n = Number(numStr); return isNaN(n)?0:n; } catch { return 0; } }
        function getItems(){
          try{
            const a = JSON.parse(localStorage.getItem('carrito')||'[]');
            return Array.isArray(a) ? a : [];
          } catch { return []; }
        }
        function computeCartTotal(){
          try{
            const items = getItems();
            if (Array.isArray(items) && items.length) {
              const subtotal = items.reduce((acc,it)=> acc + Number(it.cantidad||0) * parsePrecio(it.precio_venta ?? it.precio ?? it.monto ?? 0), 0);
              return Number(subtotal||0);
            }
            const stored = localStorage.getItem('checkout_total');
            const val = parsePrecio(stored||0);
            return Number(val||0);
          } catch { return 0; }
        }
        async function resolveAmount(){
          const amt = Number(computeCartTotal()||0);
          const t=document.getElementById('amountText');
          if(t) t.textContent = '$'+Number(amt||0).toLocaleString('es-CL');
          return amt;
        }
        (function(){
          resolveAmount();
          try{
            window.addEventListener('carrito:changed', ()=>{ resolveAmount(); });
            window.addEventListener('storage', (e)=>{ if (['carrito','checkout_total'].includes(e.key)) resolveAmount(); });
          }catch{}
        })();
        const digitsOnly = (s)=> String(s||'').replace(/\D/g,'');
        function formatRutUI(v){ const s=String(v||'').replace(/[^0-9kK]/g,'').toUpperCase(); if(!s) return ''; const body=s.slice(0,-1); const dv=s.slice(-1); const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return dv? `${withDots}-${dv}` : withDots; }
        function validarRut(v){ const s=String(v||'').replace(/\./g,'').replace(/-/g,'').toUpperCase(); if(s.length<2) return false; const cuerpo=s.slice(0,-1); const dv=s.slice(-1); if(!/^\d+$/.test(cuerpo)) return false; let suma=0, m=2; for(let i=cuerpo.length-1;i>=0;i--){ suma += parseInt(cuerpo[i],10)*m; m = m===7 ? 2 : m+1; } const rest = 11 - (suma % 11); const dvCalc = rest===11 ? '0' : (rest===10 ? 'K' : String(rest)); return dvCalc === dv; }
        function detectBrand(n){ const s=digitsOnly(n); if(/^3[47]/.test(s)) return 'AMEX'; if(/^(?:5[1-5]|2(?:2[2-9]\d|[3-6]\d{2}|7[01]\d|720))/.test(s)) return 'MASTERCARD'; if(/^4/.test(s)) return 'VISA'; if(/^(?:3(?:0[0-5]|[68]))/.test(s)) return 'DINERS'; return 'CARD'; }
        function brandIconSrc(brand){ switch(brand){ case 'VISA': return '/images/cards/visa.svg'; case 'MASTERCARD': return '/images/cards/mastercard.svg'; default: return ''; } }
        function formatCardNumber(n){ const s=digitsOnly(n); const brand=detectBrand(s); if(brand==='AMEX'){ return s.replace(/(\d{1,4})(\d{1,6})?(\d{1,5})?/, (m,a,b,c)=> [a,b,c].filter(Boolean).join(' ')); } if(brand==='DINERS'){ return s.replace(/(\d{1,4})(\d{1,6})?(\d{1,4})?/, (m,a,b,c)=> [a,b,c].filter(Boolean).join(' ')); } return s.replace(/(\d{1,4})(\d{1,4})?(\d{1,4})?(\d{1,4})?/, (m,a,b,c,d)=> [a,b,c,d].filter(Boolean).join(' ')); }
        (function attachFormatters(){
          try{
            const rutEl=document.getElementById('inpRut');
            rutEl.addEventListener('input',()=>{ rutEl.value = formatRutUI(rutEl.value); });
            rutEl.addEventListener('blur',()=>{ if(!validarRut(rutEl.value)); });
          }catch{}
          try{
            const cardEl=document.getElementById('inpCard');
            cardEl.addEventListener('input',()=>{ cardEl.value = formatCardNumber(cardEl.value); document.getElementById('previewNum').textContent = cardEl.value || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; });
          }catch{}
          try{
            const expEl=document.getElementById('inpExp'); const pExp=document.getElementById('previewExp');
            let expDeleting=false; let prevRaw='';
            expEl.addEventListener('beforeinput',(e)=>{ try{ expDeleting = String(e.inputType||'').includes('delete'); }catch{ expDeleting=false; } });
            expEl.addEventListener('input',()=>{
              const raw = String(expEl.value||'').replace(/[^0-9]/g,'');
              let mm = raw.slice(0,2);
              let yy = raw.slice(2,4);
              if (mm.length===2){
                let mNum = parseInt(mm,10);
                if (isNaN(mNum) || mNum<=0) mNum = 1;
                if (mNum>12) mNum = 12;
                mm = String(mNum).padStart(2,'0');
                // Solo insertar "/" si NO estamos borrando
                const val = expDeleting ? mm : (yy ? `${mm}/${yy}` : `${mm}/`);
                expEl.value = val; if (pExp) pExp.textContent = val;
              } else {
                expEl.value = mm; if (pExp) pExp.textContent = mm || 'MM/AA';
              }
              prevRaw = raw; expDeleting=false;
            });
          }catch{}
        })();
        function decideStatus(card){ const s=digitsOnly(card); if(s==='4111111111111111') return { status:'AUTHORIZED' }; if(s==='4000000000000002') return { status:'REJECTED', reason:'Fondos insuficientes' }; if(s==='4000000000000069') return { status:'ABORTED' }; if(s==='4000000000009995') return { status:'TIMEOUT' }; if(!s || s.length<13) return { status:'ERROR', message:'Tarjeta inv√°lida' }; return { status:'AUTHORIZED' }; }
        // m√°s tarjetas reales de prueba aceptadas (aprobado)
        const successCards = ['4242424242424242','5555555555554444','378282246310005','30569309025904'];
        function extendedDecision(card){ const s=digitsOnly(card); if(successCards.includes(s)) return { status:'AUTHORIZED' }; return decideStatus(card); }
        function showProcessing(){ const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.background='#fff'; overlay.style.display='flex'; overlay.style.flexDirection='column'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.innerHTML = `
          <div style="display:flex;align-items:center;gap:18px;margin-bottom:12px">
            <div style="width:64px;height:64px;border-radius:999px;border:2px solid #eee;display:flex;align-items:center;justify-content:center"><span style="color:#e91e63;font-weight:700">webpay</span></div>
            <div style="display:flex;gap:6px"><span style="width:8px;height:8px;background:#6a1b9a;border-radius:999px;display:inline-block"></span><span style="width:8px;height:8px;background:#6a1b9a;border-radius:999px;display:inline-block;opacity:.6"></span><span style="width:8px;height:8px;background:#6a1b9a;border-radius:999px;display:inline-block;opacity:.3"></span></div>
            <div style="width:64px;height:64px;border-radius:999px;border:2px solid #eee;display:flex;align-items:center;justify-content:center"><span style="color:#6a1b9a">üè¶</span></div>
          </div>
          <div style="font-weight:700;color:#111827;margin-bottom:6px">Estamos procesando tu pago</div>
          <div style="color:#6b7280;font-size:14px;text-align:center;max-width:520px">Por favor no recargues ni cierres la pantalla para poder continuar con la transacci√≥n.</div>
        `; document.body.appendChild(overlay); return overlay; }
        let paymentMethod = 'credito';
        let cardBrand = '';
        function updateMethodUI(){
          try{
            const d=document.getElementById('btnDebito'); const c=document.getElementById('btnCredito');
            const dc=document.getElementById('debitoCheck'); const cc=document.getElementById('creditoCheck');
            const cuotas=document.getElementById('cuotasContainer');
            const pm=document.getElementById('previewMethod');
            if(paymentMethod==='debito'){
              d && (d.style.borderColor='#6a1b9a'); c && (c.style.borderColor='#e5e7eb');
              dc && (dc.style.display='inline-block'); cc && (cc.style.display='none');
              if (cuotas) cuotas.style.display='none';
              if (pm) pm.textContent = 'D√©bito';
            } else {
              c && (c.style.borderColor='#6a1b9a'); d && (d.style.borderColor='#e5e7eb');
              cc && (cc.style.display='inline-block'); dc && (dc.style.display='none');
              if (cuotas) cuotas.style.display='block';
              if (pm) pm.textContent = 'Cr√©dito';
            }
          }catch{}
        }
        async function sim(status, extra){
          const code = extra?.code || (paymentMethod==='debito' ? 'VD' : 'VC');
          const resp = await fetch(`${API_BASE}/pagos/simular/notificar`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ id_venta: ventaId, status, payment_type_code: code, amount: extra?.amount||0, installments_number: extra?.installments_number||0 }) });
          const data = await resp.json().catch(()=>({}));
          showBanner(status, data);
          const bo = data?.buy_order || '';
          if (status === 'AUTHORIZED') { window.location.replace('/orden-compra-detalle'+(bo?`?bo=${encodeURIComponent(bo)}`:'')); }
          else if (status === 'REJECTED') { const rs = data?.reason || extra?.reason || ''; window.location.replace('/orden-compra/REJECTED'+(bo?`?bo=${encodeURIComponent(bo)}`:'')+(rs?`${bo?'&':'?'}reason=${encodeURIComponent(rs)}`:'')); }
          else if (status === 'ABORTED') { window.location.replace('/orden-compra/ABORTED'+(bo?`?bo=${encodeURIComponent(bo)}`:'')); }
          else if (status === 'TIMEOUT') { window.location.replace('/orden-compra/TIMEOUT'+(bo?`?bo=${encodeURIComponent(bo)}`:'')); }
          else if (status === 'ERROR') { const msg = data?.message || extra?.message || ''; window.location.replace('/orden-compra/ERROR'+(bo?`?bo=${encodeURIComponent(bo)}`:'')+(msg?`${bo?'&':'?'}message=${encodeURIComponent(msg)}`:'')); }
        }
        document.getElementById('btnDebito').addEventListener('click', ()=>{ paymentMethod='debito'; updateMethodUI(); try{ document.getElementById('inpCard').focus(); }catch{} });
        document.getElementById('btnCredito').addEventListener('click', ()=>{ paymentMethod='credito'; updateMethodUI(); try{ document.getElementById('inpCard').focus(); }catch{} });
        // Detecci√≥n de marca (Visa) por primer d√≠gito
        try{
            const cardEl=document.getElementById('inpCard'); const icon=document.getElementById('brandIcon'); const pBrand=document.getElementById('previewBrand');
            cardEl.addEventListener('input',()=>{
              const raw = String(cardEl.value||'').replace(/\s+/g,'').replace(/[^0-9]/g,'');
            const brand = detectBrand(raw);
            if(brand==='VISA' || brand==='MASTERCARD'){ cardBrand=brand.toLowerCase(); if(icon){ icon.src = brandIconSrc(brand); icon.style.display='inline-block'; } if(pBrand){ pBrand.src = brandIconSrc(brand); pBrand.style.display='inline-block'; } }
            else { cardBrand=''; if(icon) icon.style.display='none'; if(pBrand) pBrand.style.display='none'; }
            });
        }catch{}

        // Cuotas cuando es cr√©dito
        let installments = 1;
        try{
          const btn=document.getElementById('btnCuotas'); const list=document.getElementById('cuotasList'); const cur=document.getElementById('cuotasActual');
          btn.addEventListener('click',()=>{ if(list) list.style.display = (list.style.display==='none' || !list.style.display) ? 'flex' : 'none'; });
          list.querySelectorAll('[data-cuotas]').forEach(el=>{
            el.addEventListener('click',()=>{ installments = Number(el.getAttribute('data-cuotas'))||1; cur.textContent = String(installments); list.classList.add('hidden'); });
          });
        }catch{}

        document.getElementById('btnPagar').addEventListener('click', async ()=>{
          const card = document.getElementById('inpCard')?.value||'';
          const rut = document.getElementById('inpRut')?.value||'';
          const holder = document.getElementById('inpHolder')?.value||'';
          if (!rut) { alert('Ingresa tu RUT'); return; }
          if (!validarRut(rut)) { alert('RUT inv√°lido'); return; }
          if (!holder || holder.trim().length < 3) { alert('Ingresa el nombre del titular'); return; }
          const amount = await resolveAmount();
          const decision = extendedDecision(card);
          const overlay = showProcessing();
          setTimeout(async ()=>{ try{ await sim(decision.status, { amount, code: (paymentMethod==='debito'?'VD':'VC'), installments_number: (paymentMethod==='credito'?installments:0), brand: cardBrand }); } catch(e){ try{ document.body.removeChild(overlay); }catch{} } }, 600);
        });
        document.getElementById('linkAnular').addEventListener('click', async (e)=>{ e.preventDefault(); await sim('ABORTED', {}); });
      })();
    </script>
  </body>
  </html>
