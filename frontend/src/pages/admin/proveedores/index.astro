---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestión de Proveedores">
	<div class="mb-6 flex justify-end items-center">
		<button id="btnNuevoProveedor" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
			</svg>
			Nuevo Proveedor
		</button>
	</div>

	<!-- Filtros -->
	<div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-3">
		<div>
			<label for="filtroNombre" class="block text-sm font-medium text-gray-700">Buscar por nombre</label>
			<input type="text" id="filtroNombre" placeholder="Nombre del proveedor" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
		</div>
		<div>
			<label for="filtroContacto" class="block text-sm font-medium text-gray-700">Buscar por contacto</label>
			<input type="text" id="filtroContacto" placeholder="Nombre del contacto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
		</div>
		<div class="flex items-end space-x-2">
			<button id="btnBuscar" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				Buscar
			</button>
		</div>
	</div>

	<!-- Tabla de proveedores -->
	<div class="bg-white shadow overflow-hidden sm:rounded-md">
		<div class="overflow-x-auto">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RUT</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Razón Social</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
					</tr>
				</thead>
				<tbody id="tablaProveedores" class="bg-white divide-y divide-gray-200">
					<!-- Los proveedores se cargarán aquí dinámicamente -->
				</tbody>
			</table>
		</div>
	</div>

	<!-- Paginación -->
	<div id="paginacion" class="mt-6 flex justify-center">
		<!-- La paginación se generará dinámicamente -->
	</div>

		<!-- Modal para nuevo/editar proveedor -->
		<div id="modalProveedor" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
			<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
				<div class="mt-3">
					<div class="flex justify-between items-center mb-4">
						<h3 id="tituloModal" class="text-lg font-medium text-gray-900">Nuevo Proveedor</h3>
						<button id="btnCerrarModal" class="text-gray-400 hover:text-gray-600">
							<i class="fas fa-times"></i>
						</button>
					</div>
					<form id="formProveedor">
						<input type="hidden" id="proveedorId">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div class="mb-4">
								<label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
								<input type="text" id="nombre" name="nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
							<div class="mb-4">
								<label for="rut" class="block text-sm font-medium text-gray-700 mb-2">RUT *</label>
            <input type="text" id="rut" name="rut" required maxlength="13" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" inputmode="numeric" placeholder="12.345.678-9">
							</div>
							<div class="mb-4">
								<label for="razon_social" class="block text-sm font-medium text-gray-700 mb-2">Razón Social *</label>
								<input type="text" id="razon_social" name="razon_social" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
							<div class="mb-4">
								<label for="sucursal" class="block text-sm font-medium text-gray-700 mb-2">Sucursal</label>
								<input type="text" id="sucursal" name="sucursal" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
							<div class="mb-4">
								<label for="ciudad" class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
								<input type="text" id="ciudad" name="ciudad" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
							<div class="mb-4">
								<label for="contacto" class="block text-sm font-medium text-gray-700 mb-2">Contacto</label>
								<input type="text" id="contacto" name="contacto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
							<div class="mb-4">
								<label for="celular" class="block text-sm font-medium text-gray-700 mb-2">Celular</label>
								<input type="tel" id="celular" name="celular" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
							</div>
					<div class="mb-4">
						<label for="correo" class="block text-sm font-medium text-gray-700 mb-2">Correo</label>
						<input type="email" id="correo" name="correo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
					</div>
					<div class="mb-4">
						<label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">Teléfono</label>
						<input type="tel" id="telefono" name="telefono" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
					</div>
				</div>
						<div class="mb-4">
							<label for="direccion" class="block text-sm font-medium text-gray-700 mb-2">Dirección</label>
							<textarea id="direccion" name="direccion" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
						</div>
						<div class="flex justify-end space-x-2">
							<button type="button" id="btnCancelar" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
								Cancelar
							</button>
							<button type="submit" id="btnGuardar" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
								Guardar
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Modal de confirmación para eliminar -->
		<div id="modalConfirmar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
			<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
				<div class="mt-3 text-center">
					<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
						<i class="fas fa-exclamation-triangle text-red-600"></i>
					</div>
					<h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmar eliminación</h3>
					<div class="mt-2 px-7 py-3">
						<p class="text-sm text-gray-500">¿Está seguro que desea eliminar este proveedor? Esta acción no se puede deshacer.</p>
					</div>
					<div class="flex justify-center space-x-2 mt-4">
						<button id="btnCancelarEliminar" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
							Cancelar
						</button>
						<button id="btnConfirmarEliminar" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
							Eliminar
						</button>
					</div>
				</div>
			</div>
		</div>
	</main>

    <script type="module">
    function buildUrl(endpoint){const base=(window.API_BASE||'/api');if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
    async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
    async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function postData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function updateData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function deleteData(endpoint){const r=await fetchWithAuth(endpoint,{method:'DELETE',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    function formatRutUI(v){const s=String(v||'').replace(/[^0-9kK]/g,'').toUpperCase();if(!s)return'';const b=s.slice(0,-1);const dv=s.slice(-1);const withDots=b.replace(/\B(?=(\d{3})+(?!\d))/g,'.');return `${withDots}-${dv}`}

    let proveedores = [];
    let proveedorEditando = null;
    let proveedorAEliminar = null;

    const tablaProveedores = document.getElementById('tablaProveedores');
    const formProveedor = document.getElementById('formProveedor');
    const modalProveedor = document.getElementById('modalProveedor');
    const modalConfirmar = document.getElementById('modalConfirmar');
    const btnNuevoProveedor = document.getElementById('btnNuevoProveedor');
    const btnCerrarModal = document.getElementById('btnCerrarModal');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnCancelarEliminar = document.getElementById('btnCancelarEliminar');
    const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');

    document.addEventListener('DOMContentLoaded', function() {
        obtenerProveedores();
        if (btnNuevoProveedor) { btnNuevoProveedor.addEventListener('click', abrirModalNuevo); }
        if (btnCerrarModal) { btnCerrarModal.addEventListener('click', cerrarModal); }
        if (btnCancelar) { btnCancelar.addEventListener('click', cerrarModal); }
        if (btnCancelarEliminar) { btnCancelarEliminar.addEventListener('click', cerrarModalConfirmar); }
        if (btnConfirmarEliminar) { btnConfirmarEliminar.addEventListener('click', confirmarEliminar); }
        if (formProveedor) {
            const rutEl = document.getElementById('rut');
            if (rutEl) { rutEl.addEventListener('input', (e) => { const formatted = formatRutUI(e.target.value); e.target.value = formatted; e.target.selectionStart = e.target.selectionEnd = formatted.length; }); }
            formProveedor.addEventListener('submit', guardarProveedor);
        }
    });

    async function obtenerProveedores() {
        try { proveedores = await getData('/api/proveedores/'); cargarProveedores(); } catch (error) { console.error('Error de conexión:', error); }
    }
    function cargarProveedores() {
        if (!tablaProveedores) return;
        if (proveedores.length === 0) { tablaProveedores.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay proveedores registrados</td></tr>'; return; }
        tablaProveedores.innerHTML = proveedores.map(proveedor => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proveedor.id_proveedor}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${proveedor.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proveedor.rut || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proveedor.razon_social || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${proveedor.contacto || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editarProveedor(${proveedor.id_proveedor})" class="text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                    <button onclick="eliminarProveedor(${proveedor.id_proveedor})" class="text-red-600 hover:text-red-900">Eliminar</button>
                </td>
            </tr>`).join('');
    }
    function abrirModalNuevo() { proveedorEditando = null; formProveedor.reset(); document.getElementById('tituloModal').textContent = 'Nuevo Proveedor'; modalProveedor.classList.remove('hidden'); }
    window.editarProveedor = function(id) {
        proveedorEditando = proveedores.find(p => p.id_proveedor === id);
        if (proveedorEditando) {
            document.getElementById('nombre').value = proveedorEditando.nombre;
            document.getElementById('rut').value = proveedorEditando.rut || '';
            document.getElementById('razon_social').value = proveedorEditando.razon_social || '';
            document.getElementById('sucursal').value = proveedorEditando.sucursal || '';
            document.getElementById('ciudad').value = proveedorEditando.ciudad || '';
            document.getElementById('contacto').value = proveedorEditando.contacto || '';
            document.getElementById('celular').value = proveedorEditando.celular || '';
            document.getElementById('correo').value = proveedorEditando.correo || '';
            const telefonoEl = document.getElementById('telefono'); if (telefonoEl) telefonoEl.value = proveedorEditando.telefono || '';
            document.getElementById('direccion').value = proveedorEditando.direccion || '';
            document.getElementById('tituloModal').textContent = 'Editar Proveedor'; modalProveedor.classList.remove('hidden');
        }
    };
    async function guardarProveedor(e) {
        e.preventDefault();
        const formData = new FormData(formProveedor);
        const proveedorData = {
            nombre: formData.get('nombre'),
            rut: formData.get('rut'),
            razon_social: formData.get('razon_social'),
            sucursal: formData.get('sucursal'),
            ciudad: formData.get('ciudad'),
            contacto: formData.get('contacto'),
            celular: formData.get('celular'),
            correo: formData.get('correo'),
            telefono: formData.get('telefono'),
            direccion: formData.get('direccion')
        };
        try {
            if (proveedorEditando) { await updateData(`/api/proveedores/${proveedorEditando.id_proveedor}`, proveedorData); cerrarModal(); obtenerProveedores(); alert('Proveedor actualizado correctamente'); }
            else { await postData('/api/proveedores/', proveedorData); cerrarModal(); obtenerProveedores(); alert('Proveedor creado correctamente'); }
        } catch (error) { console.error('Error:', error); alert('Error de conexión'); }
    }
    window.eliminarProveedor = function(id) { proveedorAEliminar = id; modalConfirmar.classList.remove('hidden'); };
    function cerrarModal() { modalProveedor.classList.add('hidden'); proveedorEditando = null; }
    window.cerrarModalConfirmar = function() { modalConfirmar.classList.add('hidden'); proveedorAEliminar = null; };
    window.confirmarEliminar = async function() { if (proveedorAEliminar) { try { await deleteData(`/api/proveedores/${proveedorAEliminar}`); obtenerProveedores(); alert('Proveedor eliminado correctamente'); } catch (error) { console.error('Error:', error); alert('Error de conexión'); } } cerrarModalConfirmar(); };
    </script>
</AdminLayout>
<script>
(function(){
  try {
    const env = window.__ENV__ || {};
    const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
    if (!window.API_BASE) window.API_BASE = api;
    if (!window.__API_BASE_LOGGED__) { console.log('Cargando script de login...'); console.log('API URL es:', window.API_BASE); window.__API_BASE_LOGGED__ = true; }
  } catch {}
})();
</script>
