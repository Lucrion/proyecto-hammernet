---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestión de Mensajes">
    

    <!-- Estado de carga -->
    <div id="loadingState" class="hidden">
        <div class="flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-2 text-gray-600">Cargando mensajes...</span>
        </div>
    </div>

    <!-- Estado vacío -->
    <div id="emptyState" class="hidden">
        <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No hay mensajes</h3>
            <p class="mt-1 text-sm text-gray-500">Aún no se han recibido mensajes de contacto.</p>
        </div>
    </div>

    <!-- Estado no autorizado -->
    <div id="authState" class="hidden">
        <div class="text-center py-8">
            <svg class="mx-auto h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.1 0-2 .9-2 2h4a2 2 0 00-2-2zM6 12h12M6 16h12" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No autorizado</h3>
            <p class="mt-1 text-sm text-gray-500">Inicia sesión como trabajador para ver los mensajes.</p>
            <a href="/login?tipo=trabajador" class="mt-3 inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ir a Login</a>
        </div>
    </div>

    <!-- Tabla de mensajes -->
    <div id="tableContainer" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asunto</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaMensajes" class="bg-white divide-y divide-gray-200">
                <!-- Los mensajes se cargarán aquí dinámicamente -->
            </tbody>
        </table>
        <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t border-gray-200">
            <div class="text-sm text-gray-600">
                Mostrando <span id="mensDesde">0</span>–<span id="mensHasta">0</span> de <span id="mensTotal">0</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="mensPrev" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Anterior</button>
                <button id="mensNext" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Siguiente</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver mensaje -->
    <div id="modalMensaje" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3">
                <h3 id="modalTitle" class="text-xl font-semibold">Detalles del Mensaje</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="mt-4">
                <!-- El contenido del mensaje se cargará aquí -->
            </div>
            <div class="flex justify-end mt-4">
                <button id="closeModalBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar mensaje -->
    <div id="modalEliminarMensaje" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4 py-8" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <div class="relative z-10 bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Eliminar mensaje
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    ¿Estás seguro de que quieres eliminar este mensaje? Esta acción no se puede deshacer.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button id="btnConfirmarEliminarMensaje" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Eliminar
                    </button>
                    <button id="btnCancelarEliminarMensaje" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</AdminLayout>

<script type="module">
function buildUrl(endpoint){const base=(window.API_BASE||'/api');if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function updateData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function deleteData(endpoint){const r=await fetchWithAuth(endpoint,{method:'DELETE',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}

// Variables globales
let mensajes = [];
let token = '';
let mensPagina = 1;
const mensTam = 20;

// Variables para el modal de eliminación
let mensajeAEliminar = null;

// Elementos del DOM
let loadingState, emptyState, tableContainer, tablaMensajes;

// Inicialización cuando se carga el DOM
document.addEventListener('DOMContentLoaded', function() {
    // Obtener elementos del DOM
    tablaMensajes = document.getElementById('tablaMensajes');
    loadingState = document.getElementById('loadingState');
    emptyState = document.getElementById('emptyState');
    tableContainer = document.getElementById('tableContainer');
    
    // Obtener token de autenticación (compatibilidad con login de trabajador en sessionStorage)
    try {
        token = sessionStorage.getItem('token') || localStorage.getItem('token') || '';
    } catch {}
    // No redirigir automáticamente: los endpoints están protegidos y fetchWithAuth añadirá Authorization si hay token
    
    // Configurar event listeners para el modal de ver mensaje
    const closeModal = document.getElementById('closeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalMensaje = document.getElementById('modalMensaje');
    
    if (closeModal) {
        closeModal.addEventListener('click', cerrarModalYMarcarLeido);
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', cerrarModalYMarcarLeido);
    }
    
    if (modalMensaje) {
        modalMensaje.addEventListener('click', function(e) {
            if (e.target === modalMensaje) {
                cerrarModalYMarcarLeido();
            }
        });
    }
    
    // Configurar event listeners para el modal de eliminar mensaje
    const btnConfirmarEliminarMensaje = document.getElementById('btnConfirmarEliminarMensaje');
    const btnCancelarEliminarMensaje = document.getElementById('btnCancelarEliminarMensaje');
    
    if (btnConfirmarEliminarMensaje) {
        btnConfirmarEliminarMensaje.addEventListener('click', confirmarEliminacionMensaje);
    }
    
    if (btnCancelarEliminarMensaje) {
        btnCancelarEliminarMensaje.addEventListener('click', cerrarModalEliminarMensaje);
    }
    
    // Controles de paginación
    const prevBtn = document.getElementById('mensPrev');
    const nextBtn = document.getElementById('mensNext');
    if (prevBtn) prevBtn.addEventListener('click', () => { if (mensPagina > 1) { mensPagina--; cargarMensajes(); } });
    if (nextBtn) nextBtn.addEventListener('click', () => {
        const maxPagina = Math.ceil(mensajes.length / mensTam) || 1;
        if (mensPagina < maxPagina) { mensPagina++; cargarMensajes(); }
    });

    // Cargar mensajes
    obtenerMensajes();
});

// Función para cerrar modal y marcar como leído
function cerrarModalYMarcarLeido() {
    const modal = document.getElementById('modalMensaje');
    const mensajeId = modal.dataset.mensajeId;
    
    console.log('Cerrando modal, mensaje ID:', mensajeId); // Debug
    
    if (mensajeId) {
        const mensaje = mensajes.find(m => m.id == mensajeId);
        console.log('Mensaje encontrado:', mensaje); // Debug
        if (mensaje && !mensaje.leido) {
            console.log('Marcando como leído...'); // Debug
            marcarComoLeido(mensajeId);
        }
    }
    
    modal.classList.add('hidden');
    modal.dataset.mensajeId = ''; // Limpiar el ID
}

// Obtener mensajes del servidor
async function obtenerMensajes() {
    try {
        // Mostrar estado de carga
        mostrarEstado('loading');
        
        mensajes = await getData('/api/mensajes');
            console.log('Mensajes obtenidos:', mensajes);
            cargarMensajes();
    } catch (error) {
        console.error('Error de conexión:', error);
        const msg = String(error && error.message || '');
        if (/Error\s+401/.test(msg) || /Error\s+403/.test(msg)) {
            mostrarEstado('auth');
            return;
        }
        mostrarEstado('empty');
    }
}

// Mostrar diferentes estados de la interfaz
function mostrarEstado(estado) {
    // Ocultar todos los estados
    if (loadingState) loadingState.classList.add('hidden');
    if (emptyState) emptyState.classList.add('hidden');
    if (tableContainer) tableContainer.classList.add('hidden');
    const auth = document.getElementById('authState');
    if (auth) auth.classList.add('hidden');
    
    // Mostrar el estado correspondiente
    switch (estado) {
        case 'loading':
            if (loadingState) loadingState.classList.remove('hidden');
            break;
        case 'empty':
            if (emptyState) emptyState.classList.remove('hidden');
            break;
        case 'table':
            if (tableContainer) tableContainer.classList.remove('hidden');
            break;
        case 'auth':
            if (auth) auth.classList.remove('hidden');
            break;
    }
}

// Cargar mensajes en la tabla
function cargarMensajes() {
    if (!tablaMensajes) {
        console.error('Elemento tablaMensajes no encontrado');
        return;
    }

    if (mensajes.length === 0) {
        mostrarEstado('empty');
        return;
    }

    // Mostrar la tabla con datos
    mostrarEstado('table');
    
    const total = mensajes.length;
    const desdeIdx = (mensPagina - 1) * mensTam;
    const hastaIdx = Math.min(desdeIdx + mensTam, total);
    const pagina = mensajes.slice(desdeIdx, hastaIdx);
    tablaMensajes.innerHTML = pagina.map(mensaje => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${new Date(mensaje.fecha_envio).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mensaje.nombre}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mensaje.email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${mensaje.asunto}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${mensaje.leido ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                    ${mensaje.leido ? 'Leído' : 'No leído'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="verMensaje(${mensaje.id})" 
                        class="text-indigo-600 hover:text-indigo-900 mr-3">
                    Ver
                </button>
                <button onclick="eliminarMensaje(${mensaje.id})" 
                        class="text-red-600 hover:text-red-900">
                    Eliminar
                </button>
            </td>
        </tr>
    `).join('');

    const desdeEl = document.getElementById('mensDesde');
    const hastaEl = document.getElementById('mensHasta');
    const totalEl = document.getElementById('mensTotal');
    if (desdeEl) desdeEl.textContent = total > 0 ? (desdeIdx + (pagina.length ? 1 : 0)) : 0;
    if (hastaEl) hastaEl.textContent = total > 0 ? hastaIdx : 0;
    if (totalEl) totalEl.textContent = total;
    const prevBtn2 = document.getElementById('mensPrev');
    const nextBtn2 = document.getElementById('mensNext');
    const hasPrev = mensPagina > 1;
    const hasNext = hastaIdx < total;
    if (prevBtn2) {
        prevBtn2.disabled = !hasPrev;
        prevBtn2.classList.toggle('opacity-50', !hasPrev);
        prevBtn2.classList.toggle('cursor-not-allowed', !hasPrev);
    }
    if (nextBtn2) {
        nextBtn2.disabled = !hasNext;
        nextBtn2.classList.toggle('opacity-50', !hasNext);
        nextBtn2.classList.toggle('cursor-not-allowed', !hasNext);
    }
}

// Ver mensaje completo
window.verMensaje = function(id) {
    console.log('Ver mensaje ID:', id); // Debug
    console.log('Mensajes disponibles:', mensajes); // Debug
    
    const mensaje = mensajes.find(m => m.id == id);
    console.log('Mensaje encontrado:', mensaje); // Debug
    
    if (mensaje) {
        // Actualizar el contenido del modal
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        
        modalTitle.textContent = `Mensaje de ${mensaje.nombre}`;
        
        modalContent.innerHTML = `
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre:</label>
                        <p class="text-gray-900">${mensaje.nombre}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                        <p class="text-gray-900">${mensaje.email}</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Asunto:</label>
                    <p class="text-gray-900 font-medium">${mensaje.asunto}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha:</label>
                    <p class="text-gray-900">${new Date(mensaje.fecha_envio).toLocaleString()}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje:</label>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <p class="text-gray-900 whitespace-pre-wrap">${mensaje.mensaje}</p>
                    </div>
                </div>
            </div>
        `;
        
        // Mostrar el modal
        const modal = document.getElementById('modalMensaje');
        modal.classList.remove('hidden');
        
        // Guardar el ID del mensaje actual para marcarlo como leído al cerrar
        modal.dataset.mensajeId = id;
    }
}

// Marcar mensaje como leído
async function marcarComoLeido(id) {
    console.log('Ejecutando marcarComoLeido con ID:', id); // Debug
    try {
        await updateData(`/api/mensajes/${id}/marcar-leido`, {});
        console.log('Mensaje marcado como leído, recargando tabla...'); // Debug
        obtenerMensajes(); // Recargar mensajes
    } catch (error) {
        console.error('Error al marcar como leído:', error);
    }
}

// Función para eliminar mensaje con confirmación
window.eliminarMensaje = function(id) {
    console.log('Preparando eliminación del mensaje con ID:', id);
    mensajeAEliminar = id;
    
    // Mostrar modal de confirmación
    const modalEliminarMensaje = document.getElementById('modalEliminarMensaje');
    if (modalEliminarMensaje) {
        modalEliminarMensaje.classList.remove('hidden');
    }
}

// Función para confirmar la eliminación
async function confirmarEliminacionMensaje() {
    if (!mensajeAEliminar) {
        console.error('No hay mensaje seleccionado para eliminar');
        return;
    }
    
    console.log('Confirmando eliminación del mensaje:', mensajeAEliminar);
    
    try {
        await deleteData(`/api/mensajes/${mensajeAEliminar}`);
        console.log('Mensaje eliminado exitosamente');
        // Cerrar modal
        cerrarModalEliminarMensaje();
        // Recargar mensajes
        obtenerMensajes();
    } catch (error) {
        console.error('Error en la petición:', error);
        alert('Error de conexión al eliminar el mensaje');
    }
}

// Función para cerrar el modal de eliminación
function cerrarModalEliminarMensaje() {
    const modalEliminarMensaje = document.getElementById('modalEliminarMensaje');
    if (modalEliminarMensaje) {
        modalEliminarMensaje.classList.add('hidden');
    }
    mensajeAEliminar = null;
}

</script>
