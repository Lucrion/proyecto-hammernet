---
import AdminLayout from '../../layouts/AdminLayout.astro';
import dashboardScriptUrl from '../../scripts/admin/dashboard.js?url';
---

<AdminLayout title="Panel de Administración">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Tarjeta de estadísticas: Productos -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">Productos</h3>
                <span class="p-2 bg-blue-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                </span>
            </div>
            <p class="text-3xl font-bold text-gray-800"><span id="dashboardProductosTotal">0</span></p>
            <p class="text-sm text-gray-500 mt-2">Total de productos</p>
            <div class="mt-3 text-sm text-gray-600">
                <p>Bajo stock: <span id="dashboardProductosBajo">0</span></p>
                <p>Sin stock: <span id="dashboardProductosSin">0</span></p>
            </div>
        </div>

        <!-- Tarjeta de estadísticas: Usuarios -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">Usuarios</h3>
                <span class="p-2 bg-green-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </span>
            </div>
            <p class="text-3xl font-bold text-gray-800"><span id="dashboardUsuariosActivos">0</span></p>
            <p class="text-sm text-gray-500 mt-2">Usuarios activos</p>
            <div class="mt-3 text-sm text-gray-600">
                <p>Desactivados: <span id="dashboardUsuariosInactivos">0</span></p>
                <p>Total: <span id="dashboardUsuariosTotal">0</span></p>
            </div>
        </div>

        <!-- Tarjeta de estadísticas: Ventas -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">Ventas</h3>
                <span class="p-2 bg-purple-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </span>
            </div>
            <div class="space-y-2">
                <p class="text-xl font-bold text-gray-800">Ingresos: <span id="dashboardVentasIngresos">$0</span></p>
                <p class="text-sm text-gray-600">Cantidad de ventas: <span id="dashboardVentasCantidad">0</span></p>
                <p class="text-sm text-gray-600">Promedio por venta: <span id="dashboardVentasPromedio">$0</span></p>
                <p class="text-sm text-gray-600">Canceladas: <span id="dashboardVentasCanceladas">0</span></p>
            </div>
        </div>
    </div>

    <!-- Accesos rápidos -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-6">Accesos rápidos</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/admin/catalogo" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <span class="text-gray-700">Añadir producto</span>
            </a>
            <a href="/admin/usuarios" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                <span class="text-gray-700">Añadir usuario</span>
            </a>
            <a href="/admin/catalogo" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span class="text-gray-700">Editar catálogo</span>
            </a>
            <!-- Acceso a reportes oculto temporalmente
            <a href="/admin/ventas" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="text-gray-700">Ver reportes</span>
            </a>
            -->
        </div>
    </div>

    <!-- Actividad reciente -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-6">Actividad reciente</h2>
        <div id="actividadReciente" class="space-y-4"></div>
    </div>

    <!-- Dashboard analítico -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8">
        <h2 class="text-xl font-semibold mb-6">Dashboard analítico</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-3">Ventas por día</h3>
                <canvas id="chartVentasDia" height="120"></canvas>
            </div>
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-3">Top productos</h3>
                <canvas id="chartTopProductos" height="120"></canvas>
            </div>
        </div>
    </div>
</AdminLayout>

<script>
// Verificar si el usuario está autenticado
document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');
    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
    
    console.log('Admin Index - Estado de autenticación:', isLoggedIn);
    console.log('Admin Index - Token:', token ? 'Token presente' : 'Token ausente');
    
    // Validación de autenticación reactivada
    if (!isLoggedIn || isLoggedIn !== 'true' || !token) {
        console.warn('Usuario no autenticado o token ausente, redirigiendo al login');
        // Redirigir al login si no está autenticado o no tiene token
        window.location.href = '/login';
    }
});
</script>

<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script type="module" src={dashboardScriptUrl}></script>