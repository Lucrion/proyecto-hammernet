---
import AdminLayout from '../../layouts/AdminLayout.astro';
---

<AdminLayout title="Panel de Administración">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Tarjeta de estadísticas: Productos -->
        <div class="bg-white rounded-lg shadow-md p-6 role-section-admin-only">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">Productos</h3>
                <span class="p-2 bg-blue-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                </span>
            </div>
            <p class="text-3xl font-bold text-gray-800"><span id="dashboardProductosTotal">0</span></p>
            <p class="text-sm text-gray-500 mt-2">Total de productos</p>
            <div class="mt-3 text-sm text-gray-600">
                <p>Bajo stock: <span id="dashboardProductosBajo">0</span></p>
                <p>Sin stock: <span id="dashboardProductosSin">0</span></p>
                <p>En oferta: <span id="dashboardProductosEnOfertaPct">0%</span></p>
            </div>
        </div>


        <!-- Tarjeta de estadísticas: Ventas -->
        <div class="bg-white rounded-lg shadow-md p-6 role-section-admin-only">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-700">Ventas</h3>
                <span class="p-2 bg-purple-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </span>
            </div>
            <div class="space-y-2">
                <p class="text-xl font-bold text-gray-800">Ingresos: <span id="dashboardVentasIngresos">$0</span></p>
                <p class="text-sm text-gray-600">Cantidad de ventas: <span id="dashboardVentasCantidad">0</span></p>
                <p class="text-sm text-gray-600">Promedio por venta: <span id="dashboardVentasPromedio">$0</span></p>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="p-3 rounded-lg bg-indigo-50 ring-1 ring-indigo-100">
                    <div class="text-xs text-indigo-700">Hoy</div>
                    <div class="mt-1 text-sm text-gray-700">Ingresos: <span id="metricVentasDiaIngresos">$0</span></div>
                    <div class="text-xs text-gray-600">Ventas: <span id="metricVentasDiaCantidad">0</span></div>
                </div>
                <div class="p-3 rounded-lg bg-blue-50 ring-1 ring-blue-100">
                    <div class="text-xs text-blue-700">Semana</div>
                    <div class="mt-1 text-sm text-gray-700">Ingresos: <span id="metricVentasSemanaIngresos">$0</span></div>
                    <div class="text-xs text-gray-600">Ventas: <span id="metricVentasSemanaCantidad">0</span></div>
                </div>
                <div class="p-3 rounded-lg bg-purple-50 ring-1 ring-purple-100">
                    <div class="text-xs text-purple-700">Mes</div>
                    <div class="mt-1 text-sm text-gray-700">Ingresos: <span id="metricVentasMesIngresos">$0</span></div>
                    <div class="text-xs text-gray-600">Ventas: <span id="metricVentasMesCantidad">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accesos rápidos -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 role-section-admin-bodeguero-only">
        <h2 class="text-xl font-semibold mb-6">Accesos rápidos</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/admin/catalogo" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors role-section-admin-bodeguero-only">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <span class="text-gray-700">Añadir producto</span>
            </a>
            <a href="/admin/usuarios" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors role-section-admin-only">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
                <span class="text-gray-700">Añadir trabajador</span>
            </a>
            <a href="/admin/catalogo" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors role-section-admin-bodeguero-only">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span class="text-gray-700">Editar catálogo</span>
            </a>
            <a href="/admin/ventas" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors role-section-admin-only">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="text-gray-700">Ver ventas</span>
            </a>
            <!-- Acceso a reportes oculto temporalmente
            <a href="/admin/ventas" class="flex flex-col items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="text-gray-700">Ver reportes</span>
            </a>
            -->
        </div>
    </div>

    

    <!-- Últimas ventas -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-8 role-section-admin-vendedor-only">
        <h2 class="text-xl font-semibold mb-6">Últimas ventas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Envío</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    </tr>
                </thead>
                <tbody id="ultimasVentasBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-8">
        <!-- Apartado: Ventas -->
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 role-section-admin-only">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="p-2 rounded-lg bg-indigo-50 text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6m6 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2"/></svg>
                    </span>
                    <h2 class="text-lg font-semibold text-gray-900">Ventas</h2>
                </div>
            <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                    <button id="ventasTfDia" class="px-3 py-1 rounded-full bg-indigo-600 text-white text-sm">Día</button>
                    <button id="ventasTfSem" class="px-3 py-1 rounded-full bg-white text-gray-800 text-sm">Semana</button>
                    <button id="ventasTfMes" class="px-3 py-1 rounded-full bg-white text-gray-800 text-sm">Mes</button>
            </div>
        </div>
            <div class="mb-3 flex items-center gap-2">
                <span class="text-sm text-gray-600">Ventas por día</span>
            </div>
            <div id="apartadoChartVentasPorDia" class="rounded-lg bg-gray-50 mb-6" style="height: 320px; width: 100%"></div>
            <div class="mb-3 flex items-center gap-2">
                <span class="text-sm text-gray-600">Top 10 productos más vendidos</span>
            </div>
            <div id="apartadoChartVentasTopProductos" class="rounded-lg bg-gray-50 mb-6" style="height: 320px; width: 100%"></div>
            <div class="mb-3 flex items-center gap-2">
                <span class="text-sm text-gray-600">Ingresos por categoría</span>
            </div>
            <div id="apartadoChartVentasIngresosCategoria" class="rounded-lg bg-gray-50" style="height: 320px; width: 100%"></div>
        </div>

        <!-- Apartado: Clientes -->
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 role-section-admin-only">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="p-2 rounded-lg bg-green-50 text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 14a4 4 0 00-8 0m8 0v1a4 4 0 01-8 0v-1m8 0a4 4 0 00-8 0"/></svg>
                    </span>
                    <h2 class="text-lg font-semibold text-gray-900">Clientes</h2>
                </div>
                <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                    <button id="clientesModeTop" class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Destacados</button>
                    <button id="clientesModeBottom" class="px-3 py-1 rounded-full bg-white text-gray-800 text-sm">Últimos</button>
                </div>
            </div>
            <div id="apartadoChartClientes" class="rounded-lg bg-gray-50" style="height: 320px; width: 100%"></div>
        </div>

        <!-- Apartado: Inventario -->
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 role-section-admin-bodeguero-only">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="p-2 rounded-lg bg-purple-50 text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V7a2 2 0 00-2-2h-4l-2-2H6a2 2 0 00-2 2v6"/></svg>
                    </span>
                    <h2 class="text-lg font-semibold text-gray-900">Inventario</h2>
                </div>
                <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                    <button id="inventarioModeTop" class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Destacados</button>
                    <button id="inventarioModeBottom" class="px-3 py-1 rounded-full bg-white text-gray-800 text-sm">Últimos</button>
                </div>
            </div>
            <div id="apartadoChartInventario" class="rounded-lg bg-gray-50" style="height: 320px; width: 100%"></div>
        </div>

        <!-- Apartado: Envíos -->
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 role-section-admin-vendedor-only">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="p-2 rounded-lg bg-yellow-50 text-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18M3 7h18M5 11h14M7 15h10M9 19h6"/></svg>
                    </span>
                    <h2 class="text-lg font-semibold text-gray-900">Envíos</h2>
                </div>
                
            </div>
            <div id="apartadoChartEnvios" class="rounded-lg bg-gray-50" style="height: 320px; width: 100%"></div>
        </div>

        <!-- Apartado: Pagos -->
        <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 role-section-admin-only">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="p-2 rounded-lg bg-red-50 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.1 0-2 .9-2 2h4a2 2 0 00-2-2zM6 12h12M6 16h12"/></svg>
                    </span>
                    <h2 class="text-lg font-semibold text-gray-900">Pagos</h2>
                </div>
                <div class="flex items-center gap-2 bg-gray-100 rounded-full p-1">
                    <button id="pagosModeTop" class="px-3 py-1 rounded-full bg-green-600 text-white text-sm">Destacados</button>
                    <button id="pagosModeBottom" class="px-3 py-1 rounded-full bg-white text-gray-800 text-sm">Últimos</button>
                </div>
            </div>
            <div id="apartadoChartPagos" class="rounded-lg bg-gray-50" style="height: 320px; width: 100%"></div>
        </div>
    </div>

    <!-- Actividad de clientes -->
    <div id="sectionRendimiento" class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 mt-8 role-section-admin-only">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Actividad de clientes</h2>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="p-4 rounded-lg bg-blue-50 ring-1 ring-blue-100">
                <div class="text-sm text-blue-700">Carritos abandonados</div>
                <div id="metricCarritosAbandonados" class="mt-2 text-2xl font-bold text-blue-900">0</div>
            </div>
            <div class="p-4 rounded-lg bg-emerald-50 ring-1 ring-emerald-100">
                <div class="text-sm text-emerald-700">Clientes registrados este mes</div>
                <div id="metricClientesMes" class="mt-2 text-2xl font-bold text-emerald-900">0</div>
            </div>
        </div>
    </div>

    <!-- Inventario -->
    <div class="bg-white rounded-xl shadow-sm ring-1 ring-gray-200 p-6 mt-8 role-section-admin-bodeguero-only">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Inventario</h2>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="p-4 rounded-lg bg-indigo-50 ring-1 ring-indigo-100">
                <div class="text-sm text-indigo-700">Stock actual total</div>
                <div id="metricStockTotal" class="mt-2 text-2xl font-bold text-indigo-900">0</div>
            </div>
            <div class="p-4 rounded-lg bg-rose-50 ring-1 ring-rose-100">
                <div class="text-sm text-rose-700">Productos agotados</div>
                <div id="metricAgotados" class="mt-2 text-2xl font-bold text-rose-900">0</div>
            </div>
            <div class="p-4 rounded-lg bg-purple-50 ring-1 ring-purple-100">
                <div class="text-sm text-purple-700">Valor total del inventario</div>
                <div id="metricValorInventario" class="mt-2 text-2xl font-bold text-purple-900">$0</div>
            </div>
        </div>
    </div>

    

    
</AdminLayout>

<script>
// Verificar si el usuario está autenticado
document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');
    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
    
    console.log('Admin Index - Estado de autenticación:', isLoggedIn);
    console.log('Admin Index - Token:', token ? 'Token presente' : 'Token ausente');
    
    // VALIDACIÓN TEMPORALMENTE DESACTIVADA: No redirigir por falta de token
    // if (!isLoggedIn || isLoggedIn !== 'true' || !token) {
    //     console.warn('Usuario no autenticado o token ausente, redirigiendo al login');
    //     window.location.href = '/login';
    // }
});
</script>

<script type="module">
function buildUrl(endpoint){const base=(window.API_BASE||'/api');if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}

function formatCurrency(value) {
  try { return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(value || 0); }
  catch { return `$${(value || 0).toFixed(0)}`; }
}
function formatDate(value) { try { const d = new Date(value); return d.toLocaleString('es-CL'); } catch { return String(value); } }
function parseEnvioEstado(venta) { try { if (venta.estado_envio) return String(venta.estado_envio).toLowerCase(); const obs = String(venta.observaciones || ''); const tag = 'ENVIO_ESTADO:'; const idx = obs.indexOf(tag); if (idx >= 0) { const rest = obs.slice(idx + tag.length).trim(); const linea = rest.split('\n')[0].trim(); const val = linea.toLowerCase(); if (['pendiente','preparando','asignado','en camino','entregado','fallido'].includes(val)) return val; } return ''; } catch { return ''; } }
function envioBadge(v) { const s = String(v || '').toLowerCase().replace('_',' '); let bg = '#e5e7eb', fg = '#374151'; if (s === 'pendiente') { bg='#e5e7eb'; fg='#374151'; } else if (s === 'preparando') { bg='#fef9c3'; fg='#92400e'; } else if (s === 'asignado') { bg='#dbeafe'; fg='#1e40af'; } else if (s === 'en camino' || s === 'en_camino' || s === 'despachado') { bg='#e0e7ff'; fg='#3730a3'; } else if (s === 'entregado') { bg='#dcfce7'; fg='#166534'; } else if (s === 'fallido') { bg='#fee2e2'; fg='#991b1b'; } const label = s || '—'; return `<span style="background:${bg};color:${fg};padding:4px 10px;border-radius:9999px;font-size:0.75rem;font-weight:600">${label}</span>`; }
function renderActividadItem(evt) {
  const iconColor = 'text-blue-600'; const bgColor = 'bg-blue-100'; const entidad = evt.entidad_tipo || 'Evento'; const detalle = evt.detalle || ''; const fecha = formatDate(evt.fecha_evento); const titulo = `${entidad}: ${evt.accion || ''}`;
  return `
    <div class="flex items-start">
      <div class="${bgColor} p-2 rounded-full mr-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
      </div>
      <div>
        <p class="text-gray-800">${titulo}${detalle ? ` — <span class="font-medium">${detalle}</span>` : ''}</p>
        <p class="text-sm text-gray-500">${fecha}</p>
      </div>
    </div>`;
}

async function cargarDashboard() {
  try {
    let metrics = await getData('/api/dashboard/metrics');
    const productosTotal = metrics?.productos?.total_productos ?? 0;
    const productosBajo = metrics?.productos?.productos_bajo_stock ?? 0;
    const productosSin = metrics?.productos?.productos_sin_stock ?? 0;
    document.getElementById('dashboardProductosTotal')?.replaceChildren(document.createTextNode(String(productosTotal)));
    document.getElementById('dashboardProductosBajo')?.replaceChildren(document.createTextNode(String(productosBajo)));
    document.getElementById('dashboardProductosSin')?.replaceChildren(document.createTextNode(String(productosSin)));
    const usuariosActivos = metrics?.usuarios?.activos ?? 0;
    const usuariosInactivos = metrics?.usuarios?.inactivos ?? 0;
    const usuariosTotal = metrics?.usuarios?.total ?? 0;
    document.getElementById('dashboardUsuariosActivos')?.replaceChildren(document.createTextNode(String(usuariosActivos)));
    document.getElementById('dashboardUsuariosInactivos')?.replaceChildren(document.createTextNode(String(usuariosInactivos)));
    document.getElementById('dashboardUsuariosTotal')?.replaceChildren(document.createTextNode(String(usuariosTotal)));
    const ingresos = metrics?.ventas?.total_ventas ?? 0;
    const cantVentas = metrics?.ventas?.cantidad_ventas ?? 0;
    const promedio = metrics?.ventas?.promedio_venta ?? 0;
    const canceladas = metrics?.ventas?.ventas_canceladas ?? 0;
    document.getElementById('dashboardVentasIngresos')?.replaceChildren(document.createTextNode(formatCurrency(ingresos)));
    document.getElementById('dashboardVentasCantidad')?.replaceChildren(document.createTextNode(String(cantVentas)));
    document.getElementById('dashboardVentasPromedio')?.replaceChildren(document.createTextNode(formatCurrency(promedio)));
    document.getElementById('dashboardVentasCanceladas')?.replaceChildren(document.createTextNode(String(canceladas)));
    const vp = metrics?.ventas_periodos || {};
    const diaIng = vp?.dia?.ingresos ?? 0; const diaCant = vp?.dia?.cantidad ?? 0;
    const semIng = vp?.semana?.ingresos ?? 0; const semCant = vp?.semana?.cantidad ?? 0;
    const mesIng = vp?.mes?.ingresos ?? 0; const mesCant = vp?.mes?.cantidad ?? 0;
    document.getElementById('metricVentasDiaIngresos')?.replaceChildren(document.createTextNode(formatCurrency(diaIng)));
    document.getElementById('metricVentasDiaCantidad')?.replaceChildren(document.createTextNode(String(diaCant)));
    document.getElementById('metricVentasSemanaIngresos')?.replaceChildren(document.createTextNode(formatCurrency(semIng)));
    document.getElementById('metricVentasSemanaCantidad')?.replaceChildren(document.createTextNode(String(semCant)));
    document.getElementById('metricVentasMesIngresos')?.replaceChildren(document.createTextNode(formatCurrency(mesIng)));
    document.getElementById('metricVentasMesCantidad')?.replaceChildren(document.createTextNode(String(mesCant)));
    const needFallback = Number(ingresos||0) === 0 && Number(cantVentas||0) === 0;
    if (needFallback) {
      try {
        const ventas = await getData('/api/ventas?limit=500');
        const arr = Array.isArray(ventas) ? ventas : [];
        const done = arr.filter(v=> String(v.estado||'').toLowerCase() !== 'cancelada');
        const total = done.reduce((acc,v)=> acc + Number(v.total_venta||0), 0);
        const cantidad = done.length;
        const promedioCalc = cantidad ? (total / cantidad) : 0;
        document.getElementById('dashboardVentasIngresos')?.replaceChildren(document.createTextNode(formatCurrency(total)));
        document.getElementById('dashboardVentasCantidad')?.replaceChildren(document.createTextNode(String(cantidad)));
        document.getElementById('dashboardVentasPromedio')?.replaceChildren(document.createTextNode(formatCurrency(promedioCalc)));
        const now = new Date();
        const isSameDay = (d)=> { const x=new Date(d); return x.getFullYear()===now.getFullYear() && x.getMonth()===now.getMonth() && x.getDate()===now.getDate(); };
        const startWeek = new Date(now); startWeek.setDate(now.getDate()-6); startWeek.setHours(0,0,0,0);
        const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const sumPeriodo = (from)=> done.filter(v=> { const d=new Date(v.fecha_venta||v.created_at||0); return d>=from && d<=now; }).reduce((acc,v)=> acc + Number(v.total_venta||0), 0);
        const cntPeriodo = (from)=> done.filter(v=> { const d=new Date(v.fecha_venta||v.created_at||0); return d>=from && d<=now; }).length;
        const diaIngF = done.filter(v=> isSameDay(v.fecha_venta||v.created_at||0)).reduce((a,b)=> a + Number(b.total_venta||0), 0);
        const diaCntF = done.filter(v=> isSameDay(v.fecha_venta||v.created_at||0)).length;
        const semIngF = sumPeriodo(startWeek);
        const semCntF = cntPeriodo(startWeek);
        const mesIngF = sumPeriodo(startMonth);
        const mesCntF = cntPeriodo(startMonth);
        document.getElementById('metricVentasDiaIngresos')?.replaceChildren(document.createTextNode(formatCurrency(diaIngF)));
        document.getElementById('metricVentasDiaCantidad')?.replaceChildren(document.createTextNode(String(diaCntF)));
        document.getElementById('metricVentasSemanaIngresos')?.replaceChildren(document.createTextNode(formatCurrency(semIngF)));
        document.getElementById('metricVentasSemanaCantidad')?.replaceChildren(document.createTextNode(String(semCntF)));
        document.getElementById('metricVentasMesIngresos')?.replaceChildren(document.createTextNode(formatCurrency(mesIngF)));
        document.getElementById('metricVentasMesCantidad')?.replaceChildren(document.createTextNode(String(mesCntF)));
      } catch {}
    }
    try {
      const inventarioValor = metrics?.productos?.valor_inventario_total ?? 0;
      const ofertaPct = metrics?.productos?.porcentaje_en_oferta ?? 0;
      document.getElementById('dashboardValorInventarioTotal')?.replaceChildren(document.createTextNode(formatCurrency(inventarioValor)));
      document.getElementById('dashboardProductosEnOfertaPct')?.replaceChildren(document.createTextNode(String(Math.round(ofertaPct)) + '%'));
    } catch {}
    const contenedorActividad = document.getElementById('actividadReciente');
    if (contenedorActividad) {
      const eventos = metrics?.actividad_reciente ?? [];
      if (eventos.length === 0) { contenedorActividad.innerHTML = '<p class="text-sm text-gray-500">Sin actividad reciente</p>'; }
      else { contenedorActividad.innerHTML = eventos.map(renderActividadItem).join(''); }
    }
  } catch (error) { console.error('Error al cargar dashboard:', error); }
}

document.addEventListener('DOMContentLoaded', () => {
  try { cargarDashboard(); cargarUltimasVentas(); initApartadosAnalytics(); setupResizeRedraw(); } catch (e) { console.warn('Dashboard no pudo inicializar completamente:', e); }
  try {
    window.addEventListener('storage', (e) => {
      try { if (String(e.key||'') === 'ventas_updated') { refreshDashboardCharts(); } } catch {}
    });
  } catch {}
});

async function ensureGoogleChartsReady() {
  return new Promise((resolve) => {
    try {
      if (window.google && window.google.visualization) { return resolve(); }
      if (!(window.google && window.google.charts)) {
        const script = document.createElement('script'); script.src = 'https://www.gstatic.com/charts/loader.js'; script.async = true; script.onload = () => { try { window.google.charts.load('current', { packages: ['corechart', 'bar'] }); window.google.charts.setOnLoadCallback(() => { resolve(); }); } catch (e) { resolve(); } }; document.head.appendChild(script);
      } else { window.google.charts.load('current', { packages: ['corechart', 'bar'] }); }
      let tries = 0; const maxTries = 20; const interval = setInterval(() => { tries++; if (window.google && window.google.visualization) { clearInterval(interval); resolve(); } else if (tries >= maxTries) { clearInterval(interval); resolve(); } }, 150);
      window.google.charts.setOnLoadCallback(() => { resolve(); });
    } catch (e) { resolve(); }
  });
}

async function cargarUltimasVentas() {
  try {
    let ventas = await getData('/api/ventas?limit=100');
    const cont = document.getElementById('ultimasVentasBody'); if (!cont) return;
    const arr = Array.isArray(ventas) ? ventas : [];
    if (arr.length === 0) { cont.innerHTML = '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">Sin ventas recientes</td></tr>'; return; }
    const map = (analyticsState?.data?.userNameMap) || null;
    const fmtPrecio = (v) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(Number(v||0));
    const fmtFecha = (iso) => { try { const d = new Date(iso || 0); return d.toLocaleDateString('es-CL', { year:'numeric', month:'2-digit', day:'2-digit' }); } catch { return String(iso); } };
    const sorted = [...arr].sort((a,b)=>{
      const ta = new Date(a.fecha_venta || a.created_at || 0).getTime();
      const tb = new Date(b.fecha_venta || b.created_at || 0).getTime();
      return tb - ta;
    }).slice(0,10);
    cont.innerHTML = sorted.map(v => `
      <tr>
        <td class="px-4 py-3 text-sm text-gray-800">#${v.id_venta}</td>
        <td class="px-4 py-3 text-sm text-gray-700">${fmtFecha(v.fecha_venta || v.created_at)}</td>
        <td class="px-4 py-3 text-sm">${resolveUserDisplay(v, map)}</td>
        <td class="px-4 py-3 text-sm font-semibold">${fmtPrecio(v.total_venta)}</td>
        <td class="px-4 py-3 text-sm">${envioBadge(parseEnvioEstado(v))}</td>
        <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded text-white ${String(v.estado||'').toLowerCase()==='completada' ? 'bg-green-600' : (String(v.estado||'').toLowerCase()==='cancelada' ? 'bg-red-600' : 'bg-yellow-500')}">${v.estado || 'pendiente'}</span></td>
      </tr>`).join('');
  } catch (e) { console.warn('No se pudieron cargar últimas ventas', e); }
}

const analyticsState = { section: 'ventas', mode: 'top', timeframe: 'dia', data: { ventasCat: [], inventarioCat: [], clientes: [], pedidos: [], pagos: [], ventasList: [] } };
const ANALYTICS_LIMIT = 10;
function sliceTop(arr, key) { const a = [...arr].sort((x,y)=>Number(y[key]||0)-Number(x[key]||0)); return a.slice(0,ANALYTICS_LIMIT); }
function sliceBottom(arr, key) { const a = [...arr].sort((x,y)=>Number(x[key]||0)-Number(y[key]||0)); return a.slice(0,ANALYTICS_LIMIT); }

async function loadAnalyticsData() {
  try { const ventasCat = await getData('/api/dashboard/charts/ventas_por_categoria'); analyticsState.data.ventasCat = Array.isArray(ventasCat) ? ventasCat.map(v=>({ label: String(v.categoria||`ID ${v.id_categoria}`), ingresos: Number(v.ingresos||0), cantidad: Number(v.cantidad||0) })) : []; } catch { analyticsState.data.ventasCat = []; }
  try { const invCat = await getData('/api/dashboard/charts/inventario_por_categoria'); analyticsState.data.inventarioCat = Array.isArray(invCat) ? invCat.map(v=>({ label: String(v.categoria||`ID ${v.id_categoria}`), valor: Number(v.valor||0), unidades: Number(v.unidades||0) })) : []; } catch { analyticsState.data.inventarioCat = []; }
  try { const topProd = await getData('/api/dashboard/charts/top_productos?limite=50'); analyticsState.data.topProductos = Array.isArray(topProd) ? topProd.map(p=>({ label: String(p.nombre||`ID ${p.id_producto}`), unidades: Number(p.unidades||0) })) : []; } catch { analyticsState.data.topProductos = []; }
  try { const ventas = await getData('/api/ventas?limit=500'); const arr = Array.isArray(ventas) ? ventas : []; analyticsState.data.ventasList = arr; const porUsuario = {}; const porEstado = {}; const porPago = []; const porEnvio = {}; arr.forEach(v=>{ const u = String(v.usuario||'Invitado'); porUsuario[u]=(porUsuario[u]||0)+1; const e = String(v.estado||'pendiente'); porEstado[e]=(porEstado[e]||0)+1; const env = (typeof parseEnvioEstado==='function'? (parseEnvioEstado(v) || v.estado_envio) : v.estado_envio) || 'pendiente'; const envKey = String(env).toLowerCase(); porEnvio[envKey]=(porEnvio[envKey]||0)+1; porPago.push({ label: `#${v.id_venta}`, monto: Number(v.total_venta||0) }); }); analyticsState.data.clientes = Object.entries(porUsuario).map(([label,valor])=>({ label, valor })); analyticsState.data.pedidos = Object.entries(porEstado).map(([label,valor])=>({ label, valor })); analyticsState.data.envios = Object.entries(porEnvio).map(([label,valor])=>({ label, valor })); analyticsState.data.pagos = porPago; } catch { analyticsState.data.clientes=[]; analyticsState.data.pedidos=[]; analyticsState.data.envios=[]; analyticsState.data.pagos=[]; }
  try { const visitas = await getData('/api/analytics/visitas?dias=30'); analyticsState.data.visitasMes = Array.isArray(visitas) ? visitas.map(v=>({ fecha: String(v.fecha), visitas: Number(v.visitas||0) })) : []; } catch { analyticsState.data.visitasMes = []; }
  try { const usuarios = await getData('/api/usuarios/'); analyticsState.data.clientesMes = Array.isArray(usuarios) ? usuarios.filter(u=>{ const d = new Date(u.fecha_creacion || u.created_at || u.fecha_registro || 0); const now = new Date(); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }).length : 0; } catch { analyticsState.data.clientesMes = 0; }
}

function drawSectionChart() {
  const s = analyticsState.section; const m = analyticsState.mode; const elId = s==='ventas'?'chartSectVentas':s==='clientes'?'chartSectClientes':s==='inventario'?'chartSectInventario':s==='pedidos'?'chartSectPedidos':'chartSectPagos'; const el = document.getElementById(elId); if (!el) return; const toDataTable = (cols, rows)=> window.google.visualization.arrayToDataTable([cols, ...rows]); let dt; let options={ legend:{position:'bottom'} };
  if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return;
  if (s==='ventas') { const rows = groupVentasByTime(analyticsState.timeframe); const sliced = m==='top'?sliceTop(rows,'valor'):sliceBottom(rows,'valor'); dt = toDataTable(['Tiempo','Ingresos'], sliced.map(r=>[r.label, r.valor])); new window.google.visualization.LineChart(el).draw(dt, options); }
  else if (s==='clientes') { const src = analyticsState.data.clientes || []; const sliced = m==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); dt = toDataTable(['Cliente','Ventas'], sliced.map(r=>[r.label, r.valor])); new window.google.visualization.BarChart(el).draw(dt, options); }
  else if (s==='inventario') { const src = analyticsState.data.inventarioCat || []; const sliced = m==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); dt = toDataTable(['Categoría','Valor'], sliced.map(r=>[r.label, r.valor])); new window.google.visualization.PieChart(el).draw(dt, { ...options, pieHole: 0.35 }); }
  else if (s==='pedidos') { const src = analyticsState.data.pedidos || []; const sliced = m==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); dt = toDataTable(['Estado','Cantidad'], sliced.map(r=>[r.label, r.valor])); new window.google.visualization.PieChart(el).draw(dt, { ...options, pieHole: 0.35 }); }
  else { const src = analyticsState.data.pagos || []; const sliced = m==='top'?sliceTop(src,'monto'):sliceBottom(src,'monto'); dt = toDataTable(['Venta','Monto'], sliced.map(r=>[r.label, r.monto])); new window.google.visualization.BarChart(el).draw(dt, options); }
}
function setSection(section) { analyticsState.section = section; const ids = ['chartSectVentas','chartSectClientes','chartSectInventario','chartSectPedidos','chartSectPagos']; ids.forEach(id=>{ const el = document.getElementById(id); if (!el) return; el.classList.toggle('hidden', id !== (section==='ventas'?ids[0]:section==='clientes'?ids[1]:section==='inventario'?ids[2]:section==='pedidos'?ids[3]:ids[4])); }); drawSectionChart(); }
function setMode(mode) { analyticsState.mode = mode; const topBtn = document.getElementById('tabModeTop'); const bottomBtn = document.getElementById('tabModeBottom'); if (topBtn && bottomBtn) { if (mode==='top') { topBtn.classList.add('bg-green-600','text-white'); topBtn.classList.remove('bg-gray-200','text-gray-800'); bottomBtn.classList.add('bg-gray-200','text-gray-800'); bottomBtn.classList.remove('bg-green-600','text-white'); } else { bottomBtn.classList.add('bg-green-600','text-white'); bottomBtn.classList.remove('bg-gray-200','text-gray-800'); topBtn.classList.add('bg-gray-200','text-gray-800'); topBtn.classList.remove('bg-green-600','text-white'); } } drawSectionChart(); }

async function initApartadosAnalytics() {
  await ensureGoogleChartsReady(); await loadAnalyticsData(); await buildUserMapAndRelabel();
  const vDia = document.getElementById('ventasTfDia'); const vSem = document.getElementById('ventasTfSem'); const vMes = document.getElementById('ventasTfMes');
  if (vDia && vSem && vMes) {
    try { vDia.textContent = 'Día'; vSem.textContent = 'Semana'; vMes.textContent = 'Mes'; } catch {}
    vDia.onclick = ()=>{ analyticsApartados.ventas.timeframe='dia'; toggleTimeButtons(vDia, vDia, vSem, vMes); drawApartadoVentasPorDia(); };
    vSem.onclick = ()=>{ analyticsApartados.ventas.timeframe='semana'; toggleTimeButtons(vSem, vDia, vSem, vMes); drawApartadoVentasPorDia(); };
    vMes.onclick = ()=>{ analyticsApartados.ventas.timeframe='mes'; toggleTimeButtons(vMes, vDia, vSem, vMes); drawApartadoVentasPorDia(); };
    toggleTimeButtons(vDia, vDia, vSem, vMes);
  }
  const cTop = document.getElementById('clientesModeTop'); const cBottom = document.getElementById('clientesModeBottom'); if (cTop) cTop.onclick = ()=>{ analyticsApartados.clientes.mode='top'; toggleModeButtons(cTop, cBottom); drawApartadoClientes(); }; if (cBottom) cBottom.onclick = ()=>{ analyticsApartados.clientes.mode='bottom'; toggleModeButtons(cTop, cBottom); drawApartadoClientes(); }; toggleModeButtons(cTop, cBottom);
  const iTop = document.getElementById('inventarioModeTop'); const iBottom = document.getElementById('inventarioModeBottom'); if (iTop) iTop.onclick = ()=>{ analyticsApartados.inventario.mode='top'; toggleModeButtons(iTop, iBottom); drawApartadoInventario(); }; if (iBottom) iBottom.onclick = ()=>{ analyticsApartados.inventario.mode='bottom'; toggleModeButtons(iTop, iBottom); drawApartadoInventario(); }; toggleModeButtons(iTop, iBottom);
  try { drawApartadoEnvios(); } catch {}
  const paTop = document.getElementById('pagosModeTop'); const paBottom = document.getElementById('pagosModeBottom'); if (paTop) paTop.onclick = ()=>{ analyticsApartados.pagos.mode='top'; toggleModeButtons(paTop, paBottom); drawApartadoPagos(); }; if (paBottom) paBottom.onclick = ()=>{ analyticsApartados.pagos.mode='bottom'; toggleModeButtons(paTop, paBottom); drawApartadoPagos(); }; toggleModeButtons(paTop, paBottom);
  drawApartadoVentasPorDia(); drawApartadoVentasTopProductos(); drawApartadoVentasIngresosCategoria(); drawApartadoClientes(); drawApartadoInventario(); drawApartadoEnvios(); drawApartadoPagos(); drawResumenMetrics();
  try { const visitasLen = Array.isArray(analyticsState.data.visitasMes) ? analyticsState.data.visitasMes.length : 0; const section = document.getElementById('sectionRendimiento'); if (section) { if (visitasLen < 2) { section.style.display = 'none'; } else { section.style.display = ''; drawVisitasMes(); } } } catch {}
}

const analyticsApartados = { ventas:{ timeframe:'dia', mode:'top' }, clientes:{ mode:'top' }, inventario:{ mode:'top' }, pedidos:{ mode:'top' }, envios:{ mode:'top' }, pagos:{ mode:'top' } };
function toggleModeButtons(btnTop, btnBottom) { if (!btnTop || !btnBottom) return; const topActive = btnTop === document.activeElement || btnTop.classList.contains('bg-green-600'); btnTop.classList.add('bg-green-600','text-white'); btnTop.classList.remove('bg-gray-200','text-gray-800'); btnBottom.classList.add('bg-gray-200','text-gray-800'); btnBottom.classList.remove('bg-green-600','text-white'); }
function toggleTimeButtons(active, bDia, bSem, bMes) {
  [bDia,bSem,bMes].forEach((b)=>{
    if (!b) return;
    b.classList.remove('bg-indigo-600','text-white','bg-white');
    b.classList.add('bg-gray-200','text-gray-800');
  });
  if (active) {
    active.classList.remove('bg-gray-200','text-gray-800','bg-white');
    active.classList.add('bg-indigo-600','text-white');
  }
}

function drawApartadoVentas() { const el = document.getElementById('apartadoChartVentas'); if (!el) return; const rows = groupVentasByTime(analyticsApartados.ventas.timeframe); const sliced = analyticsApartados.ventas.mode==='top'?sliceTop(rows,'valor'):sliceBottom(rows,'valor'); const dt = window.google.visualization.arrayToDataTable([['Tiempo','Ingresos'], ...sliced.map(r=>[r.label, r.valor])]); new window.google.visualization.AreaChart(el).draw(dt, baseChartOptions('#2563eb', true)); }
function drawApartadoClientes() { const el = document.getElementById('apartadoChartClientes'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.clientes || []; const sliced = analyticsApartados.clientes.mode==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); const dt = window.google.visualization.arrayToDataTable([['Cliente','Ventas'], ...sliced.map(r=>[r.label, r.valor])]); new window.google.visualization.BarChart(el).draw(dt, baseChartOptions('#16a34a', false)); }
function drawApartadoInventario() { const el = document.getElementById('apartadoChartInventario'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.inventarioCat || []; const sliced = analyticsApartados.inventario.mode==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); const dt = window.google.visualization.arrayToDataTable([['Categoría','Valor'], ...sliced.map(r=>[r.label, r.valor])]); const colors = makePalette(sliced.length); new window.google.visualization.PieChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, backgroundColor:'transparent', colors:colors, pieHole:0.35, sliceVisibilityThreshold: 0.02 }); }
function envioColorFor(label){ const s=String(label||'').toLowerCase(); if (s==='pendiente') return '#e5e7eb'; if (s==='preparando') return '#fef9c3'; if (s==='asignado') return '#dbeafe'; if (s==='en camino' || s==='en_camino' || s==='despachado') return '#e0e7ff'; if (s==='entregado') return '#dcfce7'; if (s==='fallido') return '#fee2e2'; return '#e5e7eb'; }
function drawApartadoEnvios() { const el = document.getElementById('apartadoChartEnvios'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.envios || []; const sliced = analyticsApartados.envios.mode==='top'?sliceTop(src,'valor'):sliceBottom(src,'valor'); const rows = (sliced && sliced.length) ? sliced.map(r=>[r.label, r.valor]) : [['Sin datos', 0]]; const colors = rows.map(r=>envioColorFor(r[0])); const dt = window.google.visualization.arrayToDataTable([['Envío','Cantidad'], ...rows]); new window.google.visualization.PieChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, backgroundColor:'transparent', colors:colors, pieHole:0.35, sliceVisibilityThreshold: 0.02 }); }
function drawApartadoPagos() { const el = document.getElementById('apartadoChartPagos'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.pagos || []; const sliced = analyticsApartados.pagos.mode==='top'?sliceTop(src,'monto'):sliceBottom(src,'monto'); const colors = makePalette(sliced.length); const dt = window.google.visualization.arrayToDataTable([['Venta','Monto',{role:'style'}], ...sliced.map((r,i)=>[r.label, r.monto, colors[i]])]); new window.google.visualization.BarChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, backgroundColor:'transparent', vAxis:{ textStyle:{ color:'#6b7280' }, gridlines:{ color:'#e5e7eb' }, format:'short' }, hAxis:{ textStyle:{ color:'#6b7280' }, gridlines:{ color:'#f3f4f6' } }, bar:{ groupWidth:'70%' } }); }
function drawApartadoVentasTopProductos() { const el = document.getElementById('apartadoChartVentasTopProductos'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.topProductos || []; const sliced = analyticsApartados.ventas.mode==='top'?sliceTop(src,'unidades'):sliceBottom(src,'unidades'); const rows = sliced.length ? sliced.map(r=>[r.label, r.unidades]) : [['Sin datos', 0]]; const colors = makePalette(rows.length); const dt = window.google.visualization.arrayToDataTable([['Producto','Unidades',{role:'style'}], ...rows.map((r,i)=>[r[0], r[1], colors[i]])]); new window.google.visualization.BarChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, backgroundColor:'transparent', hAxis:{ textStyle:{ color:'#6b7280' }, gridlines:{ color:'#f3f4f6' } }, vAxis:{ textStyle:{ color:'#6b7280' }, gridlines:{ color:'#e5e7eb' } }, bar:{ groupWidth:'70%' } }); }
function drawApartadoVentasIngresosCategoria() { const el = document.getElementById('apartadoChartVentasIngresosCategoria'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.ventasCat || []; const sliced = analyticsApartados.ventas.mode==='top'?sliceTop(src,'ingresos'):sliceBottom(src,'ingresos'); const rows = sliced.length ? sliced.map(r=>[r.label, r.ingresos]) : [['Sin datos', 0]]; const colors = makePalette(rows.length); const dt = window.google.visualization.arrayToDataTable([['Categoría','Ingresos'], ...rows]); new window.google.visualization.PieChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, backgroundColor:'transparent', colors:colors, pieHole:0.35, sliceVisibilityThreshold: 0.02 }); }
function baseChartOptions(color, currency) { return { legend: { position: 'bottom' }, chartArea: { width: '85%', height: '70%' }, backgroundColor: 'transparent', colors: [color], hAxis: { textStyle: { color: '#6b7280' }, gridlines: { color: '#f3f4f6' } }, vAxis: { textStyle: { color: '#6b7280' }, gridlines: { color: '#e5e7eb' }, format: currency ? 'short' : '' }, tooltip: { textStyle: { color: '#111827' } }, annotations: { alwaysOutside: false, textStyle: { color: '#374151' } }, bar: { groupWidth: '70%' } }; }
function makePalette(n){ const base=['#2563eb','#16a34a','#f59e0b','#ef4444','#9333ea','#10b981','#f472b6','#0ea5e9','#22c55e','#a855f7','#e11d48','#14b8a6','#d97706','#8b5cf6','#22d3ee']; const out=[]; for(let i=0;i<n;i++){ out.push(base[i%base.length]); } return out; }
function drawResumenMetrics() {
  const carritosEl = document.getElementById('metricCarritosAbandonados'); const clientesMesEl = document.getElementById('metricClientesMes'); const stockTotalEl = document.getElementById('metricStockTotal'); const agotadosEl = document.getElementById('metricAgotados'); const valorInvEl = document.getElementById('metricValorInventario'); const transFallEl = document.getElementById('metricTransaccionesFallidas');
  try { const nowMs = Date.now(); const pendientes = (analyticsState.data.ventasList||[]).filter(v=> String(v.estado||'').toLowerCase()==='pendiente'); const abandonados = pendientes.filter(v=>{ const t = new Date(v.fecha_venta||v.created_at||0).getTime(); return (nowMs - t) > (24*3600*1000); }).length; if (carritosEl) carritosEl.textContent = String(abandonados); } catch {}
  try { if (clientesMesEl) clientesMesEl.textContent = String(analyticsState.data.clientesMes||0); } catch {}
  try { const inv = analyticsState.data.inventarioCat||[]; const stockTotal = inv.reduce((acc,i)=> acc + Number(i.unidades||0), 0); const valorTotal = inv.reduce((acc,i)=> acc + Number(i.valor||0), 0); if (stockTotalEl) stockTotalEl.textContent = String(stockTotal); if (valorInvEl) valorInvEl.textContent = new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(valorTotal); } catch {}
  try { const agotados = (analyticsState.data.inventarioCat||[]).filter(i=> Number(i.unidades||0)===0).length; if (agotadosEl) agotadosEl.textContent = String(agotados); } catch {}
  try { const fallidas = (analyticsState.data.pedidos||[]).filter(p=> String(p.label||'').toLowerCase().includes('rechaz')).reduce((a,b)=> a + Number(b.valor||0), 0); if (transFallEl) transFallEl.textContent = String(fallidas); } catch {}
}
function drawVisitasMes() { const el = document.getElementById('chartVisitasMes'); if (!el) return; if (!(window.google && window.google.visualization && typeof window.google.visualization.arrayToDataTable === 'function')) return; const src = analyticsState.data.visitasMes||[]; const rows = src.length? src.map(v=>[v.fecha, v.visitas]) : buildEmptyDates(30).map(d=>[d,0]); const dt = window.google.visualization.arrayToDataTable([['Fecha','Visitas'], ...rows]); new window.google.visualization.LineChart(el).draw(dt, { legend:{position:'bottom'}, chartArea:{width:'85%',height:'70%'}, colors:['#2563eb'] }); }
function buildEmptyDates(days) { const out=[]; const now=new Date(); const start=new Date(now); start.setDate(now.getDate()-(days-1)); for(let i=0;i<days;i++){ const d=new Date(start); d.setDate(start.getDate()+i); out.push(d.toLocaleDateString('es-CL')); } return out; }
function groupVentasByTime(tf) { const arr = analyticsState.data.ventasList || []; const now = new Date(); const start = new Date(now); let buckets = []; if (tf==='dia') { start.setHours(0,0,0,0); for (let h=0; h<24; h++) buckets.push({ key: h, label: `${String(h).padStart(2,'0')}:00`, valor: 0 }); arr.forEach(v=>{ const d = new Date(v.fecha_venta); if (d.toDateString() === now.toDateString()) { const h=d.getHours(); buckets[h].valor += Number(v.total_venta||0); } }); return buckets; } if (tf==='semana') { start.setDate(now.getDate()-6); start.setHours(0,0,0,0); for (let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); buckets.push({ key: d.toISOString().slice(0,10), label: d.toLocaleDateString('es-CL',{weekday:'short', day:'2-digit'}), valor:0 }); } arr.forEach(v=>{ const d=new Date(v.fecha_venta); if (d>=start && d<=now){ const k=d.toISOString().slice(0,10); const b=buckets.find(x=>x.key===k); if (b) b.valor += Number(v.total_venta||0);} }); return buckets; } start.setDate(now.getDate()-29); start.setHours(0,0,0,0); for (let i=0;i<30;i++){ const d=new Date(start); d.setDate(start.getDate()+i); buckets.push({ key: d.toISOString().slice(0,10), label: d.toLocaleDateString('es-CL',{month:'2-digit', day:'2-digit'}), valor:0 }); } arr.forEach(v=>{ const d=new Date(v.fecha_venta); if (d>=start && d<=now){ const k=d.toISOString().slice(0,10); const b=buckets.find(x=>x.key===k); if (b) b.valor += Number(v.total_venta||0);} }); return buckets; }
function normalizeRutDigits(s){ try { return String(s||'').replace(/\D/g,''); } catch { return ''; } }
function buildUserNameMap(list){ const map = new Map(); (Array.isArray(list)?list:[]).forEach(u=>{ const nombre = [u?.nombre ?? u?.first_name ?? u?.name ?? '', u?.apellido ?? u?.apellidos ?? u?.last_name ?? ''].filter(Boolean).join(' ').trim(); const username = String(u?.username || u?.user_name || '').toLowerCase(); const email = String(u?.email || '').toLowerCase(); const id = String(u?.id_usuario || u?.id || '').trim(); const rut = normalizeRutDigits(u?.rut || u?.rut_sin_dv || ''); const display = nombre || username || email || (rut ? `RUT ${rut}` : (id ? `ID ${id}` : 'Cliente')); if (id) map.set(`id:${id}`, display); if (rut) map.set(`rut:${rut}`, display); if (username) map.set(`user:${username}`, display); if (email) map.set(`email:${email}`, display); }); return map; }
function resolveUserDisplay(v, map){ try { const id = String(v?.id_usuario || v?.usuario_id || '').trim(); const rut = normalizeRutDigits(v?.rut_usuario || v?.rut || ''); const username = String(v?.usuario || v?.username || '').toLowerCase(); const email = String(v?.email_usuario || '').toLowerCase(); const inline = [v?.usuario_nombre || v?.nombre || '', v?.usuario_apellido || v?.apellido || ''].filter(Boolean).join(' ').trim(); if (inline) return inline; const keys = [ id && `id:${id}`, rut && `rut:${rut}`, username && `user:${username}`, email && `email:${email}` ].filter(Boolean); for (const k of keys){ const val = map?.get?.(k); if (val) return val; } return username || (rut ? `RUT ${rut}` : (String(v?.usuario||'').trim() || 'Invitado')); } catch { return String(v?.usuario||'Invitado'); } }
async function buildUserMapAndRelabel(){ try { const usuarios = await getData('/api/usuarios/'); const list = Array.isArray(usuarios)?usuarios:[]; const map = buildUserNameMap(list); analyticsState.data.userNameMap = map; const arr = Array.isArray(analyticsState.data.ventasList)?analyticsState.data.ventasList:[]; const porUsuario = {}; arr.forEach(v=>{ const nombre = resolveUserDisplay(v, map); porUsuario[nombre] = (porUsuario[nombre]||0) + 1; }); analyticsState.data.clientes = Object.entries(porUsuario).map(([label,valor])=>({ label, valor })); try { const cont = document.getElementById('ultimasVentasBody'); if (cont && arr.length) { const rows = cont.querySelectorAll('tr'); rows.forEach(row=>{ const first=row.children[0]; const id = first ? String(first.textContent||'').replace('#','').trim() : ''; const venta = arr.find(x=>String(x.id_venta)===id); if (venta) { const cell = row.children[2]; if (cell) cell.textContent = resolveUserDisplay(venta, map); } }); } } catch {} } catch {}
}
async function drawApartadoVentasPorDia() { const el = document.getElementById('apartadoChartVentasPorDia'); if (!el) return; try { const tf = analyticsApartados.ventas.timeframe || 'dia'; let ventasDia; try { ventasDia = await getData(`/api/dashboard/charts/ventas_por_dia?tf=${encodeURIComponent(tf)}`); } catch { ventasDia = null; } if (!Array.isArray(ventasDia) || ventasDia.length === 0) { const fallback = buildVentasPorDiaFallback(tf); ventasDia = fallback; } await ensureGoogleChartsReady(); const rows = ventasDia.map(v => [String(v.fecha), Number(v.ingresos || 0), Number(v.cantidad || 0)]); const dataTable = window.google.visualization.arrayToDataTable([ ['Fecha', 'Ingresos', 'Cantidad'], ...rows ]); const options = { legend: { position: 'bottom' }, series: { 0: { targetAxisIndex: 0, color: '#2563eb' }, 1: { targetAxisIndex: 1, color: '#16a34a' } }, vAxes: { 0: { format: 'short' }, 1: { format: '' } }, chartArea: { width: '85%', height: '70%' }, backgroundColor: 'transparent' }; new window.google.visualization.LineChart(el).draw(dataTable, options); } catch (e) { console.warn('[Charts] Error Ventas por día apartado', e); } }
function buildVentasPorDiaFallback(tf){ const arr = Array.isArray(analyticsState.data.ventasList)? analyticsState.data.ventasList : []; const now = new Date(); let days = tf==='dia'?2:(tf==='semana'?7:30); const out = []; const start = new Date(now); start.setDate(now.getDate()-(days-1)); start.setHours(0,0,0,0); const buckets = {}; for(let i=0;i<days;i++){ const d=new Date(start); d.setDate(start.getDate()+i); const key = d.toISOString().slice(0,10); buckets[key] = { ingresos:0, cantidad:0, fecha: d.toLocaleDateString('es-CL') }; } arr.forEach(v=>{ try { const d = new Date(v.fecha_venta||v.created_at||now); const key = d.toISOString().slice(0,10); if (buckets[key]) { buckets[key].ingresos += Number(v.total_venta||0); buckets[key].cantidad += 1; } } catch {} }); return Object.keys(buckets).sort().map(k=>({ fecha: buckets[k].fecha, ingresos: buckets[k].ingresos, cantidad: buckets[k].cantidad })); }
function redrawApartados() { try { drawApartadoVentasPorDia(); drawApartadoVentasTopProductos(); drawApartadoVentasIngresosCategoria(); drawApartadoClientes(); drawApartadoInventario(); drawApartadoEnvios(); drawApartadoPagos(); } catch {} }
function setupResizeRedraw() { let t; window.addEventListener('resize', () => { clearTimeout(t); t = setTimeout(redrawApartados, 250); }); }
async function refreshDashboardCharts(){ try { await cargarDashboard(); await loadAnalyticsData(); redrawApartados(); } catch {} }
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const storedRole = (sessionStorage.getItem('role') || localStorage.getItem('role') || '').toLowerCase();
  let role = storedRole;
  try { const u = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || '{}'); const r = String((u.rol || u.role || storedRole) || '').toLowerCase(); role = r === 'admin' ? 'administrador' : r; } catch {}
  const apply = (selector, allow) => { document.querySelectorAll(selector).forEach(el => { if (!allow.includes(role)) el.style.display = 'none'; }); };
  apply('.role-section-admin-only', ['administrador']);
  apply('.role-section-admin-bodeguero-only', ['administrador','bodeguero']);
  apply('.role-section-admin-repartidor-only', ['administrador','repartidor']);
});
</script>
<script>
(function(){
  try {
    const env = window.__ENV__ || {};
    const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
    if (!window.API_BASE) window.API_BASE = api;
    if (!window.__API_BASE_LOGGED__) { console.log('Cargando script de login...'); console.log('API URL es:', window.API_BASE); window.__API_BASE_LOGGED__ = true; }
  } catch {}
})();
</script>
