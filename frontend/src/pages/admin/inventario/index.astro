---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestión de Inventario">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Gestión de Inventario</h1>
            <div class="flex space-x-3">
                <button id="btnProveedores" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Proveedores
                </button>
                <button id="btnCategorias" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                    Categorías
                </button>
                <button id="btnNuevoInventario" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Nuevo Registro
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar producto</label>
                    <input type="text" id="filtroProducto" placeholder="Nombre del producto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock mínimo</label>
                    <select id="filtroStock" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todos</option>
                        <option value="bajo">Stock bajo</option>
                        <option value="agotado">Agotado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <select id="filtroCategoria" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="btnFiltrar" class="w-full bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Filtrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de inventario -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código Interno</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Actual</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaInventario" class="bg-white divide-y divide-gray-200">
                    <!-- Los registros se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-700">
                Mostrando <span id="mostrandoDesde">0</span> a <span id="mostrandoHasta">0</span> de <span id="totalRegistros">0</span> registros
            </div>
            <div class="flex space-x-2">
                <button id="btnAnterior" class="px-3 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50" disabled>
                    Anterior
                </button>
                <button id="btnSiguiente" class="px-3 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50" disabled>
                    Siguiente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar inventario -->
    <div id="modalInventario" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="tituloModal" class="text-lg font-medium text-gray-900 mb-4">Nuevo Registro de Inventario</h3>
                <form id="formInventario">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <!-- Campos para nuevo producto -->
                         <div id="camposNuevoProducto" class="col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Producto *</label>
                                    <input type="text" id="nombreProducto" name="nombreProducto" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Código Interno</label>
                                    <input type="text" id="codigoBarras" name="codigoBarras" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría <span class="text-red-500">*</span></label>
                                    <select id="categoriaProducto" name="categoriaProducto" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar categoría</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor <span class="text-red-500">*</span></label>
                                    <select id="proveedorProducto" name="proveedorProducto" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar proveedor</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Costo Bruto</label>
                                    <input type="number" id="costoBruto" name="costoBruto" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Costo Neto</label>
                                    <input type="number" id="costoNeto" name="costoNeto" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Porcentaje Utilidad (%)</label>
                                    <input type="number" id="porcentajeUtilidad" name="porcentajeUtilidad" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Utilidad en Pesos</label>
                                    <input type="number" id="utilidadPesos" name="utilidadPesos" min="0" step="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock Mínimo</label>
                                    <input type="number" id="stockMinimo" name="stockMinimo" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                    <textarea id="descripcionProducto" name="descripcionProducto" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio *</label>
                            <input type="number" id="precio" name="precio" min="0" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad *</label>
                            <input type="number" id="cantidad" name="cantidad" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="btnCancelar" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-700">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div id="modalEliminar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900">Confirmar eliminación</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">¿Estás seguro de que deseas eliminar este registro de inventario? Esta acción no se puede deshacer.</p>
                </div>
                <div class="flex justify-center space-x-3 mt-4">
                    <button id="btnCancelarEliminar" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Cancelar
                    </button>
                    <button id="btnConfirmarEliminar" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-700">
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let paginaActual = 0;
        const registrosPorPagina = 10;
        let totalRegistros = 0;
        let inventarioEditando = null;
        let inventarioAEliminar = null;
        let productos = [];
        let categorias = [];
        let proveedores = [];

        // Elementos del DOM
        const tablaInventario = document.getElementById('tablaInventario');
        const modalInventario = document.getElementById('modalInventario');
        const modalEliminar = document.getElementById('modalEliminar');
        const formInventario = document.getElementById('formInventario');
        const tituloModal = document.getElementById('tituloModal');
        const btnNuevoInventario = document.getElementById('btnNuevoInventario');
        const btnCancelar = document.getElementById('btnCancelar');
        const btnCancelarEliminar = document.getElementById('btnCancelarEliminar');
        const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
        const btnAnterior = document.getElementById('btnAnterior');
        const btnSiguiente = document.getElementById('btnSiguiente');
        const btnFiltrar = document.getElementById('btnFiltrar');

        // Obtener token de autenticación
        function getAuthToken() {
            const token = localStorage.getItem('token');
            console.log('Token de autenticación:', token ? 'Presente' : 'No encontrado');
            if (!token) {
                console.log('No hay token de autenticación. Redirigiendo a login...');
                window.location.href = '/login';
            }
            return token;
        }

        // Verificar autenticación
        function verificarAuth() {
            const token = getAuthToken();
            if (!token) {
                console.log('Usuario no autenticado, redirigiendo a login');
                window.location.href = '/login';
                return false;
            }
            console.log('Usuario autenticado correctamente');
            return true;
        }

        // Cargar productos para el selector
        async function cargarProductos() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No hay token de autenticación');
                    return;
                }
                
                const response = await fetch('http://localhost:8000/productos', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    productos = await response.json();
                    console.log('Productos cargados:', productos);
                } else if (response.status === 401) {
                    console.error('Token de autenticación inválido o expirado');
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                } else {
                    console.error('Error al cargar productos:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
            }
        }

        // Cargar categorías
        async function cargarCategorias() {
            try {
                console.log('Cargando categorías...');
                const response = await fetch('http://localhost:8000/categorias', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                console.log('Respuesta de categorías:', response.status);
                
                if (response.ok) {
                    categorias = await response.json();
                    console.log('Categorías cargadas:', categorias);
                    
                    const filtroCategoria = document.getElementById('filtroCategoria');
                    const categoriaProducto = document.getElementById('categoriaProducto');
                    
                    if (filtroCategoria) filtroCategoria.innerHTML = '<option value="">Todas las categorías</option>';
                    if (categoriaProducto) categoriaProducto.innerHTML = '<option value="">Seleccionar categoría</option>';
                    
                    categorias.forEach(categoria => {
                        if (filtroCategoria) {
                            const option1 = new Option(categoria.nombre, categoria.id_categoria);
                            filtroCategoria.add(option1);
                        }
                        
                        if (categoriaProducto) {
                            const option2 = new Option(categoria.nombre, categoria.id_categoria);
                            categoriaProducto.add(option2);
                        }
                    });
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    console.error('Error al cargar categorías. Estado:', response.status);
                }
            } catch (error) {
                console.error('Error al cargar categorías:', error);
            }
        }

        // Cargar proveedores
        async function cargarProveedores() {
            try {
                console.log('Cargando proveedores...');
                const response = await fetch('http://localhost:8000/proveedores', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                console.log('Respuesta de proveedores:', response.status);
                
                if (response.ok) {
                    proveedores = await response.json();
                    console.log('Proveedores cargados:', proveedores);
                    
                    const proveedorProducto = document.getElementById('proveedorProducto');
                    
                    if (proveedorProducto) {
                        proveedorProducto.innerHTML = '<option value="">Seleccionar proveedor</option>';
                        
                        proveedores.forEach(proveedor => {
                            const option = new Option(proveedor.nombre, proveedor.id_proveedor);
                            proveedorProducto.add(option);
                        });
                    } else {
                        console.error('Elemento proveedorProducto no encontrado');
                    }
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    console.error('Error al cargar proveedores. Estado:', response.status);
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
            }
        }

        // Cargar inventario
        async function cargarInventario() {
            try {
                const filtroProducto = document.getElementById('filtroProducto').value;
                const filtroStock = document.getElementById('filtroStock').value;
                const filtroCategoria = document.getElementById('filtroCategoria').value;
                
                let url = `http://localhost:8000/inventario?skip=${paginaActual * registrosPorPagina}&limit=${registrosPorPagina}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    let inventario = await response.json();
                    
                    // Aplicar filtros en el frontend
                    if (filtroProducto) {
                        inventario = inventario.filter(item => {
                            const producto = productos.find(p => 
                                (p.id && p.id === item.id_producto) || 
                                (p.id_producto && p.id_producto === item.id_producto)
                            );
                            return producto && producto.nombre.toLowerCase().includes(filtroProducto.toLowerCase());
                        });
                    }
                    
                    if (filtroStock === 'bajo') {
                        inventario = inventario.filter(item => item.cantidad <= 5 && item.cantidad > 0);
                    } else if (filtroStock === 'agotado') {
                        inventario = inventario.filter(item => item.cantidad === 0);
                    }
                    
                    if (filtroCategoria) {
                        inventario = inventario.filter(item => {
                            const producto = productos.find(p => 
                                (p.id && p.id === item.id_producto) || 
                                (p.id_producto && p.id_producto === item.id_producto)
                            );
                            // Comprobar tanto id_categoria como categoria
                            return producto && 
                                ((producto.id_categoria && producto.id_categoria == filtroCategoria) ||
                                 (producto.categoria && categorias.find(c => c.nombre === producto.categoria && c.id_categoria == filtroCategoria)));
                        });
                    }
                    
                    mostrarInventario(inventario);
                    actualizarPaginacion(inventario.length);
                } else if (response.status === 401) {
                    console.error('Error de autenticación');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error al cargar inventario:', error);
            }
        }

        // Mostrar inventario en la tabla
        function mostrarInventario(inventario) {
            tablaInventario.innerHTML = '';
            
            inventario.forEach(item => {
                // Buscar producto por id o id_producto para compatibilidad con ambos formatos
                const producto = productos.find(p => (p.id && p.id === item.id_producto) || 
                                                   (p.id_producto && p.id_producto === item.id_producto));
                const nombreProducto = producto ? producto.nombre : 'Producto no encontrado';
                const codigoInterno = producto ? producto.codigo_interno : 'N/A';
                
                // Buscar proveedor
                const proveedor = proveedores.find(p => p.id_proveedor === (producto ? producto.id_proveedor : null));
                const nombreProveedor = proveedor ? proveedor.nombre : 'N/A';
                
                // Buscar categoría
                const categoria = categorias.find(c => c.id_categoria === (producto ? producto.id_categoria : null));
                const nombreCategoria = categoria ? categoria.nombre : 'N/A';
                
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${codigoInterno}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nombreProducto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.cantidad}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nombreProveedor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${nombreCategoria}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editarInventario(${item.id_inventario})" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                        <button onclick="eliminarInventario(${item.id_inventario})" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                tablaInventario.appendChild(fila);
            });
        }

        // Actualizar información de paginación
        function actualizarPaginacion(cantidadMostrada) {
            const desde = paginaActual * registrosPorPagina + 1;
            const hasta = Math.min(desde + cantidadMostrada - 1, totalRegistros);
            
            document.getElementById('mostrandoDesde').textContent = cantidadMostrada > 0 ? desde : 0;
            document.getElementById('mostrandoHasta').textContent = hasta;
            document.getElementById('totalRegistros').textContent = totalRegistros;
            
            btnAnterior.disabled = paginaActual === 0;
            btnSiguiente.disabled = hasta >= totalRegistros;
        }

        // Función para redondear a la decena más cercana
        function redondearADecena(valor) {
            // Truncar decimales
            const valorTruncado = Math.trunc(valor);
            // Obtener el último dígito
            const ultimoDigito = valorTruncado % 10;
            // Si el último dígito es 0, no hacer nada
            if (ultimoDigito === 0) {
                return valorTruncado;
            }
            // Redondear a la decena superior
            return valorTruncado + (10 - ultimoDigito);
        }
        
        // Función para calcular precio automáticamente
        function calcularPrecio() {
            const costoBrutoValue = document.getElementById('costoBruto').value;
            const costoNetoValue = document.getElementById('costoNeto').value;
            const porcentajeUtilidadValue = document.getElementById('porcentajeUtilidad').value;
            const utilidadPesosValue = document.getElementById('utilidadPesos').value;
            
            const costoBruto = parseInt(costoBrutoValue) || 0;
            const costoNeto = parseInt(costoNetoValue) || 0;
            const porcentajeUtilidad = parseInt(porcentajeUtilidadValue) || 0;
            const utilidadPesos = parseInt(utilidadPesosValue) || 0;
            
            let precioBase = 0;
            
            // Solo calcular si hay valores reales (no vacíos) y no estamos editando ese campo
            // Si hay costo bruto y el campo costo neto está vacío, calcular costo neto
            if (costoBruto > 0 && costoNetoValue.trim() === '' && campoEnEdicion !== 'costoNeto') {
                const costoNetoCalculado = costoBruto / 1.19;
                const costoNetoRedondeado = redondearADecena(costoNetoCalculado);
                document.getElementById('costoNeto').value = costoNetoRedondeado;
                precioBase = costoNetoRedondeado;
            }
            // Si hay costo neto y el campo costo bruto está vacío, calcular costo bruto
            else if (costoNeto > 0 && costoBrutoValue.trim() === '' && campoEnEdicion !== 'costoBruto') {
                const costoBrutoCalculado = costoNeto * 1.19;
                const costoBrutoRedondeado = redondearADecena(costoBrutoCalculado);
                document.getElementById('costoBruto').value = costoBrutoRedondeado;
                precioBase = costoNeto;
            }
            // Si ambos están llenos, usar costo neto como base
            else if (costoNeto > 0) {
                precioBase = costoNeto;
            }
            else if (costoBruto > 0) {
                precioBase = costoBruto / 1.19;
            }
            
            // Calcular precio final con utilidad
            let precioFinal = precioBase;
            
            // Agregar utilidad por porcentaje
            if (porcentajeUtilidad > 0) {
                precioFinal = precioBase * (1 + porcentajeUtilidad / 100);
            }
            
            // Agregar utilidad en pesos
            if (utilidadPesos > 0) {
                precioFinal += utilidadPesos;
            }
            
            // Redondear precio final y actualizar el campo
            if (precioFinal > 0) {
                const precioFinalRedondeado = redondearADecena(precioFinal);
                document.getElementById('precio').value = precioFinalRedondeado;
            }
        }

        // Abrir modal para nuevo registro
        function abrirModalNuevo() {
            inventarioEditando = null;
            tituloModal.textContent = 'Nuevo Registro de Inventario';
            formInventario.reset();
            
            // Establecer valores por defecto en cero para los nuevos campos
            document.getElementById('costoBruto').value = '0';
            document.getElementById('costoNeto').value = '0';
            document.getElementById('porcentajeUtilidad').value = '0';
            document.getElementById('utilidadPesos').value = '0';
            document.getElementById('stockMinimo').value = '0';
            
            // Establecer campos requeridos correctamente
            document.getElementById('nombreProducto').setAttribute('required', 'required');
            document.getElementById('categoriaProducto').setAttribute('required', 'required');
            document.getElementById('proveedorProducto').setAttribute('required', 'required');
            
            // Cargar categorías y proveedores
            cargarCategorias();
            cargarProveedores();
            
            modalInventario.classList.remove('hidden');
        }

        // Editar inventario
        async function editarInventario(id) {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No hay token de autenticación');
                    return;
                }
                
                const response = await fetch(`http://localhost:8000/inventario/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const inventario = await response.json();
                    inventarioEditando = inventario;
                    tituloModal.textContent = 'Editar Inventario';
                    
                    // Cargar categorías y proveedores primero
                    await cargarCategorias();
                    await cargarProveedores();
                    
                    // Llenar el formulario
                    document.getElementById('precio').value = inventario.precio;
                    document.getElementById('cantidad').value = inventario.cantidad;
                    
                    // Usar los datos del producto que vienen en la respuesta del inventario
                    const producto = inventario.producto;
                    
                    if (producto) {
                        // Llenar campos del producto
                        document.getElementById('nombreProducto').value = producto.nombre || '';
                        document.getElementById('codigoBarras').value = producto.codigo_barras || '';
                        document.getElementById('descripcionProducto').value = producto.descripcion || '';
                        
                        // Llenar nuevos campos
                        document.getElementById('costoBruto').value = producto.costo_bruto || '0';
                        document.getElementById('costoNeto').value = producto.costo_neto || '0';
                        document.getElementById('porcentajeUtilidad').value = producto.porcentaje_utilidad || '0';
                        document.getElementById('utilidadPesos').value = producto.utilidad_pesos || '0';
                        document.getElementById('stockMinimo').value = producto.stock_minimo || '0';
                        
                        // Seleccionar categoría
                        if (producto.id_categoria) {
                            document.getElementById('categoriaProducto').value = producto.id_categoria;
                        }
                        
                        // Seleccionar proveedor
                        if (producto.id_proveedor) {
                            document.getElementById('proveedorProducto').value = producto.id_proveedor;
                        }
                    }
                    
                    modalInventario.classList.remove('hidden');
                } else if (response.status === 401) {
                    console.log('Error de autenticación al editar inventario. Redirigiendo a login...');
                    alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                } else {
                    const error = await response.json();
                    let errorMsg = 'Error al cargar inventario';
                    if (error.detail) {
                        errorMsg += ': ' + error.detail;
                    }
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error al cargar inventario:', error);
                alert('Error al cargar datos del inventario: ' + error.message);
            }
        }

        // Eliminar inventario
        function eliminarInventario(id) {
            inventarioAEliminar = id;
            modalEliminar.classList.remove('hidden');
        }

        // Confirmar eliminación
        async function confirmarEliminacion() {
            try {
                const token = getAuthToken();
                if (!token) {
                    console.error('No hay token de autenticación');
                    return;
                }
                
                const response = await fetch(`http://localhost:8000/inventario/${inventarioAEliminar}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    modalEliminar.classList.add('hidden');
                    cargarInventario();
                } else if (response.status === 401) {
                    console.log('Error de autenticación al eliminar inventario. Redirigiendo a login...');
                    alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                } else {
                    const error = await response.json();
                    let errorMsg = 'Error al eliminar registro';
                    if (error.detail) {
                        if (typeof error.detail === 'string') {
                            errorMsg += ': ' + error.detail;
                        } else if (Array.isArray(error.detail)) {
                            errorMsg += ': ' + error.detail.map(err => err.msg).join(', ');
                        } else {
                            errorMsg += ': ' + JSON.stringify(error.detail);
                        }
                    } else {
                        errorMsg += ': ' + JSON.stringify(error);
                    }
                    
                    console.error('Error de respuesta al eliminar inventario:', error);
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error al eliminar inventario:', error);
                let errorMessage = 'Error al eliminar registro';
                
                // Intentar extraer el mensaje de error detallado
                if (error.message) {
                    errorMessage += ': ' + error.message;
                } else if (typeof error === 'object') {
                    errorMessage += ': ' + JSON.stringify(error);
                }
                
                alert(errorMessage);
            }
        }

        // Guardar inventario
        async function guardarInventario(event) {
            event.preventDefault();
            
            const formData = new FormData(formInventario);
            
            // Validar campos requeridos
            const camposRequeridos = ['nombreProducto', 'categoriaProducto', 'proveedorProducto', 'precio', 'cantidad'];
            const camposFaltantes = [];
            
            for (const campo of camposRequeridos) {
                const valor = formData.get(campo);
                if (!valor || valor.trim() === '') {
                    camposFaltantes.push(campo);
                }
            }
            
            if (camposFaltantes.length > 0) {
                alert(`Error: Los siguientes campos son requeridos: ${camposFaltantes.join(', ')}`);
                return;
            }
            
            try {
                // Si estamos editando un inventario existente
                if (inventarioEditando) {
                    // Crear objeto de actualización para el inventario
                    const inventarioActualizado = {
                        precio: parseInt(formData.get('precio')),
                        cantidad: parseInt(formData.get('cantidad'))
                    };
                    
                    console.log('Actualizando inventario:', inventarioActualizado);
                    
                    // Llamar al endpoint PUT para actualizar el inventario
                    const response = await fetch(`http://localhost:8000/inventario/${inventarioEditando.id_inventario}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(inventarioActualizado)
                    });
                    
                    // También actualizar el producto si el nombre ha cambiado
                    const nombreProducto = formData.get('nombreProducto');
                    const producto = inventarioEditando.producto;
                    
                    if (producto) {
                        const codigoBarrasUpdate = formData.get('codigoBarras');
                        const productoActualizado = {
                            nombre: nombreProducto,
                            descripcion: formData.get('descripcionProducto') || producto.descripcion,
                            codigo_barras: codigoBarrasUpdate && codigoBarrasUpdate.trim() !== '' ? codigoBarrasUpdate.trim() : (producto.codigo_barras || null),
                            id_categoria: parseInt(formData.get('categoriaProducto')) || producto.id_categoria,
                            id_proveedor: parseInt(formData.get('proveedorProducto')) || producto.id_proveedor,
                            costo_bruto: parseInt(formData.get('costoBruto')) || producto.costo_bruto || 0,
                            costo_neto: parseInt(formData.get('costoNeto')) || producto.costo_neto || 0,
                            porcentaje_utilidad: parseInt(formData.get('porcentajeUtilidad')) || producto.porcentaje_utilidad || 0,
                            utilidad_pesos: parseInt(formData.get('utilidadPesos')) || producto.utilidad_pesos || 0,
                            stock_minimo: parseInt(formData.get('stockMinimo')) || producto.stock_minimo || 0
                        };
                        
                        console.log('Actualizando producto:', productoActualizado);
                        
                        // Llamar al endpoint PUT para actualizar el producto
                        const productoResponse = await fetch(`http://localhost:8000/productos/${producto.id_producto}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getAuthToken()}`
                            },
                            body: JSON.stringify(productoActualizado)
                        });
                        
                        if (!productoResponse.ok) {
                            console.error('Error al actualizar el producto:', await productoResponse.json());
                        }
                    }
                    
                    if (!response.ok) {
                        const error = await response.json();
                        let errorMsg = 'Error al actualizar inventario';
                        
                        // Verificar si es un error de autenticación
                        if (response.status === 401) {
                            console.log('Error de autenticación al actualizar inventario. Redirigiendo a login...');
                            alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                            localStorage.removeItem('token');
                            window.location.href = '/login';
                            return;
                        }
                        
                        if (error.detail) {
                            if (typeof error.detail === 'string') {
                                errorMsg += ': ' + error.detail;
                            } else if (Array.isArray(error.detail)) {
                                errorMsg += ': ' + error.detail.map(err => err.msg).join(', ');
                            } else {
                                errorMsg += ': ' + JSON.stringify(error.detail);
                            }
                        } else {
                            errorMsg += ': ' + JSON.stringify(error);
                        }
                        
                        console.error('Error de respuesta:', error);
                        alert(errorMsg);
                        return;
                    }
                    
                    const inventarioActualizadoResponse = await response.json();
                    console.log('Inventario actualizado:', inventarioActualizadoResponse);
                    
                    modalInventario.classList.add('hidden');
                    // Recargar inventario
                    await cargarInventario();
                    
                    // Mostrar mensaje de éxito
                    alert(`Inventario actualizado exitosamente.`);
                } else {
                    // Crear nuevo producto según el modelo ProductoCreate/ProductoBase actualizado
                    const codigoBarras = formData.get('codigoBarras');
                    const nuevoProducto = {
                        nombre: formData.get('nombreProducto'),
                        descripcion: formData.get('descripcionProducto') || '',
                        codigo_barras: codigoBarras && codigoBarras.trim() !== '' ? codigoBarras.trim() : null,
                        id_categoria: parseInt(formData.get('categoriaProducto')) || null,
                        id_proveedor: parseInt(formData.get('proveedorProducto')) || null,
                        precio: parseFloat(formData.get('precio')),
                        cantidad: parseInt(formData.get('cantidad')) || 0,
                        costo_bruto: parseInt(formData.get('costoBruto')) || 0,
                        costo_neto: parseInt(formData.get('costoNeto')) || 0,
                        porcentaje_utilidad: parseInt(formData.get('porcentajeUtilidad')) || 0,
                        utilidad_pesos: parseInt(formData.get('utilidadPesos')) || 0,
                        stock_minimo: parseInt(formData.get('stockMinimo')) || 0
                    };
                    
                    console.log('Enviando producto:', nuevoProducto);
                    
                    const productoResponse = await fetch('http://localhost:8000/productos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getAuthToken()}`
                        },
                        body: JSON.stringify(nuevoProducto)
                    });
                    
                    if (!productoResponse.ok) {
                        const error = await productoResponse.json();
                        let errorMsg = 'Error al crear producto';
                        
                        // Verificar si es un error de autenticación
                        if (productoResponse.status === 401 || (error.detail && error.detail === 'Not authenticated')) {
                            console.log('Error de autenticación al crear producto. Redirigiendo a login...');
                            alert('Sesión expirada. Por favor, inicie sesión nuevamente.');
                            localStorage.removeItem('token');
                            window.location.href = '/login';
                            return;
                        }
                        
                        if (error.detail) {
                            if (typeof error.detail === 'string') {
                                errorMsg += ': ' + error.detail;
                            } else if (Array.isArray(error.detail)) {
                                errorMsg += ': ' + error.detail.map(err => err.msg).join(', ');
                            } else {
                                errorMsg += ': ' + JSON.stringify(error.detail);
                            }
                        } else {
                            errorMsg += ': ' + JSON.stringify(error);
                        }
                        
                        console.error('Error de respuesta:', error);
                        alert(errorMsg);
                        return;
                    }
                    
                    const productoCreado = await productoResponse.json();
                    console.log('Producto creado:', productoCreado);
                    
                    modalInventario.classList.add('hidden');
                    // Recargar inventario
                    await cargarInventario();
                    
                    // Mostrar mensaje de éxito
                    alert(`Producto "${nuevoProducto.nombre}" creado exitosamente con inventario inicial de ${nuevoProducto.cantidad} unidades.`);
                }
            } catch (error) {
                console.error('Error al guardar inventario:', error);
                let errorMessage = 'Error al guardar inventario';
                
                // Intentar extraer el mensaje de error detallado
                if (error.message) {
                    errorMessage += ': ' + error.message;
                } else if (typeof error === 'object') {
                    errorMessage += ': ' + JSON.stringify(error);
                }
                
                alert(errorMessage);
            }
        }

        // Cargar categorías y proveedores al iniciar
        function cargarDatosIniciales() {
            cargarCategorias();
            cargarProveedores();
        }

        // Hacer las funciones globales para que puedan ser llamadas desde el HTML
        window.editarInventario = editarInventario;
        window.eliminarInventario = eliminarInventario;
        
        // Event listeners
        btnNuevoInventario.addEventListener('click', abrirModalNuevo);
        btnCancelar.addEventListener('click', () => modalInventario.classList.add('hidden'));
        btnCancelarEliminar.addEventListener('click', () => modalEliminar.classList.add('hidden'));
        btnConfirmarEliminar.addEventListener('click', confirmarEliminacion);
        
        // Variable para el debounce
        let debounceTimer = null;
        let campoEnEdicion = null;
        
        // Función con debounce para cálculo de precio
        function calcularPrecioConDebounce(campoActual) {
            // Limpiar el timer anterior si existe
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            
            // Guardar qué campo se está editando
            campoEnEdicion = campoActual;
            
            // Establecer nuevo timer de 5ms
            debounceTimer = setTimeout(() => {
                calcularPrecio();
                campoEnEdicion = null;
            }, 5);
        }
        
        // Event listeners para cálculo automático de precio
        document.addEventListener('DOMContentLoaded', function() {
            const costoBrutoInput = document.getElementById('costoBruto');
            const costoNetoInput = document.getElementById('costoNeto');
            const porcentajeUtilidadInput = document.getElementById('porcentajeUtilidad');
            const utilidadPesosInput = document.getElementById('utilidadPesos');
            
            if (costoBrutoInput) costoBrutoInput.addEventListener('input', () => calcularPrecioConDebounce('costoBruto'));
            if (costoNetoInput) costoNetoInput.addEventListener('input', () => calcularPrecioConDebounce('costoNeto'));
            if (porcentajeUtilidadInput) porcentajeUtilidadInput.addEventListener('input', () => calcularPrecioConDebounce('porcentajeUtilidad'));
            if (utilidadPesosInput) utilidadPesosInput.addEventListener('input', () => calcularPrecioConDebounce('utilidadPesos'));
        });
        formInventario.addEventListener('submit', guardarInventario);
        btnFiltrar.addEventListener('click', () => {
            paginaActual = 0;
            cargarInventario();
        });
        btnAnterior.addEventListener('click', () => {
            if (paginaActual > 0) {
                paginaActual--;
                cargarInventario();
            }
        });
        btnSiguiente.addEventListener('click', () => {
            paginaActual++;
            cargarInventario();
        });

        // Cerrar modales al hacer clic fuera
        modalInventario.addEventListener('click', (e) => {
            if (e.target === modalInventario) {
                modalInventario.classList.add('hidden');
            }
        });
        modalEliminar.addEventListener('click', (e) => {
            if (e.target === modalEliminar) {
                modalEliminar.classList.add('hidden');
            }
        });

        // Event listeners para botones de navegación
        document.getElementById('btnProveedores').addEventListener('click', () => {
            window.location.href = '/admin/proveedores';
        });
        
        document.getElementById('btnCategorias').addEventListener('click', () => {
            window.location.href = '/admin/categorias';
        });

        // Inicializar página
        document.addEventListener('DOMContentLoaded', async () => {
            if (!verificarAuth()) {
                console.log('Redirigiendo a login por falta de autenticación');
                return;
            }
            try {
                await cargarProductos();
                await cargarCategorias();
                await cargarProveedores();
                await cargarInventario();
            } catch (error) {
                console.error('Error al cargar datos del inventario:', error);
                alert('Error al cargar datos del inventario: ' + error.message);
            }
        });
    </script>
</AdminLayout>