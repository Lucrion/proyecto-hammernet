---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import ventasScriptUrl from '../../../scripts/pages/ventas.js?url';

const title = 'Gestión de Ventas';
---

<AdminLayout title={title}>
    <div class="mb-6 flex justify-end items-center">
        <div class="flex space-x-3">
            <button id="btnEstadisticas" type="button" class="hidden inline-flex items-center justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Estadísticas
            </button>
            <button id="btnExportarVentas" type="button" class="hidden inline-flex items-center justify-center rounded-md border border-transparent bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m0 0l-3-3m3 3l3-3M4 20h16a2 2 0 002-2V8a2 2 0 00-2-2h-7l-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Exportar CSV
            </button>
            
        </div>
    </div>

    <!-- Filtros -->
    <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-4 items-end">
        <div>
            <label for="filtroFechaInicio" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
            <input type="date" id="filtroFechaInicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="filtroFechaFin" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
            <input type="date" id="filtroFechaFin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="filtroEstado" class="block text-sm font-medium text-gray-700">Estado</label>
            <select id="filtroEstado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="completada">Completada</option>
                <option value="cancelada">Cancelada</option>
            </select>
        </div>
        <div>
            <label for="inputBusqueda" class="block text-sm font-medium text-gray-700">Buscar</label>
            <input type="text" id="inputBusqueda" placeholder="ID, usuario o total" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
    </div>

        <!-- Estadísticas Rápidas -->
        <!-- <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalVentas">$0.00</h3>
                        <p>Total Ventas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="cantidadVentas">0</h3>
                        <p>Ventas Realizadas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="productosVendidos">0</h3>
                        <p>Productos Vendidos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="promedioVenta">$0.00</h3>
                        <p>Promedio por Venta</p>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- Tabla de Ventas -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead id="ventasTableHead" class="bg-gray-50">
                    <tr>
                        <th scope="col" data-sort-key="id_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">ID</th>
                        <th scope="col" data-sort-key="fecha_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Fecha</th>
                        <th scope="col" data-sort-key="usuario" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Usuario</th>
                        <th scope="col" data-sort-key="total_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Total</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                        <th scope="col" data-sort-key="estado" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Estado</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="ventasTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Las ventas se cargarán dinámicamente -->
                </tbody>
            </table>
            <!-- Paginación -->
            <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Mostrando <span id="mostrandoDesde" class="font-medium">0</span>–<span id="mostrandoHasta" class="font-medium">0</span> de <span id="totalRegistros" class="font-medium">0</span> resultados
                </div>
                <div class="flex items-center space-x-2">
                    <button id="btnPrevPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Anterior</button>
                    <button id="btnNextPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Eliminado: Modal Nueva Venta (administración manual) -->

    <!-- Modal Detalle de Venta / Entrega -->
    <div id="modalDetalleVenta" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" aria-labelledby="modal-detalle-title" role="dialog" aria-modal="true">
        <!-- Overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" aria-hidden="true"></div>

        <!-- Modal Content -->
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 id="modal-detalle-title" class="text-lg leading-6 font-medium text-gray-900 mb-6">
                    Detalle de la Venta y Orden de Entrega
                </h3>

                <!-- Encabezado del detalle -->
                <div id="detalleVentaHeader" class="grid grid-cols-2 gap-4 mb-4 text-sm text-gray-700">
                    <!-- Se llena dinámicamente -->
                </div>

                <!-- Tabla de detalles -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalleVentaBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filas se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Acciones de entrega -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" id="btnCopiarEntrega" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Copiar datos de entrega
                    </button>
                    <button type="button" id="btnImprimirEntrega" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Imprimir guía de entrega
                    </button>
                    <button type="button" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" onclick="cerrarModalDetalleVenta()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src={ventasScriptUrl}></script>
</AdminLayout>

<style>
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .admin-header h1 {
        color: #2c3e50;
        margin: 0;
        font-size: 2rem;
    }

    .admin-header h1 i {
        color: #3498db;
        margin-right: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    /* Filtros */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }

    /* Estadísticas */
    .stats-section {
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8rem;
        color: #2c3e50;
    }

    .stat-content p {
        margin: 5px 0 0 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    /* Tabla */
    .table-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h2 {
        margin: 0;
        color: #2c3e50;
    }

    .search-box {
        position: relative;
        width: 300px;
    }

    .search-box input {
        padding-right: 40px;
    }

    .search-box i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #7f8c8d;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table {
        margin: 0;
        width: 100%;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 15px;
    }

    .table td {
        padding: 12px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Estados */
    .estado-activa {
        background-color: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .estado-cancelada {
        background-color: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Paginación */
    .pagination-container {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-numbers {
        display: flex;
        gap: 5px;
    }

    /* Modal específico para ventas */
    .modal-lg {
        max-width: 900px;
    }

    .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .form-section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .productos-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .agregar-producto {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .productos-agregados {
        margin-bottom: 20px;
    }

    .venta-total {
        text-align: right;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        border: 2px solid #3498db;
    }

    .total-row {
        font-size: 1.3rem;
        color: #2c3e50;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
    }

    .loading-spinner i {
        font-size: 2rem;
        color: #3498db;
        margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .admin-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .header-actions {
            width: 100%;
            justify-content: center;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            width: 100%;
        }

        .pagination-container {
            flex-direction: column;
            gap: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
