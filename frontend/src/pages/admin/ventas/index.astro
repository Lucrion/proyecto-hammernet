---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';


const title = 'Gestión de Ventas';
---

<AdminLayout title={title}>
    <div class="mb-6 flex justify-end items-center">
        <div class="flex space-x-3">
            <button id="btnEstadisticas" type="button" class="hidden inline-flex items-center justify-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Estadísticas
            </button>
            <button id="btnExportarVentas" type="button" class="hidden inline-flex items-center justify-center rounded-md border border-transparent bg-gray-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 sm:w-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m0 0l-3-3m3 3l3-3M4 20h16a2 2 0 002-2V8a2 2 0 00-2-2h-7l-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Exportar CSV
            </button>
            
        </div>
    </div>

    <!-- Filtros -->
    <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-4 items-end">
        <div>
            <label for="filtroFechaInicio" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
            <input type="date" id="filtroFechaInicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="filtroFechaFin" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
            <input type="date" id="filtroFechaFin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="filtroEstado" class="block text-sm font-medium text-gray-700">Estado</label>
            <select id="filtroEstado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="completada">Completada</option>
                <option value="cancelada">Cancelada</option>
            </select>
        </div>
        <div>
            <label for="inputBusqueda" class="block text-sm font-medium text-gray-700">Buscar</label>
            <input type="text" id="inputBusqueda" placeholder="ID, usuario o total" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
    </div>

        <!-- Estadísticas Rápidas -->
        <!-- <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="totalVentas">$0.00</h3>
                        <p>Total Ventas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="cantidadVentas">0</h3>
                        <p>Ventas Realizadas</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="productosVendidos">0</h3>
                        <p>Productos Vendidos</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="promedioVenta">$0.00</h3>
                        <p>Promedio por Venta</p>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- Tabla de Ventas -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead id="ventasTableHead" class="bg-gray-50">
                    <tr>
                        <th scope="col" data-sort-key="id_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">ID</th>
                        <th scope="col" data-sort-key="fecha_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Fecha</th>
                        <th scope="col" data-sort-key="usuario" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Usuario</th>
                        <th scope="col" data-sort-key="total_venta" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Total</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                        <th scope="col" data-sort-key="estado" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Estado</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="ventasTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Las ventas se cargarán dinámicamente -->
                </tbody>
            </table>
            <!-- Paginación -->
            <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Mostrando <span id="mostrandoDesde" class="font-medium">0</span>–<span id="mostrandoHasta" class="font-medium">0</span> de <span id="totalRegistros" class="font-medium">0</span> resultados
                </div>
                <div class="flex items-center space-x-2">
                    <button id="btnPrevPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Anterior</button>
                    <button id="btnNextPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-100">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Eliminado: Modal Nueva Venta (administración manual) -->

    <!-- Modal Detalle de Venta / Entrega -->
    <div id="modalDetalleVenta" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden" aria-labelledby="modal-detalle-title" role="dialog" aria-modal="true">
        <!-- Overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" aria-hidden="true"></div>

        <!-- Modal Content -->
        <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 id="modal-detalle-title" class="text-lg leading-6 font-medium text-gray-900 mb-6">
                    Detalle de la Venta y Orden de Entrega
                </h3>

                <!-- Encabezado del detalle -->
                <div id="detalleVentaHeader" class="grid grid-cols-2 gap-4 mb-4 text-sm text-gray-700">
                    <!-- Se llena dinámicamente -->
                </div>

                <!-- Tabla de detalles -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalleVentaBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filas se cargan dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Acciones de entrega -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" id="btnImprimirEntrega" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Imprimir guía de entrega
                    </button>
                    <button type="button" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" onclick="cerrarModalDetalleVenta()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
function buildUrl(endpoint){const base=(window.API_BASE||'/api');if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function updateData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
function mostrarErrorToast(mensaje){try{const div=document.createElement('div');div.className='fixed top-4 right-4 z-50 bg-red-600 text-white px-4 py-2 rounded shadow';div.textContent=mensaje;document.body.appendChild(div);setTimeout(()=>{div.remove();},3000);}catch{alert('Error: '+mensaje)}}

const state = { ventas: [], ventaDetalleActual: null, filtros: { fechaInicio: null, fechaFin: null, estado: null }, paginacion: { paginaActual: 1, elementosPorPagina: 20, totalElementos: 0 }, orden: { clave: null, direccion: 'asc' } };

document.addEventListener('DOMContentLoaded', function() { inicializarEventos(); cargarDatosIniciales(); });

function inicializarEventos() { document.getElementById('btnFiltrar')?.addEventListener('click', aplicarFiltros); const inputBusqueda = document.getElementById('inputBusqueda'); if (inputBusqueda) { const debouncedBuscar = debounce(() => buscarVentas(), 300); inputBusqueda.addEventListener('input', debouncedBuscar); } const btnExportar = document.getElementById('btnExportarVentas'); btnExportar?.addEventListener('click', exportarVentasCSV); const thead = document.getElementById('ventasTableHead'); if (thead) { thead.addEventListener('click', (e) => { const th = e.target.closest('th'); const clave = th?.dataset?.sortKey; if (!clave) return; if (state.orden.clave === clave) { state.orden.direccion = state.orden.direccion === 'asc' ? 'desc' : 'asc'; } else { state.orden.clave = clave; state.orden.direccion = 'asc'; } renderizarTablaVentas(); }); } document.getElementById('btnPrevPage')?.addEventListener('click', paginaAnterior); document.getElementById('btnNextPage')?.addEventListener('click', paginaSiguiente); document.getElementById('btnPrevPageMobile')?.addEventListener('click', paginaAnterior); document.getElementById('btnNextPageMobile')?.addEventListener('click', paginaSiguiente); }

async function cargarDatosIniciales() { try { mostrarLoading(true); await Promise.all([cargarVentas(), cargarEstadisticas()]); } catch (error) { mostrarError('Error al cargar los datos iniciales'); } finally { mostrarLoading(false); } }

async function cargarVentas() { try { const params = new URLSearchParams(); if (state.filtros.fechaInicio) { params.append('fecha_inicio', state.filtros.fechaInicio); } if (state.filtros.fechaFin) { params.append('fecha_fin', state.filtros.fechaFin); } if (state.filtros.estado) { params.append('estado', state.filtros.estado); } params.append('skip', (state.paginacion.paginaActual - 1) * state.paginacion.elementosPorPagina); params.append('limit', state.paginacion.elementosPorPagina); const url = `/api/ventas?${params.toString()}`; const ventas = await getData(url); state.ventas = Array.isArray(ventas) ? ventas : []; state.paginacion.totalElementos = ((state.paginacion.paginaActual - 1) * state.paginacion.elementosPorPagina) + state.ventas.length; renderizarTablaVentas(); actualizarPaginacion(); } catch (error) { state.ventas = []; state.paginacion.totalElementos = 0; renderizarTablaVentas(); mostrarError('Error al cargar las ventas'); } }

async function cargarEstadisticas() { try { return; } catch (error) {} }

function renderizarTablaVentas() { const tbody = document.getElementById('ventasTableBody'); if (!tbody) return; if (!state.ventas || state.ventas.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500"><div class="flex flex-col items-center"><svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><p class="text-lg font-medium text-gray-900 mb-2">No hay ventas registradas</p><p class="text-sm text-gray-500">Comienza creando tu primera venta</p></div></td></tr>`; return; } const ventasOrdenadas = [...state.ventas]; if (state.orden.clave) { ventasOrdenadas.sort((a, b) => { const dir = state.orden.direccion === 'asc' ? 1 : -1; const va = a[state.orden.clave]; const vb = b[state.orden.clave]; if (state.orden.clave === 'fecha_venta') { const ta = new Date(va).getTime(); const tb = new Date(vb).getTime(); return (ta - tb) * dir; } if (typeof va === 'number' && typeof vb === 'number') { return (va - vb) * dir; } return String(va || '').localeCompare(String(vb || ''), 'es') * dir; }); } tbody.innerHTML = ventasOrdenadas.map(venta => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${venta.id_venta}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatearFecha(venta.fecha_venta)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${venta.usuario || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatearDinero(venta.total_venta)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${venta.detalles_venta ? venta.detalles_venta.length : 0} productos</td><td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${venta.estado === 'completada' ? 'bg-green-100 text-green-800' : (venta.estado === 'cancelada' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800')}">${venta.estado}</span></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><div class="flex items-center justify-end gap-2"><button class="inline-flex items-center px-3 py-1 rounded-md text-sm text-blue-700 bg-blue-100 hover:bg-blue-200" data-action="ver-detalle" data-id="${venta.id_venta}">Ver detalle</button><button class="inline-flex items-center px-3 py-1 rounded-md text-sm text-green-700 bg-green-100 hover:bg-green-200" data-action="completar" data-id="${venta.id_venta}">Marcar completada</button></div></td></tr>`).join(''); try { document.querySelectorAll('button[data-action="entrega"]').forEach(b => b.remove()); } catch {} }

document.getElementById('ventasTableBody')?.addEventListener('click', async (e) => { const btn = e.target.closest('button[data-action]'); if (!btn) return; const action = btn.getAttribute('data-action'); const id = btn.getAttribute('data-id'); if (!id) return; try { if (action === 'ver-detalle') { await cargarDetalleVenta(id); abrirModalDetalleVenta(); } else if (action === 'completar') { await completarVenta(id); await cargarVentas(); } } catch (err) { mostrarError('No se pudo procesar la acción de la venta'); } });

async function cargarDetalleVenta(idVenta) { try { mostrarLoading(true); const venta = await getData(`/api/ventas/${idVenta}`); venta.detalles_venta = Array.isArray(venta.detalles_venta) ? venta.detalles_venta : []; state.ventaDetalleActual = venta; renderDetalleVenta(venta); } catch (error) { mostrarError('No se pudo cargar el detalle de la venta'); throw error; } finally { mostrarLoading(false); } }

async function renderDetalleVenta(venta) { const header = document.getElementById('detalleVentaHeader'); const body = document.getElementById('detalleVentaBody'); const entregaInfo = parseEntregaInfo(venta); if (header) { header.innerHTML = `<div><span class="text-gray-500">Nº venta:</span> <span class="font-medium">${venta.id_venta}</span></div><div><span class="text-gray-500">Fecha:</span> <span class="font-medium">${formatearFecha(venta.fecha_venta)}</span></div><div><span class="text-gray-500">Usuario:</span> <span class="font-medium">${venta.usuario || 'N/A'}</span></div><div><span class="text-gray-500">Total:</span> <span class="font-semibold">${formatearDinero(venta.total_venta)}</span></div>${entregaInfo ? `<div class="col-span-2"><span class="text-gray-500">Entrega:</span> <span class="font-medium">${entregaInfo.tipo}</span> ${entregaInfo.texto_extra || ''}</div>` : ''}`; } if (body) { const filas = (venta.detalles_venta || []).map(d => `<tr><td class="px-4 py-2 text-sm">${d.producto_nombre || `Producto #${d.id_producto}`}</td><td class="px-4 py-2 text-sm">${d.cantidad}</td><td class="px-4 py-2 text-sm">${formatearDinero(d.precio_unitario)}</td><td class="px-4 py-2 text-sm font-medium">${formatearDinero(d.subtotal || (d.precio_unitario * d.cantidad))}</td></tr>`).join(''); body.innerHTML = filas || '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">Sin detalles</td></tr>'; }
  let extra = document.getElementById('detalleVentaExtra'); if (!extra) { extra = document.createElement('div'); extra.id = 'detalleVentaExtra'; extra.className = 'mt-4'; body.parentElement?.appendChild(extra); }
  const cliente = construirDatosCliente(venta); const direccion = construirDireccion(venta); const gps = construirGPS(venta); const tipo = entregaInfo?.tipo || detectarTipoEntrega(venta); const resumenPedido = construirResumenPedido(venta);
  extra.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700"><div><h4 class="font-semibold text-gray-900 mb-1">Datos del Cliente</h4><div>${cliente}</div></div><div><h4 class="font-semibold text-gray-900 mb-1">Tipo de Despacho</h4><div>${tipo || 'N/A'}</div></div><div><h4 class="font-semibold text-gray-900 mb-1">Dirección de Despacho</h4><div id="direccionEntregaText">${direccion || 'N/A'}</div></div><div><h4 class="font-semibold text-gray-900 mb-1">Coordenadas GPS</h4><div id="gpsText">${gps || 'No disponible'}</div></div></div><div class="mt-3 border-t pt-3"><h4 class="font-semibold text-gray-900 mb-2">Resumen del Pedido</h4><div class="text-sm text-gray-700">${resumenPedido}</div></div><div class="mt-3 border-t pt-3"><h4 class="font-semibold text-gray-900 mb-2">Estado de Envío</h4><div class="flex items-center gap-3"><select id="envioEstadoSelect" class="border rounded px-2 py-1 text-sm"><option value="pendiente">pendiente</option><option value="preparando">preparando</option><option value="en camino">en camino</option><option value="entregado">entregado</option></select><button id="envioEstadoGuardar" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Guardar</button></div></div>`;
  const guardarBtn = document.getElementById('envioEstadoGuardar'); const select = document.getElementById('envioEstadoSelect'); try { const estadoActual = parseEnvioEstado(venta); if (estadoActual && select) select.value = estadoActual; } catch {} if (guardarBtn && select) { guardarBtn.onclick = async () => { try { const estado = select.value; await updateData(`/api/ventas/${venta.id_venta}/envio-estado?estado=${encodeURIComponent(estado)}`, {}); mostrarExito('Estado de envío actualizado'); } catch (e) { mostrarError('No se pudo actualizar el estado de envío'); } }; }
  try { const dirEl = document.getElementById('direccionEntregaText'); if (dirEl && (!direccion || direccion === '')) { const tipoEntrega = tipo || detectarTipoEntrega(venta); if (tipoEntrega === 'despacho' && venta.id_usuario) { const dirStr = await obtenerUltimaDireccionUsuario(venta.id_usuario); if (dirStr) dirEl.textContent = dirStr; } } } catch {}
}

function abrirModalDetalleVenta() { const modal = document.getElementById('modalDetalleVenta'); if (modal) modal.style.display = 'flex'; const btnImprimir = document.getElementById('btnImprimirEntrega'); if (btnImprimir) { btnImprimir.onclick = imprimirOrdenEntrega; } }
function cerrarModalDetalleVenta() { const modal = document.getElementById('modalDetalleVenta'); if (modal) modal.style.display = 'none'; }

async function copiarOrdenEntrega() { try { const venta = state.ventaDetalleActual; if (!venta) return; const texto = generarTextoEntrega(venta); await navigator.clipboard.writeText(texto); mostrarExito('Datos de entrega copiados'); try { sessionStorage.setItem('orden_entrega', JSON.stringify(venta)); } catch {} } catch (err) { mostrarError('No se pudo copiar los datos de entrega'); } }
function imprimirOrdenEntrega() { try { const venta = state.ventaDetalleActual; if (!venta) return; const popup = window.open('', '_blank'); if (!popup) { mostrarError('Bloqueador de ventanas impide imprimir'); return; } const contenido = `<html><head><title>Guía de Entrega #${venta.id_venta}</title><style>body{font-family:sans-serif;padding:20px} h1{font-size:18px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px;text-align:left} th{background:#f3f4f6}</style></head><body><h1>Guía de Entrega - Venta #${venta.id_venta}</h1><p><strong>Fecha:</strong> ${formatearFecha(venta.fecha_venta)}<br/><strong>Usuario:</strong> ${venta.usuario || 'N/A'}<br/><strong>Total:</strong> ${formatearDinero(venta.total_venta)}</p><table><thead><tr><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>${(venta.detalles_venta || []).map(d => `<tr><td>${d.producto_nombre || `Producto #${d.id_producto}`}</td><td>${d.cantidad}</td><td>${formatearDinero(d.precio_unitario)}</td><td>${formatearDinero(d.subtotal || (d.precio_unitario * d.cantidad))}</td></tr>`).join('')}</tbody></table></body></html>`; popup.document.write(contenido); popup.document.close(); popup.focus(); popup.print(); } catch (err) { mostrarError('No se pudo imprimir la guía de entrega'); } }

function generarTextoEntrega(venta) { const lineas = []; lineas.push(`Orden de Entrega - Venta #${venta.id_venta}`); lineas.push(`Fecha: ${formatearFecha(venta.fecha_venta)}`); lineas.push(`Usuario: ${venta.usuario || 'N/A'}`); lineas.push(`Total: ${formatearDinero(venta.total_venta)}`); lineas.push('Detalles:'); (venta.detalles_venta || []).forEach(d => { lineas.push(`- ${d.producto_nombre || `Producto #${d.id_producto}`} x${d.cantidad} (${formatearDinero(d.precio_unitario)} c/u)`); }); return lineas.join('\n'); }
window.cerrarModalDetalleVenta = cerrarModalDetalleVenta;

function aplicarFiltros() { state.filtros.fechaInicio = document.getElementById('filtroFechaInicio').value || null; state.filtros.fechaFin = document.getElementById('filtroFechaFin').value || null; state.filtros.estado = document.getElementById('filtroEstado')?.value || null; state.paginacion.paginaActual = 1; cargarVentas(); cargarEstadisticas(); }
function limpiarFiltros() { document.getElementById('filtroFechaInicio').value = ''; document.getElementById('filtroFechaFin').value = ''; document.getElementById('filtroEstado') && (document.getElementById('filtroEstado').value = ''); state.filtros = { fechaInicio: null, fechaFin: null, estado: null }; state.paginacion.paginaActual = 1; cargarVentas(); cargarEstadisticas(); }
function buscarVentas() { const input = document.getElementById('buscarVenta') || document.getElementById('inputBusqueda'); const termino = (input?.value || '').toLowerCase(); if (!termino) { renderizarTablaVentas(); return; } const ventasFiltradas = state.ventas.filter(venta => (venta.id_venta?.toString() || '').includes(termino) || ((venta.usuario || '').toLowerCase()).includes(termino) || String(venta.total_venta).includes(termino)); const tbody = document.getElementById('ventasTableBody'); if (ventasFiltradas.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center"><i class="fas fa-search"></i>No se encontraron ventas que coincidan con "${termino}"</td></tr>`; return; } tbody.innerHTML = ventasFiltradas.map(venta => `<tr><td>#${venta.id_venta}</td><td>${formatearFecha(venta.fecha_venta)}</td><td>${venta.usuario || 'N/A'}</td><td>$${Number(venta.total_venta).toFixed(2)}</td><td>${venta.detalles_venta ? venta.detalles_venta.length : 0} productos</td><td><span class="estado-${venta.estado.toLowerCase()}">${venta.estado}</span></td><td></td></tr>`).join(''); }

function paginaAnterior() { if (state.paginacion.paginaActual > 1) { state.paginacion.paginaActual--; cargarVentas(); } }
function paginaSiguiente() { const totalPaginas = Math.ceil(state.paginacion.totalElementos / state.paginacion.elementosPorPagina); if (state.paginacion.paginaActual < totalPaginas) { state.paginacion.paginaActual++; cargarVentas(); } }
function actualizarPaginacion() { const mostrandoDesde = document.getElementById('mostrandoDesde'); const mostrandoHasta = document.getElementById('mostrandoHasta'); const totalRegistros = document.getElementById('totalRegistros'); if (mostrandoDesde) { const desde = (state.paginacion.paginaActual - 1) * state.paginacion.elementosPorPagina + 1; const hasta = (state.paginacion.paginaActual - 1) * state.paginacion.elementosPorPagina + state.ventas.length; mostrandoDesde.textContent = state.ventas.length > 0 ? desde : 0; mostrandoHasta.textContent = state.ventas.length > 0 ? hasta : 0; } if (totalRegistros) { totalRegistros.textContent = state.paginacion.totalElementos; } const btnPrevPage = document.getElementById('btnPrevPage'); const btnNextPage = document.getElementById('btnNextPage'); const hasPrevPage = state.paginacion.paginaActual > 1; const hasNextPage = state.ventas.length === state.paginacion.elementosPorPagina; if (btnPrevPage) { btnPrevPage.disabled = !hasPrevPage; btnPrevPage.classList.toggle('opacity-50', !hasPrevPage); btnPrevPage.classList.toggle('cursor-not-allowed', !hasPrevPage); } if (btnNextPage) { btnNextPage.disabled = !hasNextPage; btnNextPage.classList.toggle('opacity-50', !hasNextPage); btnNextPage.classList.toggle('cursor-not-allowed', !hasNextPage); } const pageNumbers = document.getElementById('pageNumbers'); if (pageNumbers) { pageNumbers.textContent = state.paginacion.paginaActual; } }

function formatearFecha(fecha) { return new Date(fecha).toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }
function mostrarLoading(mostrar) { const overlay = document.getElementById('loadingOverlay'); if (overlay) { overlay.style.display = mostrar ? 'flex' : 'none'; } }
function mostrarError(mensaje) { mostrarErrorToast(mensaje); }
function mostrarExito(mensaje) { alert('Éxito: ' + mensaje); }
window.exportarVentasCSV = exportarVentasCSV;
function formatearDinero(valor) { try { const num = Number(valor || 0); return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(num); } catch { return `$${Number(valor || 0).toFixed(2)}`; } }
function debounce(fn, delay) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); }; }
function exportarVentasCSV() { try { const filas = state.ventas.map(v => ({ ID: v.id_venta, Fecha: v.fecha_venta, Usuario: v.usuario || '', Total: v.total_venta, Estado: v.estado || '', Productos: Array.isArray(v.detalles_venta) ? v.detalles_venta.length : 0 })); const encabezados = Object.keys(filas[0] || { ID: '', Fecha: '', Usuario: '', Total: '', Estado: '', Productos: '' }); const csv = [encabezados.join(','), ...filas.map(row => encabezados.map(h => JSON.stringify(row[h] ?? '')).join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ventas_${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } catch (e) { mostrarError('No se pudo exportar el CSV'); } }
function parseEntregaInfo(venta) { try { const obs = String(venta.observaciones || ''); const tag = 'VENTA_INVITADO:'; const idx = obs.indexOf(tag); if (idx >= 0) { const jsonStr = obs.slice(idx + tag.length).trim(); const info = JSON.parse(jsonStr); const tipo = info?.entrega || 'retiro'; let texto = ''; if (tipo === 'despacho' && info?.direccion) { const d = info.direccion; texto = `- ${d.calle || ''} ${d.numero || ''} ${d.depto ? ('(' + d.depto + ')') : ''}`; } return { tipo, texto_extra: texto, raw: info }; } const lower = obs.toLowerCase(); if (lower.includes('retiro')) return { tipo: 'retiro', texto_extra: '' }; if (lower.includes('despacho')) return { tipo: 'despacho', texto_extra: '' }; return null; } catch { return null; } }
function parseEnvioEstado(venta) { try { const obs = String(venta.observaciones || ''); const tag = 'ENVIO_ESTADO:'; const idx = obs.indexOf(tag); if (idx >= 0) { const rest = obs.slice(idx + tag.length).trim(); const linea = rest.split('\n')[0].trim(); const val = linea.toLowerCase(); if (['pendiente','preparando','en camino','entregado'].includes(val)) return val; } return null; } catch { return null; } }
function detectarTipoEntrega(venta) { const e = parseEntregaInfo(venta); return e?.tipo || null; }
function construirDatosCliente(venta) { try { const e = parseEntregaInfo(venta); if (e?.raw) { const g = e.raw; return `Nombre: ${g.nombre || 'N/A'}<br/>RUT: ${g.rut || 'N/A'}<br/>Email: ${g.email || 'N/A'}<br/>Teléfono: ${g.telefono || 'N/A'}`; } return `Usuario: ${venta.usuario || 'N/A'}`; } catch { return 'N/A'; } }
function construirDireccion(venta) { try { const e = parseEntregaInfo(venta); if (e?.raw?.direccion) { const d = e.raw.direccion; return `${d.calle || ''} ${d.numero || ''} ${d.depto ? ('(' + d.depto + ')') : ''} ${d.adicional || ''}`.trim(); } return ''; } catch { return ''; } }
function construirGPS(venta) { try { return ''; } catch { return ''; } }
function construirResumenPedido(venta) { try { const dets = Array.isArray(venta.detalles_venta) ? venta.detalles_venta : []; const items = dets.reduce((acc, d) => acc + Number(d.cantidad || 0), 0); const filas = dets.slice(0, 5).map(d => `${d.producto_nombre || `Producto #${d.id_producto}`} x${d.cantidad}`).join(', '); return `Items: ${items}. ${filas}${dets.length > 5 ? '…' : ''}`; } catch { return ''; } }
async function obtenerUltimaDireccionUsuario(idUsuario) { try { const dirs = await getData(`/api/despachos/usuario/${idUsuario}`); const arr = Array.isArray(dirs) ? dirs : []; const last = arr[arr.length - 1]; if (!last) return ''; const d = last; return `${d.calle || ''} ${d.numero || ''} ${d.depto ? ('(' + d.depto + ')') : ''} ${d.adicional || ''}`.trim(); } catch { return ''; } }
async function completarVenta(idVenta) { try { const venta = state.ventaDetalleActual || await getData(`/api/ventas/${idVenta}`); const entrega = parseEntregaInfo(venta); const metodo = entrega?.tipo || null; const url = `/api/ventas/${idVenta}/completar${metodo ? (`?metodo=${encodeURIComponent(metodo)}`) : ''}`; await updateData(url, {}); mostrarExito('Venta marcada como completada'); cerrarModalDetalleVenta(); } catch (e) { mostrarError('No se pudo marcar como completada'); } }
    </script>
</AdminLayout>

<style>
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .admin-header h1 {
        color: #2c3e50;
        margin: 0;
        font-size: 2rem;
    }

    .admin-header h1 i {
        color: #3498db;
        margin-right: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    /* Filtros */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }

    /* Estadísticas */
    .stats-section {
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        background: linear-gradient(135deg, #3498db, #2980b9);
    }

    .stat-content h3 {
        margin: 0;
        font-size: 1.8rem;
        color: #2c3e50;
    }

    .stat-content p {
        margin: 5px 0 0 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    /* Tabla */
    .table-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h2 {
        margin: 0;
        color: #2c3e50;
    }

    .search-box {
        position: relative;
        width: 300px;
    }

    .search-box input {
        padding-right: 40px;
    }

    .search-box i {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #7f8c8d;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table {
        margin: 0;
        width: 100%;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 15px;
    }

    .table td {
        padding: 12px 15px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Estados */
    .estado-activa {
        background-color: #d4edda;
        color: #155724;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .estado-cancelada {
        background-color: #f8d7da;
        color: #721c24;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Paginación */
    .pagination-container {
        padding: 20px;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .page-numbers {
        display: flex;
        gap: 5px;
    }

    /* Modal específico para ventas */
    .modal-lg {
        max-width: 900px;
    }

    .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .form-section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .productos-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .agregar-producto {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .productos-agregados {
        margin-bottom: 20px;
    }

    .venta-total {
        text-align: right;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        border: 2px solid #3498db;
    }

    .total-row {
        font-size: 1.3rem;
        color: #2c3e50;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
    }

    .loading-spinner i {
        font-size: 2rem;
        color: #3498db;
        margin-bottom: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .admin-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .header-actions {
            width: 100%;
            justify-content: center;
        }

        .filters-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .table-header {
            flex-direction: column;
            gap: 15px;
        }

        .search-box {
            width: 100%;
        }

        .pagination-container {
            flex-direction: column;
            gap: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
<script>
(function(){
  try {
    const env = window.__ENV__ || {};
    const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
    if (!window.API_BASE) window.API_BASE = api;
    if (!window.__API_BASE_LOGGED__) { console.log('Cargando script de login...'); console.log('API URL es:', window.API_BASE); window.__API_BASE_LOGGED__ = true; }
  } catch {}
})();
</script>
