---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Gestión de Categorías">
	<div class="mb-6 flex justify-end items-center">
		<button id="btnNuevaCategoria" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
			</svg>
			Nueva Categoría
		</button>
	</div>

	<!-- Filtros -->
	<div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
		<div>
			<label for="filtroNombre" class="block text-sm font-medium text-gray-700">Buscar por nombre</label>
			<input type="text" id="filtroNombre" placeholder="Nombre de la categoría" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
		</div>
		<div class="flex items-end space-x-2">
			<button id="btnBuscar" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				Buscar
			</button>
		</div>
	</div>

	<!-- Tabla de categorías -->
	<div class="bg-white shadow overflow-hidden sm:rounded-md">
		<div class="overflow-x-auto">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-gray-50">
					<tr>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
						<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
					</tr>
				</thead>
				<tbody id="tablaCategorias" class="bg-white divide-y divide-gray-200">
					<!-- Las categorías se cargarán aquí dinámicamente -->
				</tbody>
			</table>
		</div>
	</div>

	<!-- Paginación -->
	<div id="paginacion" class="mt-6 flex justify-center">
		<!-- La paginación se generará dinámicamente -->
	</div>

		<!-- Modal para nueva/editar categoría -->
		<div id="modalCategoria" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
			<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
				<div class="mt-3">
					<div class="flex justify-between items-center mb-4">
						<h3 id="tituloModal" class="text-lg font-medium text-gray-900">Nueva Categoría</h3>
						<button id="btnCerrarModal" class="text-gray-400 hover:text-gray-600">
							<i class="fas fa-times"></i>
						</button>
					</div>
					<form id="formCategoria">
						<input type="hidden" id="categoriaId">
						<div class="mb-4">
							<label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
							<input type="text" id="nombre" name="nombre" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
						</div>
						<div class="mb-4">
							<label for="descripcion" class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
							<textarea id="descripcion" name="descripcion" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
						</div>
						<div class="flex justify-end space-x-2">
							<button type="button" id="btnCancelar" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
								Cancelar
							</button>
							<button type="submit" id="btnGuardar" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
								Guardar
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Modal de confirmación para eliminar -->
		<div id="modalConfirmar" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
			<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
				<div class="mt-3 text-center">
					<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
						<i class="fas fa-exclamation-triangle text-red-600"></i>
					</div>
					<h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmar eliminación</h3>
					<div class="mt-2 px-7 py-3">
						<p class="text-sm text-gray-500">¿Está seguro que desea eliminar esta categoría? Esta acción no se puede deshacer.</p>
					</div>
					<div class="flex justify-center space-x-2 mt-4">
						<button id="btnCancelarEliminar" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
							Cancelar
						</button>
						<button id="btnConfirmarEliminar" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
							Eliminar
						</button>
					</div>
				</div>
			</div>
		</div>
	</main>

    <script type="module">
    function buildUrl(endpoint){const base=(window.API_BASE||'/api');if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
    async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
    async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function postData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function updateData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
    async function deleteData(endpoint){const r=await fetchWithAuth(endpoint,{method:'DELETE',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}

    let categorias = [];
    let categoriasFiltradas = null;
    let paginaActual = 1;
    const itemsPorPagina = 10;
    let categoriaAEliminar = null;

    let tablaCategorias, modalCategoria, modalConfirmar, formCategoria;
    let btnNuevaCategoria, btnCerrarModal, btnCancelar, btnBuscar;
    let btnCancelarEliminar, btnConfirmarEliminar, filtroNombre;

    document.addEventListener('DOMContentLoaded', function() {
        tablaCategorias = document.getElementById('tablaCategorias');
        modalCategoria = document.getElementById('modalCategoria');
        modalConfirmar = document.getElementById('modalConfirmar');
        formCategoria = document.getElementById('formCategoria');
        btnNuevaCategoria = document.getElementById('btnNuevaCategoria');
        btnCerrarModal = document.getElementById('btnCerrarModal');
        btnCancelar = document.getElementById('btnCancelar');
        btnBuscar = document.getElementById('btnBuscar');
        btnCancelarEliminar = document.getElementById('btnCancelarEliminar');
        btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
        filtroNombre = document.getElementById('filtroNombre');

        btnNuevaCategoria.addEventListener('click', abrirModalNueva);
        btnCerrarModal.addEventListener('click', cerrarModal);
        btnCancelar.addEventListener('click', cerrarModal);
        btnBuscar.addEventListener('click', buscarCategorias);
        btnCancelarEliminar.addEventListener('click', cerrarModalConfirmar);
        btnConfirmarEliminar.addEventListener('click', confirmarEliminar);
        formCategoria.addEventListener('submit', guardarCategoria);

        if (!verificarAuth()) return;
        cargarCategorias();
    });

    async function cargarCategorias() {
        try {
            categorias = await getData(`/api/categorias/?_=${Date.now()}`);
            categoriasFiltradas = null;
            mostrarCategorias();
        } catch (error) {
            console.error('Error al cargar categorías:', error);
            alert('Error en conexión del servidor');
        }
    }

    function mostrarCategorias() {
        const base = categoriasFiltradas ?? categorias;
        const inicio = (paginaActual - 1) * itemsPorPagina;
        const fin = inicio + itemsPorPagina;
        const categoriasPagina = base.slice(inicio, fin);

        tablaCategorias.innerHTML = '';

        if (categoriasPagina.length === 0) {
            tablaCategorias.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                        No se encontraron categorías
                    </td>
                </tr>
            `;
            return;
        }

        categoriasPagina.forEach(categoria => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${categoria.id_categoria}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${categoria.nombre}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${categoria.descripcion || 'Sin descripción'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editarCategoria(${categoria.id_categoria})" class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="eliminarCategoria(${categoria.id_categoria})" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </td>
            `;
            tablaCategorias.appendChild(fila);
        });

        generarPaginacion(base.length);
    }

    function generarPaginacion(totalItems) {
        const totalPaginas = Math.ceil(totalItems / itemsPorPagina);
        const paginacion = document.getElementById('paginacion');

        if (totalPaginas <= 1) {
            paginacion.innerHTML = '';
            return;
        }

        let html = '';

        if (paginaActual > 1) {
            html += `<button onclick="cambiarPagina(${paginaActual - 1})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l">Anterior</button>`;
        }

        for (let i = 1; i <= totalPaginas; i++) {
            const clase = i === paginaActual ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400 text-gray-800';
            html += `<button onclick="cambiarPagina(${i})" class="${clase} font-bold py-2 px-4">${i}</button>`;
        }

        if (paginaActual < totalPaginas) {
            html += `<button onclick="cambiarPagina(${paginaActual + 1})" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r">Siguiente</button>`;
        }

        paginacion.innerHTML = html;
    }

    function cambiarPagina(pagina) {
        paginaActual = pagina;
        mostrarCategorias();
    }

    function abrirModalNueva() {
        document.getElementById('tituloModal').textContent = 'Nueva Categoría';
        formCategoria.reset();
        document.getElementById('categoriaId').value = '';
        modalCategoria.classList.remove('hidden');
    }

    function editarCategoria(id) {
        const categoria = categorias.find(c => c.id_categoria === id);
        if (categoria) {
            document.getElementById('tituloModal').textContent = 'Editar Categoría';
            document.getElementById('categoriaId').value = categoria.id_categoria;
            document.getElementById('nombre').value = categoria.nombre;
            document.getElementById('descripcion').value = categoria.descripcion || '';
            modalCategoria.classList.remove('hidden');
        }
    }

    function eliminarCategoria(id) {
        categoriaAEliminar = id;
        modalConfirmar.classList.remove('hidden');
    }

    window.editarCategoria = editarCategoria;
    window.eliminarCategoria = eliminarCategoria;
    window.cambiarPagina = cambiarPagina;

    function cerrarModal() {
        modalCategoria.classList.add('hidden');
    }

    function cerrarModalConfirmar() {
        modalConfirmar.classList.add('hidden');
        categoriaAEliminar = null;
    }

    async function guardarCategoria(e) {
        e.preventDefault();

        const id = document.getElementById('categoriaId').value;
        const nombre = document.getElementById('nombre').value;
        const descripcion = document.getElementById('descripcion').value;

        const datos = { nombre, descripcion };

        try {
            if (id) {
                await updateData(`/api/categorias/${id}`, datos);
                alert('Categoría actualizada exitosamente');
            } else {
                await postData('/api/categorias/', datos);
                alert('Categoría creada exitosamente');
            }
            cerrarModal();
            await cargarCategorias();
        } catch (error) {
            console.error('Error:', error);
            alert('Error en conexión del servidor');
        }
    }

    async function confirmarEliminar() {
        if (!categoriaAEliminar) return;
        try {
            await deleteData(`/api/categorias/${categoriaAEliminar}`);
            alert('Categoría eliminada exitosamente');
            cerrarModalConfirmar();
            await cargarCategorias();
        } catch (error) {
            console.error('Error al eliminar categoría:', error);
            let msg = 'Error al eliminar categoría';
            const txt = String(error && error.message ? error.message : '');
            if (/Error\s+401/.test(txt) || /Error\s+403/.test(txt)) {
                alert('No autorizado. Inicie sesión como administrador.');
                window.location.href = '/login?tipo=trabajador';
                return;
            }
            try {
                const jsonStr = txt.replace(/^Error\s+\d+:\s+/, '');
                const data = JSON.parse(jsonStr);
                if (data && data.detail) {
                    msg = typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail);
                }
            } catch {}
            alert(msg);
        }
    }

    function buscarCategorias() {
        const filtro = filtroNombre.value.toLowerCase();
        if (filtro) {
            const base = categorias;
            categoriasFiltradas = base.filter(categoria => 
                String(categoria.nombre || '').toLowerCase().includes(filtro)
            );
        } else {
            categoriasFiltradas = null;
        }
        paginaActual = 1;
        mostrarCategorias();
    }

    function verificarAuth() {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token') || localStorage.getItem('access_token');
        const isLoggedIn = sessionStorage.getItem('isLoggedIn') || localStorage.getItem('isLoggedIn');
        if (!token || isLoggedIn !== 'true') {
            window.location.href = '/login?tipo=trabajador';
            return false;
        }
        return true;
    }
    </script>
</AdminLayout>
<script>
(function(){
  try {
    const env = window.__ENV__ || {};
    const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
    if (!window.API_BASE) window.API_BASE = api;
    if (!window.__API_BASE_LOGGED__) { console.log('Cargando script de login...'); console.log('API URL es:', window.API_BASE); window.__API_BASE_LOGGED__ = true; }
  } catch {}
})();
</script>
