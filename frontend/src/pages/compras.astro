---
import Layout from '../layouts/Layout.astro';
import EnvLoader from '../components/EnvLoader.astro';
---

<EnvLoader />
<Layout title="Mis compras - Ferretería Patricio">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Mis compras</h1>

    <div id="estadoCuenta" class="mb-4 text-sm text-gray-700"></div>

    <div id="comprasSection" class="bg-white rounded-lg shadow p-6">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="comprasBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
      <div id="comprasEmpty" class="hidden text-gray-500 text-sm">No tienes compras registradas.</div>
    </div>

    <!-- Detalle de compra -->
    <div id="detalleWrapper" class="mt-8 hidden">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800">Detalle de la compra</h2>
          <button id="cerrarDetalle" class="text-gray-600 hover:text-gray-900">&times;</button>
        </div>
        <div id="detalleHeader" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 text-sm text-gray-700"></div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio unitario</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
              </tr>
            </thead>
            <tbody id="detalleBody" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const url = new URL(window.location.href);
        const paid = url.searchParams.get('paid');
        if (paid === '1') {
          try {
            localStorage.removeItem('carrito');
            localStorage.removeItem('checkout_items');
            localStorage.removeItem('checkoutEntrega');
          } catch {}
          try { window.dispatchEvent(new Event('carrito:changed')); } catch {}
        }
      } catch {}
      const estadoCuenta = document.getElementById('estadoCuenta');
      const comprasBody = document.getElementById('comprasBody');
      const comprasEmpty = document.getElementById('comprasEmpty');
      const detalleWrapper = document.getElementById('detalleWrapper');
      const detalleHeader = document.getElementById('detalleHeader');
      const detalleBody = document.getElementById('detalleBody');
      const cerrarDetalle = document.getElementById('cerrarDetalle');

      const fmtPrecio = (v) => {
        const n = Number(v || 0);
        return '$' + n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      };
      const fmtFecha = (iso) => {
        try {
          const d = new Date(iso);
          // Mostrar solo la fecha, sin hora
          return d.toLocaleDateString('es-CL', { dateStyle: 'medium' });
        } catch { return iso; }
      };

      const getApiBase = () => {
        try {
          const env = window.__ENV__ || {};
          return env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
        } catch { return '/api'; }
      };

      const getUserId = () => {
        try {
          const raw = localStorage.getItem('user');
          const u = raw ? JSON.parse(raw) : null;
          return (u && (u.id_usuario || u.id || u.idUsuario)) || null;
        } catch { return null; }
      };

      // Cache simple para no repetir solicitudes de producto
      const productoCache = {};
      const getProductoInfo = async (id) => {
        if (!id) return { nombre: `Producto`, imagen_url: '/images/default-product.jpg' };
        if (productoCache[id]) return productoCache[id];
        const API = getApiBase();
        try {
          const resp = await fetch(`${API}/productos/${id}`);
          if (resp.ok) {
            const p = await resp.json();
            const info = { nombre: p.nombre || `Producto #${id}`, imagen_url: p.imagen_url || '/images/default-product.jpg' };
            productoCache[id] = info;
            return info;
          }
        } catch (e) {
          console.warn('No se pudo obtener producto', id, e);
        }
        const fallback = { nombre: `Producto #${id}`, imagen_url: '/images/default-product.jpg' };
        productoCache[id] = fallback;
        return fallback;
      };

      const renderCompras = (ventas) => {
        if (!Array.isArray(ventas) || ventas.length === 0) {
          comprasBody.innerHTML = '';
          comprasEmpty.classList.remove('hidden');
          return;
        }
        comprasEmpty.classList.add('hidden');
        comprasBody.innerHTML = ventas.map((v, i) => `
          <tr>
            <td class="px-4 py-3 text-sm text-gray-800">${i + 1}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${fmtFecha(v.fecha_venta)}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-1 rounded text-white ${v.estado === 'completada' ? 'bg-green-600' : (v.estado === 'cancelada' ? 'bg-red-600' : 'bg-yellow-500')}">${v.estado}</span>
            </td>
            <td class="px-4 py-3 text-sm font-semibold">${fmtPrecio(v.total_venta)}</td>
            <td class="px-4 py-3 text-sm">
              <button class="text-blue-600 hover:text-blue-800" data-id="${v.id_venta}" data-src="${v.__local ? 'local' : 'api'}" data-action="ver-detalle">Ver detalle</button>
            </td>
          </tr>
        `).join('');
      };

      const renderDetalle = async (venta) => {
        detalleHeader.innerHTML = `
          <div><span class="text-gray-500">Nº venta:</span> <span class="font-medium">${venta.id_venta}</span></div>
          <div><span class="text-gray-500">Fecha:</span> <span class="font-medium">${fmtFecha(venta.fecha_venta)}</span></div>
          <div><span class="text-gray-500">Estado:</span> <span class="font-medium">${venta.estado}</span></div>
          <div><span class="text-gray-500">Total:</span> <span class="font-semibold">${fmtPrecio(venta.total_venta)}</span></div>
        `;
        const detalles = Array.isArray(venta.detalles_venta) ? venta.detalles_venta : [];
        const filas = [];
        for (const d of detalles) {
          // Primero usamos el nombre entregado por el backend si está
          let nombre = d.producto_nombre || null;
          let imagen = null;
          if (!nombre || !imagen) {
            const info = await getProductoInfo(d.id_producto);
            nombre = nombre || info.nombre;
            imagen = info.imagen_url;
          }
          filas.push(`
            <tr>
              <td class="px-4 py-3 text-sm">
                <div class="flex items-center gap-3">
                  <img src="${imagen}" alt="${nombre}" class="w-10 h-10 rounded object-cover border" />
                  <div class="text-gray-800">${nombre}</div>
                </div>
              </td>
              <td class="px-4 py-3 text-sm">${d.cantidad}</td>
              <td class="px-4 py-3 text-sm">${fmtPrecio(d.precio_unitario)}</td>
              <td class="px-4 py-3 text-sm font-medium">${fmtPrecio(d.subtotal)}</td>
            </tr>
          `);
        }
        detalleBody.innerHTML = filas.join('');
        detalleWrapper.classList.remove('hidden');
      };

      cerrarDetalle && cerrarDetalle.addEventListener('click', () => {
        detalleWrapper.classList.add('hidden');
      });

      const getPendientesLocal = () => {
        try {
          const list = JSON.parse(localStorage.getItem('ventas_pendientes') || '[]');
          return Array.isArray(list) ? list.map(v => ({ ...v, __local: true })) : [];
        } catch { return []; }
      };

      const init = async () => {
        const idUsuario = getUserId();
        if (!idUsuario) {
          estadoCuenta.innerHTML = 'Debes iniciar sesión para ver tus compras. <a href="/login" class="text-blue-600 hover:text-blue-800">Inicia sesión aquí</a>.';
          return;
        }
        estadoCuenta.textContent = '';
        const API = getApiBase();
        try {
          // Eliminar ventas pendientes guardadas localmente
          try { localStorage.removeItem('ventas_pendientes'); } catch {}
          const resp = await fetch(`${API}/ventas/usuario/${idUsuario}?limit=100`);
          let ventasApi = [];
          if (resp.ok) {
            ventasApi = await resp.json();
          } else {
            console.warn('No se pudieron cargar las compras del backend, mostrando pendientes locales');
          }
          // Mostrar únicamente las ventas del backend
          renderCompras(ventasApi);
        } catch (err) {
          comprasBody.innerHTML = '';
          comprasEmpty.classList.remove('hidden');
          console.error(err);
        }
      };

      comprasBody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action="ver-detalle"]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const src = btn.getAttribute('data-src') || 'api';
        const API = getApiBase();
        if (src === 'local') {
          const list = getPendientesLocal();
          const venta = list.find(v => String(v.id_venta) === String(id));
          if (venta) {
            await renderDetalle(venta);
          }
          return;
        }
        try {
          const resp = await fetch(`${API}/ventas/${id}`);
          if (!resp.ok) throw new Error('No se pudo cargar el detalle');
          const venta = await resp.json();
          await renderDetalle(venta);
        } catch (err) {
          console.error(err);
          alert('No se pudo cargar el detalle de la compra');
        }
      });

      init();
    });
  </script>
</Layout>