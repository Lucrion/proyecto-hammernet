---
import Layout from '../layouts/Layout.astro';
import EnvLoader from '../components/EnvLoader.astro';
---

<EnvLoader />
<Layout title="Detalle Orden de Compra">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">Detalle Orden de Compra</h1>
    <div id="estado" class="mb-3 text-gray-700"></div>
    <div id="orden" class="mb-2 text-sm text-gray-600"></div>
    <div id="resumen" class="bg-white rounded shadow p-4 mb-6 hidden">
      <p id="ventaInfo" class="mb-2"></p>
      <p id="clienteInfo" class="mb-2"></p>
      <p id="totalInfo" class="font-semibold"></p>
    </div>
    <div id="items" class="bg-white rounded shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Productos</h2>
      <ul id="itemsList" class="list-disc pl-5"></ul>
    </div>
    <div id="acciones" class="mt-6 flex flex-col sm:flex-row gap-3">
      <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded text-center">Volver al inicio</a>
    </div>
  </div>
  <script type="module">
    (async function(){
      async function ensureApiBase(){
        try{
          const urlParam=new URLSearchParams(window.location.search).get('api');
          if(urlParam) window.API_BASE=urlParam;
          const base=window.API_BASE|| (window.__ENV__?.PUBLIC_API_URL || window.__ENV__?.PUBLIC_API_URL_PRODUCTION || '/api');
          try{ const r=await fetch(String(base).replace(/\/$/,'') + '/health',{method:'GET'}); if(r&&r.ok){ window.API_BASE=base; return; } }catch(e){}
          try{ const host=window.location.hostname||''; if(/\.onrender\.com$/.test(host)){ const alt=`https://${host.replace(/(\.onrender\.com)$/,'-backend$1')}/api`; const r2=await fetch(alt + '/health',{method:'GET'}); if(r2&&r2.ok){ window.API_BASE=alt; return; } } }catch(e){}
        }catch(e){}
      }
      await ensureApiBase();
      const API_BASE = window.API_BASE || '/api';
      const u = new URL(window.location.href);
      const bo = u.searchParams.get('bo')||'';
      const estado = document.getElementById('estado');
      const orden = document.getElementById('orden');
      const resumen = document.getElementById('resumen');
      const ventaInfo = document.getElementById('ventaInfo');
      const clienteInfo = document.getElementById('clienteInfo');
      const totalInfo = document.getElementById('totalInfo');
      const itemsBox = document.getElementById('items');
      const itemsList = document.getElementById('itemsList');
      const jsonBox = document.getElementById('json');
      const verCompras = document.getElementById('verCompras');
      const show=(el)=>el.classList.remove('hidden');
      orden.textContent = bo ? `Orden: ${bo}` : '';
      if (!bo) {
        estado.textContent='Orden no proporcionada';
        try { verCompras.href = '/compras'; } catch(e){}
        return;
      }
      estado.textContent='Cargando detalle...';
      fetch(`${API_BASE}/ventas/orden/${encodeURIComponent(bo)}`,{ headers:{ 'Accept':'application/json' }})
        .then(r=>{ if(!r.ok) throw new Error('No encontrada'); return r.json(); })
        .then(data=>{
          estado.textContent='Compra encontrada';
          const fecha = data?.fecha_venta ? new Date(data.fecha_venta).toLocaleString() : '';
          ventaInfo.textContent = `Venta #${data?.id_venta || ''} · Fecha: ${fecha}`;
          let cliente = data?.usuario_rut || data?.rut_usuario || '';
          // Intentar obtener rut invitado desde observaciones
          try {
            if ((!cliente || cliente === 'Invitado') && typeof data?.observaciones === 'string' && data.observaciones.includes('VENTA_INVITADO:')) {
              const payload = data.observaciones.split('VENTA_INVITADO:',1)[1].trim();
              const info = JSON.parse(payload);
              cliente = info?.rut || cliente;
            }
          } catch(e){}
          clienteInfo.textContent = `Cliente: ${cliente || 'Invitado'}`;
          totalInfo.textContent = `Total: $${Number(data?.total_venta||0).toLocaleString('es-CL')}`;
          show(resumen);
          const detalles = data?.detalles_venta || [];
          itemsList.innerHTML = '';
          detalles.forEach(d=>{
            const li = document.createElement('li');
            const nombre = d?.producto_nombre || `ID ${d?.id_producto}`;
            li.textContent = `${nombre} · Cant: ${d?.cantidad} · Subtotal: $${Number(d?.subtotal||0).toLocaleString('es-CL')}`;
            itemsList.appendChild(li);
          });
          show(itemsBox);
          jsonBox.textContent = JSON.stringify(data,null,2);
          show(jsonBox);
          try { verCompras.href = `/compras?bo=${encodeURIComponent(bo)}`; sessionStorage.setItem('guest_order_bo', bo); localStorage.setItem('guest_order_bo', bo); } catch(e){}
        })
        .catch((e)=>{ estado.textContent='Orden no encontrada'; });
    })();
  </script>
</Layout>
