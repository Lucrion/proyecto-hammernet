---
import EnvLoader from '../components/EnvLoader.astro';
 
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Crear cuenta - Ferretería Patricio</title>
    <EnvLoader />
    
  </head>
  <body class="min-h-screen bg-gray-100">
    <div class="min-h-screen flex">
      <!-- Botón de retorno -->
      <button type="button" class="absolute top-6 left-6 text-gray-600 hover:text-gray-900 transition-colors duration-200" aria-label="Volver" onclick="(history.length>1?history.back():location.href='/')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </button>

      <!-- Sección formulario registro -->
      <div class="w-full max-w-md mx-auto py-12">
        <div class="flex justify-center mb-8">
          <img src="/images/logos/hammernet.webp" alt="Hammernet" class="h-20" />
        </div>

        <h2 class="text-2xl font-semibold text-gray-900 mb-8">Crear cuenta</h2>

        <form id="registerForm" class="space-y-6">
          <div class="space-y-4">
            <div>
              <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
              <input id="nombre" name="nombre" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Tu nombre" />
            </div>
            <div>
              <label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
              <input id="apellido" name="apellido" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Tu apellido" />
            </div>
            <div>
              <label for="rut" class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
              <input id="rut" name="rut" type="text" maxlength="12" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" inputmode="numeric" placeholder="20.347.793-7" />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
              <input id="email" name="email" type="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="tu@correo.com" />
            </div>
            <div>
              <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
              <div class="flex">
                <span class="px-4 py-2 bg-gray-100 border border-r-0 rounded-l text-gray-700 select-none">+569</span>
                <input id="telefono" name="telefono" type="tel" required class="w-full px-3 py-2 border border-gray-300 rounded-r shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: 91234567" />
              </div>
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
              <input id="password" name="password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="****************" />
            </div>
            <div>
              <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">Confirmar contraseña</label>
              <input id="confirm_password" name="confirm_password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="****************" />
            </div>
          </div>

          <div>
            <button id="registerButton" type="submit" class="w-full px-4 py-2 bg-black text-white rounded font-bold hover:bg-gray-900 transition-colors duration-200">
              Crear cuenta
              <span id="loadingSpinner" class="hidden ml-2">
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </span>
            </button>
          </div>

          <!-- Integración Google removida -->

          <div id="statusMessage" class="mt-2 text-sm text-center hidden"></div>
          <p class="text-center text-sm text-gray-600 mt-4">¿Ya tienes cuenta? <a href="/login" class="text-blue-600 hover:text-blue-700">Inicia sesión</a></p>
        </form>
      </div>
    </div>

    <script type="module">

// Configuración centralizada (inline)
function getApiBase(){try{const env=window.__ENV__||{};return env.PUBLIC_API_URL||env.PUBLIC_API_URL_PRODUCTION||'/api'}catch{return '/api'}}
const API_URL=getApiBase();
const API_TIMEOUT=10000;

// Utilidades de RUT (inline)
function digitsOnly(v){return String(v||'').replace(/\D/g,'')}
function computeRutDV(d){const body=String(d||'').replace(/\D/g,'');if(!body)return'';let sum=0,f=2;for(let i=body.length-1;i>=0;i--){sum+=Number(body[i])*f;f=f===7?2:f+1}const rest=11-(sum%11);if(rest===11)return'0';if(rest===10)return'K';return String(rest)}
function isRutValid(str){const s=String(str||'').toUpperCase().replace(/[^0-9K]/g,'');if(!s||s.length<2)return false;const body=s.slice(0,-1);const dv=s.slice(-1);const expected=computeRutDV(body);return String(expected).toUpperCase()===dv}
function formatRutUI(v){const s=String(v||'').replace(/[^0-9kK]/g,'').toUpperCase();if(!s)return'';if(s.length===1)return s;const body=s.slice(0,-1);const dv=s.slice(-1);const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.');return `${withDots}-${dv}`}
function formatRutFromDigits(d){const s=String(d||'').replace(/\D/g,'');if(!s)return'';return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}

// Utilidades de teléfono (inline)
function formatPhoneUI(v){const d=String(v||'').replace(/\D/g,'').slice(0,8);return d}
function normalizePhoneCL(v){const d=String(v||'').replace(/\D/g,'').slice(0,8);return `+569${d}`}

function showStatus(message, type = 'info') {
  const el = document.getElementById('statusMessage');
  el.textContent = message;
  el.className = 'mt-2 text-sm text-center';
  el.classList.remove('hidden');
  el.classList.add(type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-600');
}

function showLoading(isLoading) {
  const btn = document.getElementById('registerButton');
  const spinner = document.getElementById('loadingSpinner');
  if (isLoading) {
    spinner.classList.remove('hidden');
    btn.disabled = true;
    btn.classList.add('opacity-75');
  } else {
    spinner.classList.add('hidden');
    btn.disabled = false;
    btn.classList.remove('opacity-75');
  }
}

function showGoogleLoading(isLoading) {
  const btn = document.getElementById('googleButton');
  const spinner = document.getElementById('googleLoadingSpinner');
  if (isLoading) {
    spinner.classList.remove('hidden');
    btn.disabled = true;
    btn.classList.add('opacity-75');
  } else {
    spinner.classList.add('hidden');
    btn.disabled = false;
    btn.classList.remove('opacity-75');
  }
}

// El backend recibe solo dígitos; la UI muestra puntos y guion con DV

async function handleRegister(e) {
  e.preventDefault();
  const nombre = document.getElementById('nombre').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const rutInput = document.getElementById('rut').value.trim();
  const email = document.getElementById('email').value.trim();
  const telefono = document.getElementById('telefono').value.trim();
  const password = document.getElementById('password').value;
  const confirm_password = document.getElementById('confirm_password').value;

  const rutClean = String(rutInput||'').replace(/[^0-9kK]/g,'').toUpperCase();
  if (!isRutValid(rutClean)) { showStatus('RUT inválido','error'); return; }
  const rutNormDigits = digitsOnly(rutClean.slice(0,-1));

  if (!nombre || !apellido || !rutNormDigits || !email || !telefono || !password || !confirm_password) {
    showStatus('Completa todos los campos requeridos', 'error');
    return;
  }
  if (password !== confirm_password) {
    showStatus('Las contraseñas no coinciden', 'error');
    return;
  }

  showLoading(true);
  showStatus('Creando tu cuenta...', 'info');

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);

  try {
    const payload = {
      nombre,
      apellido,
      username: rutNormDigits,
      rut: String(rutNormDigits),
      email,
      telefono: normalizePhoneCL(telefono),
      password,
      confirm_password,
      role: 'cliente'
    };

    let data;
    async function tryRegisterAndLogin() {
      const res = await fetch(`${API_URL}/auth/register-and-login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      return res;
    }
    async function tryRegisterThenLogin() {
      const reg = await fetch(`${API_URL}/auth/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      if (!reg.ok) return reg;
      const formData = new URLSearchParams();
      formData.append('username', rutNormDigits);
      formData.append('password', password);
      formData.append('grant_type', 'password');
      const loginRes = await fetch(`${API_URL}/auth/login-cliente`, {
        method: 'POST',
        body: formData,
        signal: controller.signal
      });
      // Empaquetar respuesta de login para flujo común
      return loginRes;
    }

    let response = await tryRegisterAndLogin().catch(() => null);
    if (!response || response.status === 404 || response.status === 405) {
      response = await tryRegisterThenLogin().catch(() => null);
    }

    clearTimeout(timeoutId);

    if (!response || !response.ok) {
      const text = response ? (await response.text()) : '';
      let msg = `Error al registrar (${response ? response.status : 'sin respuesta'})`;
      try {
        const d = JSON.parse(text);
        if (d.detail) msg = typeof d.detail === 'string' ? d.detail : JSON.stringify(d.detail);
      } catch {}
      showStatus(msg, 'error');
      showLoading(false);
      return;
    }

    data = await response.json();
    localStorage.setItem('token', data.access_token);
    const user = {
      nombre: data.nombre,
      rut: data.rut ?? rutNormDigits,
      rol: data.role || data.rol || 'cliente'
    };
    localStorage.setItem('user', JSON.stringify(user));
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('role', user.rol);
    localStorage.setItem('nombreUsuario', user.nombre || formatRutFromDigits(user.rut));
    document.cookie = `isLoggedIn=true; path=/; SameSite=Lax`;
    document.cookie = `role=${encodeURIComponent(user.rol)}; path=/; SameSite=Lax`;

    // Completar datos del usuario (email y teléfono) inmediatamente después del registro
    try {
      const uResp = await fetch(`${API_URL}/usuarios/me`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${data.access_token}`
        }
      });
      if (uResp.ok) {
        const fullUser = await uResp.json();
        if (fullUser && (fullUser.email || fullUser.telefono)) {
          localStorage.setItem('user', JSON.stringify(fullUser));
        }
      }
    } catch (err) {
      // No bloquear el flujo de registro por esta mejora
      console.warn('No se pudo completar datos de usuario tras registro:', err);
    }

    showStatus(`Cuenta creada: ${formatRutFromDigits(rutNormDigits)}. Iniciando sesión...`, 'success');
    setTimeout(() => { 
      const workerRoles=['administrador','admin','trabajador','vendedor','bodeguero'];
      const isWorker = workerRoles.includes(String(user.rol).toLowerCase());
      location.replace(isWorker ? '/admin' : '/');
    }, 1000);
  } catch (error) {
    const isTimeout = error.name === 'AbortError';
    showStatus(isTimeout ? 'Tiempo de espera agotado' : `Error: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
  try {
    const isLogged = (localStorage.getItem('isLoggedIn') === 'true') || (sessionStorage.getItem('isLoggedIn') === 'true');
    const role = (localStorage.getItem('role') || sessionStorage.getItem('role') || '').toLowerCase();
    if (isLogged) {
      const workerRoles=['administrador','admin','trabajador','vendedor','bodeguero'];
      const target = workerRoles.includes(role) ? '/admin' : '/';
      location.replace(target);
      return;
    }
  } catch {}
  const form = document.getElementById('registerForm');
  const googleButton = document.getElementById('googleButton');
  const registerButton = document.getElementById('registerButton');
  const rutEl = document.getElementById('rut');
  const telEl = document.getElementById('telefono');

  form?.addEventListener('submit', handleRegister);
  googleButton?.addEventListener('click', handleGoogleAuth);
  registerButton?.addEventListener('click', (e) => {
    const ok = isRutValid(rutEl?.value || '');
    if (!ok) {
      e.preventDefault();
      showStatus('RUT inválido','error');
      try { rutEl.setCustomValidity('RUT inválido'); rutEl.reportValidity(); } catch {}
    } else {
      try { rutEl.setCustomValidity(''); } catch {}
    }
  });

  // Formatear RUT al escribir (puntos y guion con DV)
  if (rutEl) {
    rutEl.addEventListener('input', (e) => {
      const pos = e.target.selectionStart;
      const formatted = formatRutUI(e.target.value);
      e.target.value = formatted;
      // Ajuste simple del cursor: mover al final
      e.target.selectionStart = e.target.selectionEnd = formatted.length;
    });
  }

  // Teléfono: permitir solo dígitos y limitar a 8 (prefijo fijo +569)
  if (telEl) {
    telEl.addEventListener('input', (e) => {
      const formatted = formatPhoneUI(e.target.value);
      e.target.value = formatted;
      e.target.selectionStart = e.target.selectionEnd = formatted.length;
    });
  }

  // Verificar callback de Google
  checkGoogleCallback();
});

async function handleGoogleAuth() {
  showGoogleLoading(true);
  showStatus('Redirigiendo a Google...', 'info');

  try {
    // El backend ahora realiza redirección directa
    window.location.href = `${API_URL}/auth/google`;
  } catch (error) {
    showStatus(`Error al conectar con Google: ${error.message}`, 'error');
    showGoogleLoading(false);
  }
}

// Verificar si hay parámetros de retorno de Google
function checkGoogleCallback() {
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const success = urlParams.get('success');
  const error = urlParams.get('error');

  if (success && token) {
    // Guardar token y redirigir
    localStorage.setItem('token', token);
    showStatus('¡Registro exitoso con Google! Redirigiendo...', 'success');
    setTimeout(() => {
      window.location.href = '/admin/dashboard';
    }, 1500);
  } else if (error) {
    showStatus(`Error en registro con Google: ${decodeURIComponent(error)}`, 'error');
    // Limpiar URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}
    </script>
  </body>
</html>
