---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Tu carrito - Ferretería Patricio">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Tu carrito</h1>

    <!-- Paso 1: Inicio de sesión o invitado -->
    <div id="checkout-login-section" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <!-- Indicador de pasos -->
      <div class="flex items-center justify-between mb-4 text-gray-500">
        <div class="flex items-center space-x-8 w-full">
          <div class="flex items-center space-x-2">
            <span class="w-6 h-6 flex items-center justify-center rounded-full bg-green-500 text-white text-sm font-bold">1</span>
            <span class="font-semibold text-gray-800">Inicio de sesión</span>
          </div>
          <div class="flex-1 h-px bg-gray-200"></div>
          <div class="flex items-center space-x-2 opacity-60">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border border-gray-300 text-gray-500 text-sm font-bold">2</span>
            <span>Tipo de Entrega</span>
          </div>
          <div class="flex-1 h-px bg-gray-200"></div>
          <div class="flex items-center space-x-2 opacity-60">
            <span class="w-6 h-6 flex items-center justify-center rounded-full border border-gray-300 text-gray-500 text-sm font-bold">3</span>
            <span>Pago</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Opción iniciar sesión -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">¿Ya tienes cuenta?</h3>
          <p class="text-sm text-gray-600 mb-4">Inicia sesión para usar tus datos guardados.</p>
          <a href="/login" class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Iniciar sesión</a>
        </div>

        <!-- Opción invitado -->
        <div class="border rounded-lg p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">Continuar como invitado</h3>
          <form id="guestForm" class="space-y-3" onsubmit="continuarComoInvitado(event)">
            <div>
              <label class="block text-sm text-gray-700 mb-1" for="guest-nombre">Nombre</label>
              <input id="guest-nombre" type="text" class="w-full border rounded px-3 py-2" placeholder="Tu nombre" required>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-gray-700 mb-1" for="guest-email">Correo</label>
                <input id="guest-email" type="email" class="w-full border rounded px-3 py-2" placeholder="Opcional">
              </div>
              <div>
                <label class="block text-sm text-gray-700 mb-1" for="guest-telefono">Teléfono</label>
                <input id="guest-telefono" type="tel" class="w-full border rounded px-3 py-2" placeholder="Opcional">
              </div>
            </div>
            <div>
              <label class="block text-sm text-gray-700 mb-1" for="guest-rut">RUT</label>
              <input id="guest-rut" type="text" class="w-full border rounded px-3 py-2" placeholder="Opcional">
            </div>
            <button type="submit" class="mt-2 px-4 py-2 bg-black text-white rounded hover:bg-gray-900">Continuar</button>
            <p id="guestSavedMsg" class="text-sm text-green-600 mt-2 hidden">Datos guardados. Continuemos con tu compra.</p>
          </form>
        </div>
      </div>
    </div>

    <div id="carrito-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Lista de productos -->
      <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
        <div id="carrito-items-list" class="space-y-4">
          <!-- Items renderizados por JS -->
        </div>
      </div>

      <!-- Resumen -->
      <div class="bg-white rounded-lg shadow p-6 h-fit">
        <h2 class="text-xl font-semibold mb-4">Resumen de compra</h2>
        <div class="flex justify-between text-gray-700 mb-2">
          <span>Subtotal</span>
          <span id="carrito-subtotal" class="font-bold">$0</span>
        </div>
        <button id="btnCheckoutPage" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded" onclick="goCheckout()">
          Continuar
        </button>
      </div>
    </div>
  </div>

  <script>
    const formatearPrecio = (precio) => precio.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    const getCarrito = () => {
      try {
        const c = JSON.parse(localStorage.getItem('carrito')) || [];
        return Array.isArray(c) ? c : [];
      } catch {
        return [];
      }
    };

    const setCarrito = (carrito) => {
      localStorage.setItem('carrito', JSON.stringify(carrito));
    };

    const calcularSubtotal = (carrito) => carrito.reduce((acc, it) => acc + Number(it.precio_venta ?? it.precio) * it.cantidad, 0);

    const irADetalle = (id) => {
      // La página de detalle acepta ID numérico o slug; usamos ID
      window.location.href = `/productos/${id}`;
    };

    const eliminarItem = (id) => {
      const carrito = getCarrito().filter(i => String(i.id) !== String(id));
      setCarrito(carrito);
      render();
    };

    const mostrarSectionLoginGuest = () => {
      const sec = document.getElementById('checkout-login-section');
      if (!sec) return;
      sec.classList.remove('hidden');
      try {
        const top = sec.getBoundingClientRect().top + window.scrollY - 16;
        window.scrollTo({ top, behavior: 'smooth' });
      } catch {}
    };

    const continuarComoInvitado = (event) => {
      event.preventDefault();
      const nombre = document.getElementById('guest-nombre')?.value?.trim() || '';
      const email = document.getElementById('guest-email')?.value?.trim() || '';
      const telefono = document.getElementById('guest-telefono')?.value?.trim() || '';
      const rut = document.getElementById('guest-rut')?.value?.trim() || '';
      if (!nombre) {
        alert('Por favor ingresa tu nombre para continuar.');
        return;
      }
      const data = { nombre, email, telefono, rut, ts: Date.now() };
      try { localStorage.setItem('checkoutGuest', JSON.stringify(data)); } catch {}
      const msg = document.getElementById('guestSavedMsg');
      if (msg) msg.classList.remove('hidden');
    };

    const goCheckout = () => {
      const carrito = getCarrito();
      if (!carrito.length) {
        alert('Tu carrito está vacío. Agrega productos antes de comprar.');
        return;
      }
      mostrarSectionLoginGuest();
    };

    const render = () => {
      const list = document.getElementById('carrito-items-list');
      const subtotalEl = document.getElementById('carrito-subtotal');
      const carrito = getCarrito();

      if (!list || !subtotalEl) return;

      if (carrito.length === 0) {
        list.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';
        subtotalEl.textContent = '$0';
        return;
      }

      list.innerHTML = carrito.map(item => `
        <div class="flex items-center gap-4 border rounded-md p-3">
          <button aria-label="Ver detalle" onclick="irADetalle('${item.id}')" class="shrink-0">
            <img src="${item.imagen_url || '/images/logos/logo_bn.webp'}" onerror="this.src='/images/logos/logo_bn.webp';this.onerror=null;" alt="${item.nombre}" class="w-16 h-16 object-cover rounded">
          </button>
          <div class="flex-1">
            <button class="text-left" aria-label="Ir al detalle" onclick="irADetalle('${item.id}')">
              <p class="text-sm font-medium text-gray-900 hover:text-blue-600">${item.nombre}</p>
            </button>
            <p class="text-xs text-gray-600">Precio: $${formatearPrecio(Number(item.precio_venta ?? item.precio))}</p>
            <p class="text-xs text-gray-600">Cantidad: ${item.cantidad}</p>
          </div>
          <div class="text-sm font-semibold">$${formatearPrecio(Number(item.precio_venta ?? item.precio) * item.cantidad)}</div>
          <button aria-label="Eliminar" onclick="eliminarItem('${item.id}')" class="text-red-600 hover:text-red-700 ml-2">
            &times;
          </button>
        </div>
      `).join('');

      const subtotal = calcularSubtotal(carrito);
      subtotalEl.textContent = `$${formatearPrecio(subtotal)}`;
    };

    document.addEventListener('DOMContentLoaded', () => {
      // Render inicial
      render();

      // Botón de compra
      const btnCheckoutPage = document.getElementById('btnCheckoutPage');
      btnCheckoutPage && btnCheckoutPage.addEventListener('click', () => goCheckout());
    });

    // Exponer funciones globales para handlers inline
    window.eliminarItem = eliminarItem;
    window.goCheckout = goCheckout;
    window.continuarComoInvitado = continuarComoInvitado;
    window.mostrarSectionLoginGuest = mostrarSectionLoginGuest;

  </script>
</Layout>