---
import EnvLoader from '../components/EnvLoader.astro';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Iniciar Sesión</title>
    <link rel="icon" href="/images/logos/logo_bn.webp" type="image/webp" />
    <EnvLoader />
  </head>
  <body class="min-h-screen bg-gray-100">
    <div class="min-h-screen flex relative">
      <button type="button" class="absolute top-6 left-6 text-gray-600 hover:text-gray-900 transition-colors duration-200" onclick="(history.length>1?history.back():location.href='/')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
      </button>
      <div class="w-1/2 bg-[#2B5BA9] flex items-center justify-center">
        <img src="/images/logos/logo_bn.webp" alt="Ferretería Patricio" class="w-164 h-164">
      </div>
      <div class="w-1/2 bg-white flex items-center justify-center p-12">
        <div class="w-full max-w-md">
          <h2 class="text-2xl font-semibold text-gray-900 mb-8">Inicio de sesión</h2>
          <form id="loginForm" class="space-y-6" method="post" onsubmit="return false">
            <div class="space-y-4">
              <div>
                <label id="usernameLabel" for="username" class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
                <input id="username" name="username" type="text" maxlength="13" required class="w-full px-3 py-2 border border-gray-300 rounded-md" inputmode="numeric" autocomplete="username" placeholder="20.347.793-7" />
              </div>
              <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input id="password" name="password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="****************" />
              </div>
            </div>
            <div>
              <button id="loginButton" type="submit" class="w-full flex justify-center py-2 px-4 rounded-md text-sm font-medium text-white bg-gray-900 hover:bg-gray-800">
                <span>Iniciar</span>
                <span id="loadingSpinner" class="hidden ml-2">...</span>
              </button>
            </div>
            <div id="statusMessage" class="mt-2 text-sm text-center hidden"></div>
            <div id="createAccountContainer" class="mt-6 flex justify-center">
              <a href="/registro" class="px-4 py-2 bg-black text-white rounded font-bold hover:bg-gray-900">Crear cuenta</a>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script type="module">
      function getApiBase(){try{const env=window.__ENV__||{};return env.PUBLIC_API_URL||env.PUBLIC_API_URL_PRODUCTION||'/api'}catch{return'/api'}}
      const API_URL=getApiBase();
      const API_TIMEOUT=10000;
      const corsConfig={ mode:'cors', credentials:'include' };
      function digitsOnly(v){return String(v||'').replace(/\D/g,'')}
      function cleanRutInput(v){return String(v||'').replace(/[^0-9kK]/g,'').toUpperCase()}
      function formatRutUI(v){const s=String(v||'').replace(/[^0-9kK]/g,'').toUpperCase();if(!s)return'';if(s.length===1)return s;const body=s.slice(0,-1);const dv=s.slice(-1);const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.');return `${withDots}-${dv}`}
      function formatRutFromDigits(d){const s=String(d||'').replace(/\D/g,'');if(!s)return'';return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}
      const defaultHeaders={ 'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json' };

async function checkServerAvailability() {
  try { const c = new AbortController(); const t = setTimeout(() => c.abort(), API_TIMEOUT/2);
    const r = await fetch(`${API_URL}/health`, { method:'GET', signal:c.signal }); clearTimeout(t);
    return { available: r.ok }; } catch { return { available: false }; }
}

function showStatus(m, type='info'){ const el=document.getElementById('statusMessage'); if(!el) return; el.textContent=m; el.className='mt-2 text-sm text-center'; el.classList.add(type==='error'?'text-red-600':type==='success'?'text-green-600':type==='warning'?'text-yellow-600':'text-gray-600'); el.classList.remove('hidden'); }
function showLoading(b){ const btn=document.getElementById('loginButton'); const sp=document.getElementById('loadingSpinner'); if(!btn||!sp) return; if(b){ sp.classList.remove('hidden'); btn.disabled=true; btn.classList.add('opacity-75'); } else { sp.classList.add('hidden'); btn.disabled=false; btn.classList.remove('opacity-75'); } }

async function handleLogin(e){ e.preventDefault(); const usernameInput=(document.getElementById('username')?.value||'').trim(); const baseRut = usernameInput.includes('-') ? usernameInput.split('-')[0] : usernameInput; const username = digitsOnly(baseRut); const password=document.getElementById('password')?.value||''; if(!username||!password){ showStatus('Por favor, ingrese RUT y contraseña','error'); return; }
  showLoading(true); showStatus('Verificando credenciales...','info'); const ok=await checkServerAvailability(); if(!ok.available){ showStatus('No se pudo verificar el servidor. Intentando iniciar sesión...','info'); }
  try{ const controller=new AbortController(); const timeoutId=setTimeout(()=>controller.abort(),10000);
    const rawRut = (document.getElementById('username')?.value||'').trim();
    const rutLimpio = cleanRutInput(rawRut);
    const formData = new URLSearchParams();
    formData.append('username', rutLimpio);
    formData.append('password', password);
    formData.append('grant_type','password');
      const opts = { method:'POST', body:formData, signal:controller.signal, mode:corsConfig.mode, credentials:corsConfig.credentials, headers: defaultHeaders };
    let response = await fetch(`${API_URL}/auth/login`, opts).catch(()=>null);
    if (!response || !response.ok) {
      response = await fetch(`${API_URL}/auth/login-cliente`, opts).catch(()=>null);
    }
    if (response && !response.ok) {
      const formDataRut = new URLSearchParams();
      formDataRut.append('rut', rutLimpio);
      formDataRut.append('password', password);
      formDataRut.append('grant_type','password');
      const optsRut = { ...opts, body: formDataRut };
      let r2 = await fetch(`${API_URL}/auth/login-cliente`, optsRut).catch(()=>null);
      if (!r2 || !r2.ok) {
        r2 = await fetch(`${API_URL}/auth/login`, optsRut).catch(()=>null);
      }
      response = r2;
    }
    clearTimeout(timeoutId);
    if(!response || !response.ok){ const txt = response ? (await response.text()) : ''; let msg = response && response.status===401 ? 'Credenciales incorrectas' : (response && response.status===422 ? 'Datos no procesables. Revisa formato de RUT y contraseña.' : `Error de autenticación (${response ? response.status : 'sin respuesta'})`); try{ const j=JSON.parse(txt); if(j?.detail) msg = typeof j.detail==='string'? j.detail : JSON.stringify(j.detail); }catch{} showStatus(msg,'error'); showLoading(false); return; }
    const data=await response.json(); const user={ id_usuario:data.id_usuario, nombre:data.nombre, apellido:data.apellido??data.apellidos??data.last_name, email:data.email??data.correo??data.mail, telefono:data.telefono??data.phone??data.celular, rut:data.rut ?? username, rol:(data.role||data.rol||'cliente') };
    const workerRoles=['administrador','admin','trabajador','vendedor','bodeguero']; const isWorker=workerRoles.includes(String(user.rol).toLowerCase());
    localStorage.setItem('isLoggedIn','true'); localStorage.setItem('token',data.access_token); localStorage.setItem('user',JSON.stringify(user)); localStorage.setItem('role',user.rol); localStorage.setItem('nombreUsuario', user.nombre || formatRutFromDigits(user.rut));
    document.cookie = `isLoggedIn=true; path=/; SameSite=Lax`;
    document.cookie = `role=${encodeURIComponent(user.rol)}; path=/; SameSite=Lax`;
    try{
      const headers={ 'Content-Type':'application/json','Authorization':`Bearer ${data.access_token}` };
      const paths=['/api/usuarios/me','/api/users/me','/api/me',`/api/usuarios/${user.id_usuario}`];
      let info=null;
      for(const p of paths){ try{ const r=await fetch(`${API_URL.replace(/\/api$/,'')}${p}`,{ headers }); if(r&&r.ok){ info=await r.json(); break; } }catch{} }
      if(info){
        const apellido = info.apellido ?? info.apellidos ?? info.last_name;
        const email = info.email ?? info.correo ?? info.mail;
        const telefono = info.telefono ?? info.phone ?? info.celular;
        const merged = { ...user };
        if (apellido !== undefined) merged.apellido = apellido;
        if (email !== undefined) merged.email = email;
        if (telefono !== undefined) merged.telefono = telefono;
        localStorage.setItem('user', JSON.stringify(merged));
      }
    }catch{}
    showStatus('Autenticación exitosa. Redirigiendo...','success'); setTimeout(()=>{ window.location.href = isWorker ? '/admin' : '/'; },800);
  } catch(err){ showLoading(false); showStatus('Error de autenticación','error'); }
}

document.addEventListener('DOMContentLoaded', async ()=>{ const form=document.getElementById('loginForm'); const label=document.getElementById('usernameLabel'); const input=document.getElementById('username'); const create=document.getElementById('createAccountContainer'); if(label) label.textContent='RUT'; if(input){ input.placeholder='20.347.793-7'; input.addEventListener('input', (e)=>{ const formatted = formatRutUI(e.target.value); e.target.value = formatted; e.target.selectionStart = e.target.selectionEnd = formatted.length; }); } if(create) create.classList.remove('hidden'); if(form) form.addEventListener('submit', handleLogin); });

    </script>
  </body>
</html>
