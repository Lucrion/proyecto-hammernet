---
import Layout from '../layouts/Layout.astro';
 
---

<Layout title="Contáctanos - Ferretería Patricio">
	<div class="container mx-auto px-4 py-8">
		<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
			<!-- Información de contacto y mapa (ahora a la derecha) -->
			<div class="space-y-8 order-2 md:order-2">
				<div class="bg-white p-6 rounded-lg shadow-sm">
					<h2 class="text-xl font-semibold mb-4">Información de Contacto</h2>
					<div class="space-y-4">
						<div class="flex items-center gap-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
							</svg>
							<p>Calle Mexico 3164, Calama, Región de Antofagasta</p>
						</div>
						<div class="flex items-center gap-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
								<path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
							</svg>
							<p>+56 9 000000</p>
						</div>
						<div class="flex items-center gap-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
								<path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
								<path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
							</svg>
							<a href="mailto:contacto@ferreteriapatricio.com" class="hover:text-blue-600">contacto@ferreteriapatricio.com</a>
						</div>
						<div class="flex items-center gap-3">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
							</svg>
							<p>Lunes a Sábado de 8:30 a 18:00 hrs</p>
						</div>
					</div>
				</div>

				<div class="bg-white p-6 rounded-lg shadow-sm">
					<h2 class="text-xl font-semibold mb-4">Ubicación</h2>
					<div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden">
						<iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3687.492867276542!2d-68.93479862460539!3d-22.448105779580573!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x96ac09956eb42dff%3A0x17f095dc1d2cbcdd!2sColque%20Corrales%20Patricio!5e0!3m2!1ses!2scl!4v1755753260508!5m2!1ses!2scl" width="100%" height="300" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade" class="rounded-lg"></iframe>
					</div>
				</div>
			</div>
			
			<!-- Formulario de contacto (ahora a la izquierda) -->
			<div class="bg-white p-6 rounded-lg shadow-sm order-1 md:order-1">
				<form class="space-y-6" id="contactForm">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
							<input
								type="text"
								id="nombre"
								name="nombre"
								class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
								minlength="2"
								maxlength="100"
								required
								oninvalid="this.setCustomValidity('Por favor ingresa un nombre válido')" 
								oninput="this.setCustomValidity('')"
							/>
							<p class="text-xs text-gray-500 mt-1">El nombre debe tener entre 3 y 50 caracteres</p>
						</div>
						<div>
							<label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
							<input
								type="text"
								id="apellido"
								name="apellido"
								class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
								minlength="2"
								maxlength="50"
								required
								oninvalid="this.setCustomValidity('Por favor ingresa un apellido válido')" 
								oninput="this.setCustomValidity('')"
							/>
							<p class="text-xs text-gray-500 mt-1">El apellido debe tener entre 3 y 50 caracteres</p>
						</div>
					</div>

					<div>
						<label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
						<input
							type="email"
							id="email"
							name="email"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
							pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
							required
							oninvalid="this.setCustomValidity('Por favor ingresa un correo electrónico válido')" 
							oninput="this.setCustomValidity('')"
						/>
						<p class="text-xs text-gray-500 mt-1">Ingresa un correo electrónico válido</p>
					</div>

					<div>
						<label for="asunto" class="block text-sm font-medium text-gray-700 mb-1">Asunto</label>
						<input
							type="text"
							id="asunto"
							name="asunto"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
							minlength="5"
							maxlength="200"
							required
							oninvalid="this.setCustomValidity('Por favor ingresa un asunto válido')" 
							oninput="this.setCustomValidity('')"
						/>
						<p class="text-xs text-gray-500 mt-1">El asunto debe tener entre 5 y 100 caracteres</p>
					</div>

					<div>
						<label for="mensaje" class="block text-sm font-medium text-gray-700 mb-1">Mensaje</label>
						<textarea
							id="mensaje"
							name="mensaje"
							rows="4"
							class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
							minlength="10"
							maxlength="1000"
							required
							oninvalid="this.setCustomValidity('Por favor ingresa un mensaje válido de al menos 20 caracteres')" 
							oninput="this.setCustomValidity('')"
						></textarea>
						<div class="flex justify-between items-center mt-1">
							<p class="text-xs text-gray-500">El mensaje debe tener entre 20 y 500 caracteres</p>
							<span id="charCount" class="text-xs text-gray-500">0/500</span>
						</div>
						</div>

						<button
							type="submit"
							class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors"
						>
							Enviar Mensaje
						</button>
					</div>

				</form>
			
	</div>

	<!-- Footer -->
    <footer class="hidden mt-8 pt-6 border-t border-gray-200 bg-gradient-to-b from-white to-gray-50" aria-hidden="true">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-3 gap-6 pb-6">
                <div class="text-center md:text-left">
                    <img src="/images/logos/logo_bn.webp" alt="Ferretería Patricio" class="w-40 h-32 object-contain mx-auto md:mx-0 mb-3">
                </div>
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Contacto</h3>
                    <div class="space-y-2 text-sm text-gray-700">
						<div class="flex items-center gap-2 justify-center md:justify-start">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
								<path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
							</svg>
							<span>+56 9 0000000</span>
						</div>
						<div class="flex items-center gap-2 justify-center md:justify-start">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
								<path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
								<path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
							</svg>
							<span>contacto@ferreteriapatricio.com</span>
						</div>
						<div class="flex items-center gap-2 justify-center md:justify-start">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
							</svg>
							<span>Lun-Vie 8:30-18:00 hrs</span>
						</div>
						<div class="flex items-center gap-3 justify-center md:justify-start mt-3">
							<a href="https://facebook.com" class="hover:text-blue-600">
								<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
									<path d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z" />
								</svg>
							</a>
							<a href="https://instagram.com" class="hover:text-pink-600">
								<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
									<path d="M12 2c2.717 0 3.056.01 4.122.06 1.065.05 1.79.217 2.428.465.66.254 1.216.598 1.772 1.153a4.908 4.908 0 011.153 1.772c.247.637.415 1.363.465 2.428.047 1.066.06 1.405.06 4.122 0 2.717-.01 3.056-.06 4.122-.05 1.065-.218 1.79-.465 2.428a4.883 4.883 0 01-1.153 1.772 4.915 4.915 0 01-1.772 1.153c-.637.247-1.363.415-2.428.465-1.066.047-1.405.06-4.122.06-2.717 0-3.056-.01-4.122-.06-1.065-.05-1.79-.218-2.428-.465a4.89 4.89 0 01-1.772-1.153 4.904 4.904 0 01-1.153-1.772c-.248-.637-.415-1.363-.465-2.428C2.013 15.056 2 14.717 2 12c0-2.717.01-3.056.06-4.122.05-1.066.217-1.79.465-2.428a4.88 4.88 0 011.153-1.772A4.897 4.897 0 015.45 2.525c.638-.248 1.362-.415 2.428-.465C8.944 2.013 9.283 2 12 2zm0 5a5 5 0 100 10 5 5 0 000-10zm6.5-.25a1.25 1.25 0 10-2.5 0 1.25 1.25 0 002.5 0zM12 9a3 3 0 110 6 3 3 0 010-6z"/>
								</svg>
							</a>
                            <a href="https://wa.me/56998116663" class="hover:text-green-600" aria-label="WhatsApp">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                            </a>
                    </div>
                </div>
                <div class="text-center md:text-left">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Acerca de Ferretería Patricio</h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li>
                            <a href="/nosotros#quienes-somos" class="text-gray-700 hover:text-blue-600">Quiénes somos</a>
                        </li>
                        <li>
                            <a href="/nosotros#nuestra-vision" class="text-gray-700 hover:text-blue-600">Nuestra visión</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    </div>
</Layout>

<script type="module">
function getApiBase(){try{const env=window.__ENV__||{};return env.PUBLIC_API_URL||env.PUBLIC_API_URL_PRODUCTION||'/api'}catch{return'/api'}}
function buildUrl(endpoint){const base=getApiBase();if(endpoint.startsWith('http'))return endpoint;const origin=String(base).replace(/\/api$/,'');if(endpoint.startsWith('/'))return origin+endpoint;return base+endpoint}
async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=buildUrl(endpoint);const c=new AbortController();const t=setTimeout(()=>c.abort(),Number(10000));const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function postData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}

function init() {
    const form = document.getElementById('contactForm');
    const charCount = document.getElementById('charCount');
    const mensajeTextarea = document.getElementById('mensaje');
    const nombreEl = document.getElementById('nombre');
    const apellidoEl = document.getElementById('apellido');
    const emailEl = document.getElementById('email');
    
    const getAuth = () => {
        try {
            const token = localStorage.getItem('token') || localStorage.getItem('access_token') || '';
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            return { token, user };
        } catch { return { token: '', user: {} }; }
    };

    const computeApiUrl = () => getApiBase();

    const lockPersonalFieldsIfApplicable = () => {
        const { token, user } = getAuth();
        const hasSession = !!token || !!(user && user.id_usuario);
        if (!hasSession) return;
        // Solo bloquear si hay valor (evita dejar campos vacíos e ineditables)
        [nombreEl, apellidoEl, emailEl].forEach((el) => {
            if (el && el.value && el.value.trim()) {
                el.readOnly = true;
                el.classList.add('bg-gray-100', 'cursor-not-allowed');
                el.setAttribute('title', 'Campo bloqueado por sesión activa');
            }
        });
    };
    // Prefill desde sesión si existe (local)
    try {
        const { user } = getAuth();
        if (user && (user.id_usuario || user.id)) {
            if (nombreEl) nombreEl.value = user.nombre || nombreEl.value || '';
            if (apellidoEl) apellidoEl.value = user.apellido || apellidoEl.value || '';
            if (emailEl) emailEl.value = user.email || emailEl.value || '';
        }
    } catch {}
    // Intentar bloquear edición tras prefill local
    lockPersonalFieldsIfApplicable();

    // Prefill consultando el backend si hay token
    (async () => {
        try {
            const { token, user } = getAuth();
            if (!token) return;
            let data = null;
            try { data = await getData(`/api/usuarios/me`); } catch {}
            if (!data) {
                const id = user && (user.id_usuario || user.id);
                if (id) {
                    try { data = await getData(`/api/usuarios/${id}`); } catch {}
                }
            }
            if (!data) return;
            if (nombreEl && data?.nombre) nombreEl.value = data.nombre;
            if (apellidoEl && data?.apellido) apellidoEl.value = data.apellido;
            if (emailEl && data?.email) emailEl.value = data.email;
            // Bloquear edición tras prefill desde backend
            lockPersonalFieldsIfApplicable();
        } catch (e) { /* silencioso */ }
    })();
    
    // Actualizar contador de caracteres
    if (mensajeTextarea && charCount) {
        mensajeTextarea.addEventListener('input', function() {
            const currentLength = mensajeTextarea.value.length;
            charCount.textContent = `${currentLength}/500`;
        });
    }
    
    // Manejar envío del formulario
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Mostrar indicador de carga
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            
            try {
                // Recopilar y validar datos del formulario
                const formData = {
                    nombre: document.getElementById('nombre').value.trim(),
                    apellido: document.getElementById('apellido').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    asunto: document.getElementById('asunto').value.trim(),
                    mensaje: document.getElementById('mensaje').value.trim()
                };
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!formData.nombre || formData.nombre.length < 2) throw new Error('El nombre debe tener al menos 2 caracteres');
                if (!formData.apellido || formData.apellido.length < 2) throw new Error('El apellido debe tener al menos 2 caracteres');
                if (!emailRegex.test(formData.email)) throw new Error('El correo electrónico no es válido');
                if (!formData.asunto || formData.asunto.length < 5) throw new Error('El asunto debe tener al menos 5 caracteres');
                if (!formData.mensaje || formData.mensaje.length < 10) throw new Error('El mensaje debe tener al menos 10 caracteres');
                
                // Enviar datos a la API usando utilidad que normaliza la URL
                const result = await postData('/api/mensajes/', formData);
                
                if (!result) {
                    throw new Error('Error al enviar el mensaje');
                }
                
                // Mostrar mensaje de éxito
                alert('¡Gracias por tu mensaje! Te contactaremos pronto.');
                
                // Resetear formulario
                form.reset();
                if (charCount) charCount.textContent = '0/500';
                
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                let msg = 'Error en conexión del servidor';
                const text = String(error && error.message ? error.message : '');
                try {
                    const jsonStr = text.replace(/^Error\s+\d+:\s+/, '');
                    const data = JSON.parse(jsonStr);
                    if (data && data.detail) {
                        msg = typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail);
                    }
                } catch {
                    if (text) msg = text;
                }
                alert(msg);
            } finally {
                // Restaurar botón
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            }
        });
    }
}

try {
    if (typeof document !== 'undefined') {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    }
} catch {}
</script>
