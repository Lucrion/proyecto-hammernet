---
import Layout from '../../layouts/Layout.astro';
const estadoParam = Astro.params.estado || '';
const estadoMap = {
  AUTHORIZED: { label: 'Pago aprobado', cls: 'bg-green-100 text-green-800' },
  REJECTED: { label: 'Pago rechazado', cls: 'bg-red-100 text-red-800' },
  FAILED: { label: 'Pago fallido', cls: 'bg-red-100 text-red-800' },
  ABORTED: { label: 'Pago cancelado por el cliente', cls: 'bg-yellow-100 text-yellow-800' },
  TIMEOUT: { label: 'Pago expirado por tiempo', cls: 'bg-yellow-100 text-yellow-800' },
  ERROR: { label: 'Error de pago', cls: 'bg-red-100 text-red-800' },
};
const estadoInfo = estadoMap[estadoParam] || { label: 'Estado de pago', cls: 'bg-gray-100 text-gray-800' };
---

<Layout title={`Orden de Compra · ${estadoInfo.label}`}>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-4">{estadoInfo.label}</h1>
    <div id="banner" class={`p-3 rounded mb-6 ${estadoInfo.cls}`}></div>

    <div id="estado" class="mb-3 text-gray-700"></div>
    <div id="orden" class="mb-2 text-sm text-gray-600"></div>
    <div id="resumen" class="bg-white rounded shadow p-4 mb-6 hidden">
      <p id="ventaInfo" class="mb-2"></p>
      <p id="clienteInfo" class="mb-2"></p>
      <p id="totalInfo" class="font-semibold"></p>
    </div>
    <div id="items" class="bg-white rounded shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Productos</h2>
      <ul id="itemsList" class="list-disc pl-5"></ul>
    </div>
    <div id="json" class="mt-6 bg-gray-50 rounded p-3 text-xs overflow-auto hidden"></div>
    <div class="mt-6 flex gap-3">
      <a id="verDetalle" href="#" class="px-4 py-2 bg-black text-white rounded hidden">Ver detalle</a>
      <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded">Volver al inicio</a>
    </div>
  </div>

  <script type="module">
    (function(){
      // Visualización sin permisos: no forzar login ni sesión de invitado

      async function ensureApiBase(){
        try {
          const urlParam = new URLSearchParams(window.location.search).get('api');
          if (urlParam) window.API_BASE = urlParam;
          let base = window.API_BASE || (window.__ENV__?.PUBLIC_API_URL || window.__ENV__?.PUBLIC_API_URL_PRODUCTION || 'https://hammernet.onrender.com/api');
          try {
            const r = await fetch(String(base).replace(/\/$/, '') + '/health', { method: 'GET' });
            if (r && r.ok) { window.API_BASE = base; return; }
          } catch {}
          try {
            const host = window.location.hostname || '';
            if (/\.onrender\.com$/.test(host)) {
              const alt = `https://${host.replace(/(\.onrender\.com)$/,'-backend$1')}/api`;
              const r2 = await fetch(alt + '/health', { method: 'GET' });
              if (r2 && r2.ok) { window.API_BASE = alt; return; }
            }
          } catch {}
          window.API_BASE = base;
        } catch {}
      }
      
      await ensureApiBase();
      const API_BASE = window.API_BASE || 'https://hammernet.onrender.com/api';
      
      const u = new URL(window.location.href);
      const bo = u.searchParams.get('bo')||'';
      const reason = u.searchParams.get('reason')||'';
      const message = u.searchParams.get('message')||'';
      
      // Pasar estado desde Astro
      const estado = "{estadoParam}";
      
      const banner = document.getElementById('banner');
      const estadoBox = document.getElementById('estado');
      const orden = document.getElementById('orden');
      const verCompras = document.getElementById('verCompras');
      const resumen = document.getElementById('resumen');
      const itemsBox = document.getElementById('items');
      const itemsList = document.getElementById('itemsList');

      // Generar mensaje de estado incluyendo el código de orden (bo)
      const statusMsg = () => {
        if (estado === 'AUTHORIZED') return bo ? `Pago aprobado. Orden ${bo}` : 'Pago aprobado';
        if (estado === 'REJECTED') return `Pago rechazado${reason?`: ${reason}`:''}`;
        if (estado === 'FAILED') return 'Pago fallido';
        if (estado === 'ABORTED') return 'Pago cancelado por el cliente';
        if (estado === 'TIMEOUT') return 'Pago expirado por timeout';
        if (estado === 'ERROR') return `Error de autenticación${message?`: ${message}`:''}`;
        return 'Estado desconocido';
      };
      
      // Mostrar el mensaje en el banner principal
      if (banner) banner.textContent = statusMsg();
      
      // Mostrar explícitamente el código de orden debajo del banner
      if (orden) orden.textContent = bo ? `Orden de compra: ${bo}` : '';
      
      if (!bo) {
        if (estadoBox) estadoBox.textContent = 'No se realizó una orden de compra';
        if (verCompras) verCompras.href = '/compras';
        return;
      }

      if (estadoBox) estadoBox.textContent = '';
      
      let token = '';
      try { token = localStorage.getItem('token') || sessionStorage.getItem('token') || ''; } catch {}

      const headers = { 'Accept':'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;

      // Intentar cargar detalles de la venta si es posible
      fetch(`${API_BASE}/ventas/orden/${encodeURIComponent(bo)}`,{ headers: headers, cache:'no-store'})
        .then(r=>{ if(!r.ok) throw new Error('No encontrada'); return r.json(); })
        .then(data=>{ 
            const idv = Number(data?.id_venta || data?.id); 
            // Si la venta existe, redirigir al detalle o quedarse aquí según la lógica deseada.
            // Para mostrar la confirmación visual, a veces es mejor no redirigir automáticamente:
            if (idv) { 
                // Opción A: Redirigir al detalle completo
                 window.location.href = `/compra/${idv}?bo=${encodeURIComponent(bo)}`; 
                
                // Opción B (Comentada): Si prefieres quedarte en esta pantalla y mostrar datos básicos:
                /*
                if (resumen) {
                    resumen.classList.remove('hidden');
                    document.getElementById('totalInfo').textContent = 'Total: $' + (data.total_venta || 0).toLocaleString('es-CL');
                }
                */
            } else { 
                window.location.href = '/compras?bo='+encodeURIComponent(bo); 
            } 
        })
        .catch(err => {
            console.error('No se pudo cargar detalle venta:', err);
            // No hacer nada, dejar que el usuario vea el mensaje de "Pago aprobado"
        });
    })();
 </script>
</Layout>
