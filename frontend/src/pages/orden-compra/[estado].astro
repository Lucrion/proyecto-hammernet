---
import Layout from '../../layouts/Layout.astro';
const estadoParam = Astro.params.estado || '';
const estadoMap = {
  AUTHORIZED: { label: 'Pago aprobado', cls: 'bg-green-100 text-green-800' },
  REJECTED: { label: 'Pago rechazado', cls: 'bg-red-100 text-red-800' },
  FAILED: { label: 'Pago fallido', cls: 'bg-red-100 text-red-800' },
  ABORTED: { label: 'Pago cancelado por el cliente', cls: 'bg-yellow-100 text-yellow-800' },
  TIMEOUT: { label: 'Pago expirado por tiempo', cls: 'bg-yellow-100 text-yellow-800' },
  ERROR: { label: 'Error de pago', cls: 'bg-red-100 text-red-800' },
};
const estadoInfo = estadoMap[estadoParam] || { label: 'Estado de pago', cls: 'bg-gray-100 text-gray-800' };
---

<Layout title={`Orden de Compra · ${estadoInfo.label}`}>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-4">{estadoInfo.label}</h1>
    <div id="banner" class={`p-3 rounded mb-6 ${estadoInfo.cls}`}></div>

    <div id="estado" class="mb-3 text-gray-700"></div>
    <div id="orden" class="mb-2 text-sm text-gray-600"></div>
    <div id="resumen" class="bg-white rounded shadow p-4 mb-6 hidden">
      <p id="ventaInfo" class="mb-2"></p>
      <p id="clienteInfo" class="mb-2"></p>
      <p id="totalInfo" class="font-semibold"></p>
    </div>
    <div id="items" class="bg-white rounded shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-2">Productos</h2>
      <ul id="itemsList" class="list-disc pl-5"></ul>
    </div>
    <div id="json" class="mt-6 bg-gray-50 rounded p-3 text-xs overflow-auto hidden"></div>
    <div class="mt-6 flex gap-3">
      <a href="/" class="px-4 py-2 bg-blue-600 text-white rounded">Volver al inicio</a>
    </div>
  </div>

  <script type="module">
    (function(){
      async function ensureApiBase(){
        try{const urlParam=new URLSearchParams(window.location.search).get('api');if(urlParam) window.API_BASE=urlParam;const base=window.API_BASE|| (window.__ENV__?.PUBLIC_API_URL || window.__ENV__?.PUBLIC_API_URL_PRODUCTION || '/api');try{const r=await fetch(String(base).replace(/\/$/,'') + '/health',{method:'GET'});if(r&&r.ok){window.API_BASE=base;return;}}catch{}try{const host=window.location.hostname||'';if(/\.onrender\.com$/.test(host)){const alt=`https://${host.replace(/(\.onrender\.com)$/,'-backend$1')}/api`;const r2=await fetch(alt + '/health',{method:'GET'});if(r2&&r2.ok){window.API_BASE=alt;return;}}}catch{} }
      await ensureApiBase();
      const API_BASE = window.API_BASE || 'https://hammernet.onrender.com/api';
      const u = new URL(window.location.href);
      const bo = u.searchParams.get('bo')||'';
      const reason = u.searchParams.get('reason')||'';
      const message = u.searchParams.get('message')||'';
      const estado = '{estadoParam}';
      const banner = document.getElementById('banner');
      const estadoBox = document.getElementById('estado');
      const orden = document.getElementById('orden');
      const resumen = document.getElementById('resumen');
      const ventaInfo = document.getElementById('ventaInfo');
      const clienteInfo = document.getElementById('clienteInfo');
      const totalInfo = document.getElementById('totalInfo');
      const itemsBox = document.getElementById('items');
      const itemsList = document.getElementById('itemsList');
      const jsonBox = document.getElementById('json');
      const verCompras = document.getElementById('verCompras');

      const show = (el) => el.classList.remove('hidden');
      const fmtPrecio = (v) => '$' + Number(v||0).toLocaleString('es-CL');
      const digitsOnly = (s) => String(s||'').replace(/\D/g,'');
      const formatRut = (str) => { const raw=String(str||'').toUpperCase().replace(/[^0-9K]/g,''); if(!raw||raw.length<2) return String(str||''); const body=raw.slice(0,-1); const dv=raw.slice(-1); const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return `${withDots}-${dv}`; };

      const statusMsg = () => {
        if (estado === 'AUTHORIZED') return bo ? `Pago aprobado. Orden ${bo}` : 'Pago aprobado';
        if (estado === 'REJECTED') return `Pago rechazado${reason?`: ${reason}`:''}`;
        if (estado === 'FAILED') return 'Pago fallido';
        if (estado === 'ABORTED') return 'Pago cancelado por el cliente';
        if (estado === 'TIMEOUT') return 'Pago expirado por timeout';
        if (estado === 'ERROR') return `Error de autenticación${message?`: ${message}`:''}`;
      };

      banner.textContent = statusMsg();

      orden.textContent = bo ? `Orden de compra: ${bo}` : '';
      if (!bo) {
        estadoBox.textContent = 'No se realizo una orden de compra';
        if (verCompras) verCompras.href = '/compras';
        return;
      }

      estadoBox.textContent = '';
      fetch(`${API_BASE}/ventas/orden/${encodeURIComponent(bo)}`,{ headers:{ 'Accept':'application/json' }, cache:'no-store'})
        .then(r=>{ if(!r.ok) throw new Error('No encontrada'); return r.json(); })
        .then(data=>{ const idv = Number(data?.id_venta || data?.id); try { sessionStorage.setItem('guest_order_session','1'); localStorage.setItem('guest_order_session','1'); } catch {} if (idv) { window.location.href = `/compra/${idv}?bo=${encodeURIComponent(bo)}`; } else { window.location.href = '/compras?bo='+encodeURIComponent(bo); } })
    })();
  </script>
</Layout>
