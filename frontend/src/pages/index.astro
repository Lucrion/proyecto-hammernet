---
import Layout from '../layouts/Layout.astro';
import EnvLoader from '../components/EnvLoader.astro';
---

<EnvLoader />
<script type="module">
function getApiBase(){try{const env=window.__ENV__||{};return env.PUBLIC_API_URL||env.PUBLIC_API_URL_PRODUCTION||'/api'}catch{return'/api'}}
const API_URL=getApiBase();
async function fetchWithAuth(endpoint,options={}){const headers=options.headers||{};let token='';try{token=sessionStorage.getItem('token')||localStorage.getItem('token')||localStorage.getItem('access_token')||''}catch{}if(token)headers['Authorization']='Bearer '+token;if(!(options.body instanceof FormData)&&!headers['Content-Type'])headers['Content-Type']='application/json';const url=endpoint.startsWith('http')?endpoint:`${API_URL.replace(/\/api$/,'')}${endpoint}`;const c=new AbortController();const t=setTimeout(()=>c.abort(),10000);const res=await fetch(url,{...options,headers,mode:'cors',credentials:'include',signal:c.signal});clearTimeout(t);return res}
async function getData(endpoint){const r=await fetchWithAuth(endpoint,{method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'}});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function postData(endpoint,data){const r=await fetchWithAuth(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(data)});if(!r.ok){throw new Error(`Error ${r.status}: ${await r.text()}`)}return r.json()}
async function checkServerAvailability(){try{const r=await fetchWithAuth('/api/health',{method:'GET'});return { available:r.ok }}catch{return { available:false }}}

const state = {
    token: localStorage.getItem('token'),
    user: JSON.parse(localStorage.getItem('user')),
    carrito: JSON.parse(localStorage.getItem('carrito')) || [],
    productos: []
};

function formatearPrecio(precio) {
    return precio.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

if (typeof AOS !== 'undefined') { AOS.init({ duration: 1000, once: true }); }

function getApiHost() {
    try { const env = window.__ENV__ || {}; const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api'; return api.replace(/\/api$/, ''); } catch { return ''; }
}
function normalizeImageUrl(u) {
    if (!u) return null; const s = String(u); if (/^(https?:\/\/|data:)/i.test(s)) return s; const host = getApiHost(); if (s.startsWith('/')) return host + s; return host + '/' + s;
}

export async function cargarProductosDestacados() {
    try {
        try { await checkServerAvailability(); } catch {}
        mostrarCargando();
        const productos = await getData('/api/productos/catalogo');
        if (!productos || !Array.isArray(productos)) { throw new Error('La respuesta no es un array v√°lido'); }
        const productosDestacados = productos.slice(0, 4);
        state.productos = productosDestacados;
        mostrarProductosDestacados(productosDestacados);
    } catch (error) { console.error('Error al cargar productos destacados:', error); mostrarError('Error al cargar los productos destacados'); }
}

export async function cargarProductosInicio() {
    try {
        try { await checkServerAvailability(); } catch {}
        mostrarCargandoGenerales();
        const productos = await getData('/api/productos/catalogo');
        if (!productos || !Array.isArray(productos)) { throw new Error('La respuesta no es un array v√°lido'); }
        const productosGenerales = productos.slice(0, 4);
        mostrarProductosGenerales(productosGenerales);
    } catch (error) { console.error('Error al cargar productos:', error); mostrarErrorGenerales('Error al cargar los productos'); }
}

function mostrarCargandoGenerales() {
    const contenedor = document.getElementById('productos-inicio'); if (!contenedor) return; contenedor.innerHTML = `
        <div class="col-span-full flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600">Cargando productos...</span>
        </div>
    `;
}

function mostrarErrorGenerales(mensaje) {
    const contenedor = document.getElementById('productos-inicio'); if (!contenedor) return; contenedor.innerHTML = `
        <div class="col-span-full text-center py-12">
            <div class="text-red-600 mb-4">
                <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <p class="text-gray-600">${mensaje}</p>
        </div>
    `;
}

function mostrarProductosGenerales(productos) {
    const contenedor = document.getElementById('productos-inicio'); if (!contenedor) return; contenedor.innerHTML = '';
    productos.forEach(producto => {
        const imagen = normalizeImageUrl(producto.imagen_url) || '/images/placeholder-product.jpg';
        const precioBase = Number(producto.precio_venta ?? producto.precio ?? 0);
        const precio = Number(producto.precio_final ?? precioBase);
        const tieneOferta = Boolean(producto.oferta_activa) || (precioBase > 0 && precio < precioBase);
        const percCalc = tieneOferta ? Math.round((1 - precio / precioBase) * 100) : 0;
        const perc = Number(producto.tipo_oferta === 'porcentaje' ? (producto.valor_oferta ?? percCalc) : percCalc) || 0;
        const id = producto.id_producto ?? producto.id;
        const descripcionCorta = (() => { const d=(producto.descripcion||'').trim(); const dc=d.length>100?d.slice(0,100)+'...':d; return dc; })();
        const productoHTML = `
            <div class="bg-white rounded-xl border border-gray-100 shadow hover:shadow-lg transition-all duration-300 cursor-pointer flex flex-col overflow-hidden" data-aos="fade-up" onclick="verProducto(${id})">
                <div class="relative w-full aspect-square bg-white">
                    ${tieneOferta ? '<span class=\'absolute top-2 left-2 z-10 text-[10px] px-2 py-1 bg-red-100 text-red-700 rounded\'>Oferta</span>' : ''}
                    <div class="absolute inset-2 border border-gray-200 rounded-lg overflow-hidden">
                        <img src="${imagen}" alt="${producto.nombre}" class="w-full h-full object-cover" loading="eager" fetchpriority="high" decoding="async" crossorigin="anonymous" referrerpolicy="no-referrer" />
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-900 mb-1 text-center">${producto.nombre}</h3>
                    ${descripcionCorta ? `<p class="text-gray-600 text-xs mb-3 line-clamp-2 text-center">${descripcionCorta}</p>` : ''}
                    <div class="mt-auto flex items-center justify-center gap-2">
                        ${perc > 0 ? '<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded">-' + perc + '%</span>' : ''}
                        <span class="px-4 py-2 bg-black text-white rounded text-lg font-bold">$${formatearPrecio(precio)}</span>
                    </div>
                </div>
            </div>
        `;
        contenedor.innerHTML += productoHTML;
    });
}

function mostrarProductosDestacados(productos) {
    const contenedor = document.getElementById('productos-destacados'); if (!contenedor) return; contenedor.innerHTML = '';
    productos.forEach(producto => {
        const imagen = normalizeImageUrl(producto.imagen_url) || '/images/placeholder-product.jpg';
        const precioBase = Number(producto.precio_venta ?? producto.precio ?? 0);
        const precio = Number(producto.precio_final ?? precioBase);
        const tieneOferta = Boolean(producto.oferta_activa) || (precioBase > 0 && precio < precioBase);
        const percCalc = tieneOferta ? Math.round((1 - precio / precioBase) * 100) : 0;
        const perc = Number(producto.tipo_oferta === 'porcentaje' ? (producto.valor_oferta ?? percCalc) : percCalc) || 0;
        const id = producto.id_producto ?? producto.id;
        const descripcionCorta = (() => { const d=(producto.descripcion||'').trim(); const dc=d.length>100?d.slice(0,100)+'...':d; return dc; })();
        const productoHTML = `
            <div class="bg-white rounded-xl border border-gray-100 shadow hover:shadow-lg transition-all duration-300 cursor-pointer flex flex-col overflow-hidden" data-aos="fade-up" onclick="verProducto(${id})">
                <div class="relative w-full aspect-square bg-white">
                    ${tieneOferta ? '<span class=\'absolute top-2 left-2 z-10 text-[10px] px-2 py-1 bg-red-100 text-red-700 rounded\'>Oferta</span>' : ''}
                    <div class="absolute inset-2 border border-gray-200 rounded-lg overflow-hidden">
                        <img src="${img}" alt="${p.nombre}" class="w-full h-full object-cover" loading="eager" fetchpriority="high" decoding="async"/>
                    </div>
                </div>
                <div class="p-4 flex-1 flex flex-col">
                    <h3 class="text-sm font-semibold text-gray-900 mb-1 text-center">${producto.nombre}</h3>
                    ${descripcionCorta ? `<p class="text-gray-600 text-xs mb-3 line-clamp-2 text-center">${descripcionCorta}</p>` : ''}
                    <div class="mt-auto flex items-center justify-center gap-2">
                        ${perc > 0 ? '<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded">-' + perc + '%</span>' : ''}
                        <span class="px-4 py-2 bg-black text-white rounded text-lg font-bold">$${formatearPrecio(precio)}</span>
                    </div>
                </div>
            </div>
        `;
        contenedor.innerHTML += productoHTML;
    });
}

function mostrarCargando() {
    const contenedor = document.getElementById('productos-destacados'); if (!contenedor) return; contenedor.innerHTML = `
        <div class="col-span-full flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-600">Cargando productos...</span>
        </div>
    `;
}

function mostrarError(mensaje) {
    const contenedor = document.getElementById('productos-destacados'); if (!contenedor) return; contenedor.innerHTML = `
        <div class="col-span-full text-center py-12">
            <div class="text-red-600 mb-4">
                <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <p class="text-gray-600">${mensaje}</p>
        </div>
    `;
}

export async function enviarMensaje(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    try {
        const result = await postData('/api/mensajes', { nombre: formData.get('nombre'), email: formData.get('email'), asunto: formData.get('asunto'), mensaje: formData.get('mensaje') });
        if (result) { mostrarNotificacion('Mensaje enviado', 'success'); form.reset(); } else { mostrarNotificacion('Error al enviar mensaje', 'error'); }
    } catch (error) { console.error('Error al enviar mensaje:', error); mostrarNotificacion('Error de conexi√≥n', 'error'); }
}

function digitsOnly(str) { try { return (str || '').toString().replace(/\D/g, ''); } catch { return ''; } }

export async function login(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    try {
        const rutInput = formData.get('rut') || formData.get('email') || '';
        const baseRut = rutInput.toString().split('-')[0];
        const username = digitsOnly(baseRut);
        const password = formData.get('password') || '';
        const formEncoded = new URLSearchParams();
        formEncoded.append('username', username);
        formEncoded.append('password', password);
        formEncoded.append('grant_type', 'password');
        const response = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' }, body: formEncoded });
        if (!response.ok) {
            const text = await response.text();
            if (response.status === 401) { mostrarNotificacion('Credenciales incorrectas', 'error'); return; }
            mostrarNotificacion('Error en el login', 'error');
            return;
        }
        const data = await response.json();
        const user = { id_usuario: data.id_usuario, nombre: data.nombre, rut: data.rut ?? username, rol: data.role || 'cliente' };
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('token', data.access_token);
        localStorage.setItem('user', JSON.stringify(user));
        localStorage.setItem('role', user.rol);
        localStorage.setItem('nombreUsuario', user.nombre || user.rut);
        state.user = user; state.token = data.access_token;
        try {
            const userId = user.id_usuario;
            if (userId) {
                const uResp = await fetch(`${API_URL}/usuarios/` + userId, { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${data.access_token}` } });
                if (uResp.ok) { const fullUser = await uResp.json(); if (fullUser && (fullUser.email || fullUser.telefono)) { localStorage.setItem('user', JSON.stringify(fullUser)); state.user = fullUser; } }
            }
        } catch (err) {}
        mostrarNotificacion('Login exitoso', 'success');
        actualizarUI();
        const roleStr = String(state.user?.rol || state.user?.role || '').toLowerCase();
        const workerRolesArr = ['administrador','admin','trabajador','vendedor','bodeguero'];
        const allowWorker = workerRolesArr.includes(roleStr);
        window.location.href = allowWorker ? '/admin' : '/';
    } catch (error) { console.error('Error en login:', error); mostrarNotificacion('Error en el login', 'error'); }
}

export function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('role');
    localStorage.removeItem('nombreUsuario');
    state.token = null; state.user = null; actualizarUI();
}

export function actualizarUI() {
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const isHome = window.location.pathname === '/' || window.location.pathname === '/index.html';
    if (isHome) { if (loginBtn) loginBtn.style.display = 'none'; if (logoutBtn) logoutBtn.style.display = 'none'; if (userInfo) { userInfo.style.display = 'none'; userInfo.textContent = ''; } actualizarContadorCarrito(); return; }
    const isAdmin = state.user && (state.user.rol === 'admin' || state.user.role === 'admin' || state.user.rol === 'administrador' || state.user.role === 'administrador');
    if (state.token && state.user && !isAdmin) { if (loginBtn) loginBtn.style.display = 'none'; if (logoutBtn) logoutBtn.style.display = 'block'; if (userInfo) { userInfo.style.display = 'block'; userInfo.textContent = `Hola, ${state.user.nombre}`; } }
    else { if (loginBtn) loginBtn.style.display = 'block'; if (logoutBtn) logoutBtn.style.display = 'none'; if (userInfo) { userInfo.style.display = 'none'; userInfo.textContent = ''; } }
    actualizarContadorCarrito();
}

export function actualizarContadorCarrito() {
    const contador = document.getElementById('carrito-contador'); const carrito = JSON.parse(localStorage.getItem('carrito')) || []; const totalItems = carrito.reduce((acc, item) => acc + item.cantidad, 0); if (contador) contador.textContent = totalItems;
}

export function mostrarNotificacion(mensaje, tipo = 'success') {
    const notificacion = document.getElementById('notificacion'); if (!notificacion) return; notificacion.textContent = mensaje; notificacion.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg text-white ${tipo === 'success' ? 'bg-green-600' : 'bg-red-600'}`; notificacion.style.display = 'block'; setTimeout(() => { notificacion.style.display = 'none'; }, 3000);
}

window.verProducto = function(id) { window.location.href = `/productos/${id}`; };
window.agregarAlCarrito = async function(id) {
    try {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const productoExistente = carrito.find(item => item.id === id);
        if (productoExistente) { productoExistente.cantidad += 1; }
        else {
            try {
                const producto = await getData(`/api/productos/${id}`);
                const nombre = producto?.nombre || `Producto ${id}`;
                const precio_venta = Number(producto?.precio_final ?? producto?.precio_venta ?? producto?.precio ?? 0);
                const imagen_url = producto?.imagen_url || '/images/logos/herramientas.webp';
                carrito.push({ id, cantidad: 1, nombre, precio_venta, imagen_url });
            } catch (e) { carrito.push({ id, cantidad: 1 }); }
        }
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarContadorCarrito();
        mostrarNotificacion('Producto agregado al carrito', 'success');
    } catch (error) { mostrarNotificacion('No se pudo agregar al carrito', 'error'); }
};

window.enviarMensaje = enviarMensaje;
window.cargarProductosDestacados = cargarProductosDestacados;
window.cargarProductosInicio = cargarProductosInicio;
window.login = login;
window.logout = logout;
window.actualizarUI = actualizarUI;
window.mostrarNotificacion = mostrarNotificacion;

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { actualizarUI(); if (window.location.pathname === '/' || window.location.pathname === '/index.html') { cargarProductosDestacados(); cargarProductosInicio(); } });
} else { actualizarUI(); if (window.location.pathname === '/' || window.location.pathname === '/index.html') { cargarProductosDestacados(); cargarProductosInicio(); } }
</script>

<script>
	// El script del m√≥dulo se encarga de cargar los productos autom√°ticamente
	document.addEventListener('DOMContentLoaded', () => {
		// Obtener referencia al formulario de contacto
		const contactForm = document.getElementById('contactForm');
		
		// Verificar si el formulario existe en la p√°gina
		if (contactForm) {
			// Agregar evento de env√≠o al formulario
			contactForm.addEventListener('submit', (event) => {
				// Llamar a la funci√≥n enviarMensaje importada desde index.js
				if (typeof window.enviarMensaje === 'function') {
					window.enviarMensaje(event);
				}
			});
		}
	});
</script>

<Layout title="Ferreter√≠a Patricio - Herramientas y Materiales de Construcci√≥n">
	<!-- Secci√≥n de usuario autenticado -->
	<div id="user-section" class="fixed top-4 right-4 z-50 hidden">
		<div class="bg-white p-4 rounded-lg shadow-lg">
			<p class="text-gray-800 mb-4">Bienvenido, <span id="user-name"></span></p>
			<button id="logout-button"
				class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors duration-300">
				Cerrar Sesi√≥n
			</button>
		</div>
	</div>

	<!-- Secci√≥n de administrador -->
	<div id="admin-section" class="fixed top-20 right-4 z-50 hidden">
		<div class="bg-white p-4 rounded-lg shadow-lg">
			<a href="/admin" class="block text-center bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors duration-300">
				Panel de Administraci√≥n
			</a>
		</div>
	</div>



	<div class="container mx-auto px-4 py-8">
		<!-- Hero Section -->
		<div class="relative rounded-xl p-12 mb-16 text-white text-center shadow-xl transform hover:scale-[1.02] transition-all duration-300 overflow-hidden" data-aos="fade-up" data-aos-duration="1000">
			<!-- Background Image -->
			<div class="absolute inset-0">
                <img src="/images/logos/herramientas_hombre.webp" alt="Herramientas de construcci√≥n" class="w-full h-full object-cover" loading="eager" fetchpriority="high" decoding="async">
				<div class="absolute inset-0 bg-black bg-opacity-40"></div>
			</div>
			<!-- Content overlay -->
			<div class="relative z-10">
			<div class="max-w-3xl mx-auto">
				<div class="rounded-full overflow-hidden w-56 h-56 mx-auto mb-8 shadow-2xl transform hover:rotate-3 transition-transform duration-500" data-aos="zoom-in" data-aos-delay="200">
                    <img src="/images/logos/logo.webp" alt="Herramientas de construcci√≥n" class="w-full h-full object-cover transform hover:scale-110 transition-transform duration-500" loading="eager" fetchpriority="high" decoding="async">
				</div>
				<h1 class="text-4xl font-bold mb-6 leading-tight">Descubre las mejores herramientas y materiales para la construcci√≥n.</h1>
				<p class="text-xl text-blue-100 mb-8">Tu socio confiable en proyectos de construcci√≥n</p>
				<a href="/productos" class="inline-block bg-white text-blue-600 px-8 py-4 rounded-full font-semibold hover:bg-blue-50 transform hover:scale-105 transition-all duration-300 shadow-md">Ver Productos</a>
			</div>
			</div>
		</div>

		<!-- Features Section -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
			<div class="bg-white p-8 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300" data-aos="fade-up" data-aos-delay="0">
				<div class="text-5xl mb-6 transform hover:rotate-12 transition-transform duration-300">üì¶</div>
				<h3 class="text-2xl font-semibold mb-4 text-gray-800">Variedad</h3>
				<p class="text-gray-600 leading-relaxed">Encuentra variedad, calidad y las mejores marcas para tus proyectos</p>
			</div>
			<div class="bg-white p-8 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300" data-aos="fade-up" data-aos-delay="100">
				<div class="text-5xl mb-6 transform hover:rotate-12 transition-transform duration-300">üí∞</div>
				<h3 class="text-2xl font-semibold mb-4 text-gray-800">Precios bajos</h3>
				<p class="text-gray-600 leading-relaxed">Los mejores precios del mercado garantizados para tu satisfacci√≥n</p>
			</div>
			<div class="bg-white p-8 rounded-xl shadow-lg text-center transform hover:scale-105 transition-all duration-300" data-aos="fade-up" data-aos-delay="200">
				<div class="text-5xl mb-6 transform hover:rotate-12 transition-transform duration-300">‚è∞</div>
				<h3 class="text-2xl font-semibold mb-4 text-gray-800">Soporte 24/7</h3>
				<p class="text-gray-600 leading-relaxed">Expertos capacitados para atenderte todos los d√≠as con las mejores soluciones</p>
			</div>
		</div>

		<!-- Carrusel de productos (m√°ximo 15) -->
		<section class="mb-16" data-aos="fade-up" data-aos-duration="1000">
			<h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Algunos de nuestros productos</h2>
			<div class="relative overflow-hidden">
				<button id="inicio-prev" aria-label="Anterior" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-black text-white shadow rounded-full w-10 h-10 flex items-center justify-center hover:bg-black/90">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
				</button>
				<button id="inicio-next" aria-label="Siguiente" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-black text-white shadow rounded-full w-10 h-10 flex items-center justify-center hover:bg-black/90">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg>
				</button>

				<div id="inicio-carousel" class="flex gap-6 overflow-x-auto pb-2 snap-x snap-mandatory cursor-grab select-none" style="scrollbar-width:none; --cols:4; --gap:1.5rem; padding-left:2.5rem; padding-right:2.5rem; scroll-padding-left:2.5rem; scroll-padding-right:2.5rem;">
					<div class="flex-none w-full text-center py-8 snap-start">
						<div class="animate-pulse flex justify-center">
							<div class="h-4 w-28 bg-gray-200 rounded"></div>
						</div>
						<p class="text-gray-400 mt-4">Cargando carrusel...</p>
					</div>
				</div>
			</div>
			<!-- Bot√≥n √∫nico centrado para ver m√°s productos debajo del carrusel -->
			<div class="mt-8 flex justify-center">
				<a href="/productos" class="px-4 py-2 bg-black text-white rounded font-bold text-xl hover:bg-gray-900 transition-colors duration-200" data-aos="zoom-in">Ver m√°s</a>
			</div>
		</section>

		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const cont = document.getElementById('inicio-carousel');
				const prev = document.getElementById('inicio-prev');
				const next = document.getElementById('inicio-next');
				if (!cont) return;

				const formatearPrecio = (p) => String(Number(p || 0)).replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                async function fetchProductos() {
                    try {
                        const env = window.__ENV__ || {};
                        const apiBase = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
                        await fetch(`${apiBase}/health`).catch(() => {});
                        const res = await fetch(`${apiBase}/productos/catalogo?skip=0&limit=15`);
                        const data = res.ok ? await res.json() : [];
                        render(data);
                        alignToStart();
                    } catch (e) {
                        cont.innerHTML = '<div class="flex-none w-full text-center py-8 snap-start"><p class="text-gray-500">No se pudo cargar el carrusel</p></div>';
                    }
                }

				// Helpers para normalizar URLs de imagen
				function getApiHost() {
					try {
						const env = window.__ENV__ || {};
						const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
						return api.replace(/\/api$/, '');
					} catch { return ''; }
				}
                function normalizeImageUrl(u) {
                    if (!u) return null;
                    const s = String(u);
                    const api = (window.__ENV__?.PUBLIC_API_URL || window.__ENV__?.PUBLIC_API_URL_PRODUCTION || '/api');
                    const origin = api.replace(/\/api$/, '');
                    if (/^https?:\/\//i.test(s)) {
                        try { return `${api}/media?url=${encodeURIComponent(s)}`; } catch { return s; }
                    }
                    if (/^data:/i.test(s)) return s;
                    const base = origin || (typeof location !== 'undefined' ? location.origin : '');
                    if (s.startsWith('/')) return base ? (base + s) : s;
                    return base ? (base + '/' + s) : s;
                }

                function render(items) {
                    cont.innerHTML = items.map((p, idx) => {
                        const id = p.id_producto ?? p.id;
                        const imagen = normalizeImageUrl(p.imagen_url) || '/images/logos/herramientas.webp';
                        const precioBase = Number(p.precio_venta ?? p.precio ?? 0);
                        const precio = Number(p.precio_final ?? precioBase);
                        const tieneOferta = Boolean(p.oferta_activa) || (precioBase > 0 && precio < precioBase);
                        const percCalc = tieneOferta ? Math.round((1 - precio / precioBase) * 100) : 0;
                        const perc = Number(p.tipo_oferta === 'porcentaje' ? (p.valor_oferta ?? percCalc) : percCalc) || 0;
                        const nombre = p.nombre || 'Producto';
                        const desc = (p.descripcion || '').trim();
                        const short = desc.length > 100 ? desc.slice(0, 100) + '...' : desc;
                        const loadingAttr = 'loading="eager" fetchpriority="high" decoding="async"';
                        return `
                            <div class="flex-none bg-white rounded-xl border border-gray-100 shadow hover:shadow-lg transition-all duration-300 cursor-pointer flex flex-col overflow-hidden snap-start inicio-card" style="flex:0 0 calc((100% - (var(--cols) - 1) * var(--gap)) / var(--cols));" onclick="if(!window.__homeDragGuard){ window.location.href='/productos/${id}'; }">
                                <div class="relative w-full aspect-square bg-white">
                                    ${tieneOferta ? '<span class=\'absolute top-2 left-2 z-10 text-[10px] px-2 py-1 bg-red-100 text-red-700 rounded\'>Oferta</span>' : ''}
                                    <div class="absolute inset-2 border border-gray-200 rounded-lg overflow-hidden">
                                        <img src="${imagen}" alt="${nombre}" class="w-full h-full object-cover pointer-events-none select-none" loading="eager" fetchpriority="high" decoding="async" crossorigin="anonymous" referrerpolicy="no-referrer" draggable="false" ondragstart="return false" style="-webkit-user-drag: none; user-drag: none;" />
                                    </div>
                                </div>
                                <div class="p-4 flex-1 flex flex-col">
                                    <h3 class="text-sm font-semibold text-gray-900 mb-1 text-center">${nombre}</h3>
                                    ${short ? `<p class="text-gray-600 text-xs mb-3 line-clamp-2 text-center">${short}</p>` : ''}
                                    <div class="mt-auto flex items-center justify-center gap-2">
                                        ${perc > 0 ? '<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded">-' + perc + '%</span>' : ''}
                                        <span class="px-4 py-2 bg-black text-white rounded text-lg font-bold">$${formatearPrecio(precio)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

				const getGapPx = () => {
					const g = window.getComputedStyle(cont).gap || '24px';
					const first = (g.split(' ')[0] || g).replace('px', '');
					const val = parseFloat(first);
					return isNaN(val) ? 24 : val;
				};
				const getInsetPx = () => {
					const s = window.getComputedStyle(cont);
					const pl = parseFloat((s.paddingLeft || '0').replace('px', '')) || 0;
					const pr = parseFloat((s.paddingRight || '0').replace('px', '')) || 0;
					return { left: pl, right: pr };
				};
				const getCardFullWidth = () => {
					const card = cont.querySelector('.inicio-card');
					if (!card) return 280;
					const rect = card.getBoundingClientRect();
					return Math.round(rect.width + getGapPx());
				};
				const getStep = () => getCardFullWidth();
				const moveInstant = (distance) => { cont.scrollLeft = cont.scrollLeft + distance; };
				const snapToNearest = () => {
					const step = getCardFullWidth();
					const { left: insetLeft } = getInsetPx();
					const left = cont.scrollLeft;
					const relative = left - insetLeft;
					let target = Math.round(relative / step) * step + insetLeft;
					const maxScroll = cont.scrollWidth - cont.clientWidth;
					target = Math.max(0, Math.min(target, maxScroll));
					cont.scrollLeft = target;
				};
				const alignToStart = () => {
					const { left: insetLeft } = getInsetPx();
					cont.scrollLeft = insetLeft;
					snapToNearest();
				};

				prev?.addEventListener('click', () => { moveInstant(-getStep() * 4); snapToNearest(); });
				next?.addEventListener('click', () => { moveInstant(getStep() * 4); snapToNearest(); });

				// Drag para scroll
				let isDown = false, startX = 0, startScroll = 0, moved = false;
				window.__homeDragGuard = false;
				const setGuard = () => { window.__homeDragGuard = true; setTimeout(() => { window.__homeDragGuard = false; }, 150); };
				cont.addEventListener('mousedown', (e) => { isDown = true; moved = false; cont.classList.add('cursor-grabbing'); startX = e.pageX - cont.offsetLeft; startScroll = cont.scrollLeft; });
				cont.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - cont.offsetLeft; const walk = x - startX; cont.scrollLeft = startScroll - walk; if (Math.abs(walk) > 5) moved = true; });
				const endDrag = () => { if (isDown && moved) { setGuard(); snapToNearest(); } isDown = false; moved = false; cont.classList.remove('cursor-grabbing'); };
				cont.addEventListener('mouseleave', endDrag);
				cont.addEventListener('mouseup', endDrag);
				cont.addEventListener('touchstart', (e) => { const t = e.touches[0]; startX = t.pageX - cont.offsetLeft; startScroll = cont.scrollLeft; moved = false; });
				cont.addEventListener('touchmove', (e) => { const t = e.touches[0]; const x = t.pageX - cont.offsetLeft; const walk = x - startX; cont.scrollLeft = startScroll - walk; if (Math.abs(walk) > 3) moved = true; });
				cont.addEventListener('touchend', () => { if (moved) { setGuard(); snapToNearest(); } moved = false; });

				// Alinear al inicio en carga y al redimensionar
				const debounce = (fn, t = 200) => { let id; return (...args) => { clearTimeout(id); id = setTimeout(() => fn(...args), t); }; };
				window.addEventListener('resize', debounce(alignToStart, 200));

				fetchProductos();
			});
		</script>
		<style>
			#inicio-carousel::-webkit-scrollbar { display: none; }
			#inicio-carousel { -ms-overflow-style: none; scrollbar-width: none; }
		</style>

		<!-- Products Section eliminado seg√∫n solicitud -->

		<!-- Why Choose Us Section -->
		<section class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-12 shadow-lg" data-aos="fade-up" data-aos-duration="1000">
			<h2 class="text-3xl font-bold text-center mb-12 text-gray-800">Por qu√© elegir nuestros productos</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
				<div class="space-y-8">
					<div class="flex items-start gap-6 group transform hover:translate-x-2 transition-transform duration-300">
						<span class="text-3xl group-hover:rotate-12 transition-transform duration-300">üîß</span>
						<div>
							<h4 class="text-xl font-semibold mb-2 text-gray-800">Durabilidad Garantizada</h4>
							<p class="text-gray-600 leading-relaxed">Herramientas y materiales resistentes, pensados para acompa√±arte por a√±os</p>
						</div>
					</div>
					<div class="flex items-start gap-6 group transform hover:translate-x-2 transition-transform duration-300">
						<span class="text-3xl group-hover:rotate-12 transition-transform duration-300">üõ†Ô∏è</span>
						<div>
							<h4 class="text-xl font-semibold mb-2 text-gray-800">Todo en Un Lugar</h4>
							<p class="text-gray-600 leading-relaxed">Todo lo que necesitas para reparar, construir o renovar, en un solo lugar</p>
						</div>
					</div>
					<div class="flex items-start gap-6 group transform hover:translate-x-2 transition-transform duration-300">
						<span class="text-3xl group-hover:rotate-12 transition-transform duration-300">‚ö°</span>
						<div>
							<h4 class="text-xl font-semibold mb-2 text-gray-800">Eficiencia y Ahorro</h4>
							<p class="text-gray-600 leading-relaxed">Ahorra tiempo y dinero con productos confiables y de alta calidad</p>
						</div>
					</div>
				</div>
				<div class="rounded-xl overflow-hidden shadow-xl transform hover:scale-105 transition-transform duration-300" data-aos="fade-left" data-aos-delay="200">
                    <img src="/images/logos/herramientas.webp" alt="Colecci√≥n de herramientas" class="w-full" loading="eager" fetchpriority="high" decoding="async">
				</div>
			</div>
		</section>
