---
// No importamos el Layout para evitar superposición
import EnvLoader from '../components/EnvLoader.astro';
---

<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Ferretería Patricio - Herramientas y materiales de construcción">
		<meta name="viewport" content="width=device-width" />
        <link rel="icon" href="/images/logos/logo_bn.webp" type="image/webp" />
        <title>Iniciar Sesión - Ferretería Patricio</title>
		<EnvLoader />
		<script src="https://unpkg.com/htmx.org@1.9.9" integrity="sha384-QFjmbokDn2DjBjq+fM+8LUIVrAgqcNW2s0PjAxHETgRn9l4fvX31ZxDxvwQnyMOX" crossorigin="anonymous"></script>
		<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	</head>
	<body class="min-h-screen bg-gray-100">
		<div class="min-h-screen flex relative">
		<!-- Botón de retorno -->
        <button type="button" class="absolute top-6 left-6 text-gray-600 hover:text-gray-900 transition-colors duration-200" onclick="(history.length>1?history.back():location.href='/')">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </button>
		<!-- Logo Section -->
		<div class="w-1/2 bg-[#2B5BA9] flex items-center justify-center">
			<img src="/images/logos/logo_bn.webp" alt="Ferretería Patricio" class="w-164 h-164">
		</div>

		<!-- Login Form Section -->
		<div class="w-1/2 bg-white flex items-center justify-center p-12">
			<div class="w-full max-w-md">
				<div class="flex justify-center mb-8">
					<img src="/images/logos/hammernet.webp" alt="Hammernet" class="h-20">
				</div>

				<h2 class="text-2xl font-semibold text-gray-900 mb-8">Inicio de sesión</h2>

                <form id="loginForm" class="space-y-6" method="post" onsubmit="return false">
					<div class="space-y-4">
						<div>
							<label id="usernameLabel" for="username" class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
                                <input
                                id="username"
                                name="username"
                                type="text"
                                maxlength="13"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                inputmode="numeric"
                                autocomplete="username"
                                placeholder="20.347.793-7"
                            >
						</div>
						<div>
							<label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
							<input
								id="password"
								name="password"
								type="password"
								required
								class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
								placeholder="****************"
							>
						</div>
					</div>

					<div>
						<button
							id="loginButton"
							type="submit"
							class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
						>
							<span>Iniciar</span>
							<span id="loadingSpinner" class="hidden ml-2">
								<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
									<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
									<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
								</svg>
							</span>
						</button>
					</div>
					<div id="statusMessage" class="mt-2 text-sm text-center hidden"></div>
            <p class="text-center text-sm text-gray-600 mt-4 hidden">Modo de acceso: Cliente</p>
            <div id="createAccountContainer" class="mt-6 flex justify-center">
              <a href="/registro" class="px-4 py-2 bg-black text-white rounded font-bold hover:bg-gray-900 transition-colors duration-200">Crear cuenta</a>
            </div>

				</form>
			</div>
		</div>
	</div>
	</body>
</html>

    <script type="module">
// Configuración centralizada (inline)
function getApiBase(){try{const env=window.__ENV__||{};return env.PUBLIC_API_URL||env.PUBLIC_API_URL_PRODUCTION||'/api'}catch{return'/api'}}
const API_URL=getApiBase();
const API_TIMEOUT=10000;
const corsConfig={ mode:'cors', credentials:'include' };
const defaultHeaders={ 'Content-Type':'application/x-www-form-urlencoded','Accept':'application/json' };
// Utilidades RUT inline
function digitsOnly(v){return String(v||'').replace(/\D/g,'')}
function formatRutUI(v){const s=String(v||'').replace(/[^0-9kK]/g,'').toUpperCase();if(!s)return'';if(s.length===1)return s;const body=s.slice(0,-1);const dv=s.slice(-1);const withDots=body.replace(/\B(?=(\d{3})+(?!\d))/g,'.');return `${withDots}-${dv}`}
function formatRutFromDigits(d){const s=String(d||'').replace(/\D/g,'');if(!s)return'';return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.')}

async function checkServerAvailability() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT / 2);
        const response = await fetch(`${API_URL}/health`, { method: 'GET', signal: controller.signal });
        clearTimeout(timeoutId);
        return { available: response.ok, message: 'Servidor disponible' };
    } catch (error) {
        return { available: false, message: error.name === 'AbortError' ? 'Tiempo de espera agotado al conectar con el servidor' : `Error de conexión: ${error.message}` };
    }
}

function handleApiError(error) {
    if (error.name === 'AbortError') return { type: 'timeout', message: 'La solicitud ha excedido el tiempo de espera', original: error };
    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) return { type: 'connection', message: 'No se pudo conectar con el servidor', original: error };
    return { type: 'unknown', message: error.message || 'Error desconocido', original: error };
}

function showStatus(message, type = 'info') {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.className = 'mt-2 text-sm text-center';
    statusMessage.classList.add(type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : type === 'warning' ? 'text-yellow-600' : 'text-gray-600');
    statusMessage.classList.remove('hidden');
}

function showLoading(isLoading) {
    const loginButton = document.getElementById('loginButton');
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (isLoading) { loadingSpinner.classList.remove('hidden'); loginButton.disabled = true; loginButton.classList.add('opacity-75'); }
    else { loadingSpinner.classList.add('hidden'); loginButton.disabled = false; loginButton.classList.remove('opacity-75'); }
}

async function handleLogin(e) {
    e.preventDefault();
    const params = new URLSearchParams(window.location.search);
    const tipoSeleccionado = params.get('tipo') || localStorage.getItem('loginTipo');
    const usernameInput = document.getElementById('username').value.trim();
    const baseRut = usernameInput.includes('-') ? usernameInput.split('-')[0] : usernameInput;
    const username = digitsOnly(baseRut);
    const password = document.getElementById('password').value;
    if (!username || !password) { showStatus('Por favor, ingrese RUT y contraseña', 'error'); return; }
    showLoading(true);
    showStatus('Verificando credenciales...', 'info');
    const serverAvailable = await checkServerAvailability();
    if (!serverAvailable.available) { showStatus('No se pudo verificar el servidor. Intentando iniciar sesión...', 'info'); }
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);
        formData.append('grant_type', 'password');
        const fetchOptions = { method: 'POST', body: formData, signal: controller.signal, ...corsConfig, headers: defaultHeaders };
        let response = await fetch(`${API_URL}/auth/login`, fetchOptions);
        clearTimeout(timeoutId);
        if (!response.ok) {
            const errorText = await response.text();
            let errorMessage = `Error de autenticación (${response.status})`;
            try {
                const errorData = JSON.parse(errorText);
                if (errorData.detail) errorMessage = typeof errorData.detail === 'string' ? errorData.detail : JSON.stringify(errorData.detail);
                else if (errorData.message) errorMessage = errorData.message; else errorMessage = JSON.stringify(errorData);
            } catch (e) {
                errorMessage += ` - Respuesta: ${errorText.substring(0, 100)}${errorText.length > 100 ? '...' : ''}`;
            }
            if (response.status === 422) errorMessage = `Error 422: Datos no procesables. ${errorMessage}. Verifique la consola para más detalles.`;
            if (response.status === 401) errorMessage = 'Credenciales incorrectas';
            showStatus(errorMessage, 'error');
            showLoading(false);
            return;
        }
        const data = await response.json();
        const user = {
            id_usuario: data.id_usuario,
            nombre: data.nombre,
            apellido: data.apellido ?? data.apellidos ?? data.last_name,
            email: data.email ?? data.correo ?? data.mail,
            telefono: data.telefono ?? data.phone ?? data.celular,
            rut: data.rut ?? digitsOnly(usernameInput),
            rol: data.role || data.rol || 'cliente'
        };
        const workerRoles = ['administrador','admin','trabajador','vendedor','bodeguero'];
        const storage = (tipoSeleccionado === 'trabajador') ? window.sessionStorage : window.localStorage;
        storage.setItem('isLoggedIn', 'true');
        storage.setItem('token', data.access_token);
        storage.setItem('user', JSON.stringify(user));
        storage.setItem('role', user.rol);
        storage.setItem('nombreUsuario', user.nombre || formatRutFromDigits(user.rut));
        document.cookie = `isLoggedIn=true; path=/; SameSite=Lax`;
        document.cookie = `role=${encodeURIComponent(user.rol)}; path=/; SameSite=Lax`;
        document.cookie = `loginTipo=${encodeURIComponent(tipoSeleccionado || '')}; path=/; SameSite=Lax`;
        try {
            const uResp = await fetch(`${API_URL}/usuarios/${user.id_usuario}`, { headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${data.access_token}` } });
            if (uResp.ok) {
                const fullUser = await uResp.json();
                if (fullUser && (fullUser.email || fullUser.telefono)) { storage.setItem('user', JSON.stringify(fullUser)); }
            }
        } catch (err) {}
        showStatus('Autenticación exitosa. Redirigiendo...', 'success');
        const roleStr = String(user.rol || user.role || '').toLowerCase();
        const allowWorker = workerRoles.includes(roleStr);
        const tipoFinal = tipoSeleccionado ? tipoSeleccionado : (allowWorker ? 'trabajador' : 'cliente');
        const destino = tipoFinal === 'trabajador' ? '/admin' : '/';
        setTimeout(() => { window.location.href = destino; }, 800);
    } catch (error) {
        showLoading(false);
        const errorInfo = handleApiError(error);
        if (error.message && (error.message.includes('credenciales') || error.message.includes('credentials'))) showStatus('Credenciales incorrectas', 'error');
        else showStatus('Error de autenticación: ' + errorInfo.message, 'error');
    }
}

function showGoogleLoading(isLoading) {
    const googleButton = document.getElementById('googleLoginButton');
    const googleSpinner = document.getElementById('googleLoginLoadingSpinner');
    if (googleButton && googleSpinner) { if (isLoading) { googleButton.disabled = true; googleSpinner.classList.remove('hidden'); } else { googleButton.disabled = false; googleSpinner.classList.add('hidden'); } }
}

async function handleGoogleAuth() {
    try { showGoogleLoading(true); showStatus('Redirigiendo a Google...', 'info'); window.location.href = `${API_URL}/auth/google`; }
    catch (error) { showStatus('Error al conectar con Google. Inténtalo de nuevo.', 'error'); showGoogleLoading(false); }
}

function checkGoogleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const error = urlParams.get('error');
    if (token) { localStorage.setItem('token', token); showStatus('¡Inicio de sesión exitoso con Google!', 'success'); setTimeout(() => { window.location.href = '/dashboard'; }, 1000); return true; }
    else if (error) { showStatus(`Error de autenticación: ${error}`, 'error'); window.history.replaceState({}, document.title, window.location.pathname); return true; }
    return false;
}

document.addEventListener('DOMContentLoaded', async () => {
    const loginForm = document.getElementById('loginForm');
    const googleLoginButton = document.getElementById('googleLoginButton');
    const usernameEl = document.getElementById('username');
    const usernameLabel = document.getElementById('usernameLabel');
    const createAccountContainer = document.getElementById('createAccountContainer');
    if (checkGoogleCallback()) { return; }
    const params = new URLSearchParams(window.location.search);
    const tipoSeleccionado = params.get('tipo') || localStorage.getItem('loginTipo');
    if (tipoSeleccionado === 'trabajador' && createAccountContainer) { createAccountContainer.classList.add('hidden'); }
    if (usernameLabel) usernameLabel.textContent = 'RUT';
    if (usernameEl) usernameEl.placeholder = '20.347.793-7';
    try {
        const storagePrimary = (tipoSeleccionado === 'trabajador') ? window.sessionStorage : window.localStorage;
        const storageSecondary = (tipoSeleccionado === 'trabajador') ? window.localStorage : window.sessionStorage;
        const userStr = storagePrimary.getItem('user') || storageSecondary.getItem('user');
        if (userStr && usernameEl) { const u = JSON.parse(userStr); const rutDigits = (u && u.rut) || ''; if (rutDigits) { usernameEl.value = formatRutFromDigits(rutDigits); } }
    } catch {}
    const serverStatus = await checkServerAvailability();
    if (!serverStatus.available) { showStatus('No se pudo verificar el servidor. Puedes intentar iniciar sesión.', 'info'); }
    if (loginForm) { loginForm.addEventListener('submit', handleLogin); }
    if (usernameEl) { usernameEl.addEventListener('input', (e) => { const formatted = formatRutUI(e.target.value); e.target.value = formatted; e.target.selectionStart = e.target.selectionEnd = formatted.length; }); }
    if (googleLoginButton) { googleLoginButton.addEventListener('click', handleGoogleAuth); }
});
    </script>
    <script>
      (function(){
        try {
          const env = window.__ENV__ || {};
          const api = env.PUBLIC_API_URL || env.PUBLIC_API_URL_PRODUCTION || '/api';
          if (!window.API_BASE) window.API_BASE = api;
          if (!window.__API_BASE_LOGGED__) { console.log('Cargando script de login...'); console.log('API URL es:', window.API_BASE); window.__API_BASE_LOGGED__ = true; }
        } catch {}
      })();
    </script>
