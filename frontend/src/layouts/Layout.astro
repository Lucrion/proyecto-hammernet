---
interface Props {
	title: string;
}

const { title } = Astro.props;
import EnvLoader from '../components/EnvLoader.astro';
import Footer from '../components/Footer.astro';
// Determinar origen de la API para preconnect/dns-prefetch en producción
const env = import.meta.env.PUBLIC_ENVIRONMENT;
const apiUrl = env === 'development' ? import.meta.env.PUBLIC_API_URL : import.meta.env.PUBLIC_API_URL_PRODUCTION;
let apiOrigin = '';
try {
  if (apiUrl && apiUrl.startsWith('http')) {
    apiOrigin = new URL(apiUrl).origin;
  }
} catch {}
---

<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Ferretería Patricio - Herramientas y materiales de construcción">
		<meta name="viewport" content="width=device-width" />
        {apiOrigin && (
          <>
            <link rel="preconnect" href={apiOrigin} crossorigin>
            <link rel="dns-prefetch" href={apiOrigin}>
          </>
        )}
		<link rel="preconnect" href="https://picsum.photos" crossorigin>
		<link rel="dns-prefetch" href="https://picsum.photos">
        <link rel="icon" href="/images/logos/logo_bn.webp" type="image/webp" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<script src="https://unpkg.com/htmx.org@1.9.9" integrity="sha384-QFjmbokDn2DjBjq+fM+8LUIVrAgqcNW2s0PjAxHETgRn9l4fvX31ZxDxvwQnyMOX" crossorigin="anonymous"></script>
        <script type="module" src="/scripts/user-icon.js"></script>
	</head>
	<body class="min-h-screen bg-gray-100">
		{Astro.url.pathname !== '/login' && (
			<header class="bg-white shadow-md relative z-30">
				<nav class="container mx-auto px-4 py-3 flex items-center justify-between">
					<a href="/" class="flex items-center">
						<img src="/images/logos/logo_bn.webp" alt="Ferretería Patricio" class="h-16" />
					</a>
                    <div class="flex items-center space-x-6 relative">
						<a href="/" class="text-gray-700 hover:text-blue-600">Inicio</a>
						<a href="/productos" class="text-gray-700 hover:text-blue-600">Productos</a>
						<a href="/nosotros" class="text-gray-700 hover:text-blue-600">Nosotros</a>
						<a href="/contacto" class="text-gray-700 hover:text-blue-600">Contáctanos</a>
                        <div class="relative w-56 h-8 overflow-visible">
                            <div id="userIconContainer" class="absolute inset-0 flex items-center justify-center">
                                <button id="userIconBtn" class="text-gray-700 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-50 rounded-full p-1">
                                    <img src="/images/icons/usuario.svg" alt="Usuario" class="h-6 w-6" />
                                </button>
                            </div>
                            <div id="loginButtonContainer" class="absolute inset-0 flex items-center justify-center transform translate-x-full opacity-0">
                                <a href="/login" id="login-link" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-1.5 rounded-lg shadow-md whitespace-nowrap text-sm font-medium">Iniciar Sesión</a>
                            </div>
                            <div id="userLoggedContainer" class="absolute inset-0 hidden items-center justify-center gap-2">
                                <span id="userNameDisplay" class="text-gray-700 font-medium truncate max-w-[8rem]"></span>
                                <div class="relative">
                                    <button id="userMenuButton" class="text-gray-700 hover:text-blue-600 focus:outline-none rounded-full p-1" aria-haspopup="true" aria-expanded="false">
                                        <img src="/images/icons/usuario.svg" alt="Usuario" class="h-5 w-5" />
                                    </button>
                                    <div id="userMenuDropdown" class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-md shadow-lg hidden z-50">
                                        <a href="/perfil" id="menuVerPerfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver perfil</a>
                                        <a href="/compras" id="menuVerCompras" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver compras</a>
                                        <button id="menuCerrarSesion" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Cerrar sesión</button>
                                    </div>
                                </div>
                            </div>
                        </div>
					<!-- Botón Carrito -->
					<button id="carritoBtn" class="relative text-black hover:text-black focus:outline-none cursor-pointer" aria-label="Carrito">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l3-8H6l1 8zm-1 0a1 1 0 100 2 1 1 0 000-2zm12 0a1 1 0 100 2 1 1 0 000-2z" />
                            </svg>
                            <span id="carrito-contador" class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs rounded-full px-2 py-0.5" style="display:none">0</span>
                        </button>
					</div>
				</nav>
			</header>
		)}
		<main>
			<slot />
		</main>

		{Astro.url.pathname !== '/login' && (
			<Footer />
		)}

		{Astro.url.pathname !== '/login' && (
			<a 
				href="https://wa.me/956998116663?text=Hola, me gustaría obtener más información"
				class="fixed bottom-6 right-6 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-all transform hover:scale-110 z-50"
				target="_blank"
				aria-label="Contactar por WhatsApp"
			>
				<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
					<path d="M20.4 3.6C18.2 1.3 15.2 0 12 0 5.4 0 0 5.4 0 12c0 2.1.5 4.2 1.5 6L0 24l6.2-1.4c1.8.9 3.8 1.4 5.8 1.4 6.6 0 12-5.4 12-12 0-3.2-1.3-6.2-3.6-8.4zM12 22c-1.8 0-3.5-.5-5.1-1.3l-.4-.2-3.7.8.9-3.6-.2-.4c-1-1.6-1.5-3.4-1.5-5.3 0-5.5 4.5-10 10-10s10 4.5 10 10-4.5 10-10 10zm5.5-7.4c-.3-.1-1.8-.9-2.1-1-.3-.1-.5-.1-.7.1-.2.2-.8.9-1 1.1-.2.2-.3.2-.6.1-1.7-.8-2.8-1.5-3.9-3.4-.3-.5.3-.5.8-1.6.1-.2 0-.4 0-.5s-.7-1.7-1-2.4c-.3-.6-.6-.5-.8-.5h-.6c-.2 0-.5.1-.8.3-.3.3-1 1-1 2.4s1 2.8 1.2 3c.2.2 2.1 3.2 5.1 4.5.7.3 1.3.5 1.7.6.7.2 1.4.2 1.9.1.6-.1 1.8-.7 2-1.4.2-.7.2-1.3.2-1.4 0-.2-.2-.3-.5-.4z"/>
				</svg>
			</a>
		)}

		<!-- Modal selección de rol para login -->
		<div id="login-role-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50" style="display:none">
			<div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
				<h3 class="text-xl font-semibold mb-4">¿Cómo deseas iniciar sesión?</h3>
				<p class="text-gray-600 mb-6">Selecciona una opción para continuar</p>
                <div class="grid grid-cols-3 gap-4">
                    <button id="btnLoginCliente" class="bg-blue-600 text-white py-3 rounded hover:bg-blue-700">Cliente</button>
                    <button id="btnLoginTrabajador" class="bg-gray-800 text-white py-3 rounded hover:bg-gray-900">Trabajador</button>
                    <button id="btnLoginInvitado" class="bg-green-600 text-white py-3 rounded hover:bg-green-700">Invitado</button>
                </div>
				<button id="cerrarModalLogin" class="mt-6 w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">Cancelar</button>
			</div>
		</div>

		<!-- Panel lateral del carrito -->
		<div id="carrito-panel" class="fixed top-0 right-0 w-80 h-full bg-white shadow-xl transform translate-x-full transition-transform z-50">
			<div class="p-4 border-b flex justify-between items-center">
				<h3 class="text-lg font-semibold">Tu carrito</h3>
				<button id="cerrarCarrito" class="text-gray-500 hover:text-gray-800 text-2xl leading-none p-2 rounded focus:outline-none focus:ring-2 focus:ring-gray-300 cursor-pointer" aria-label="Cerrar">&times;</button>
			</div>
			<div id="carrito-items" class="p-4 space-y-4"></div>
			<div class="p-4 border-t">
				<div class="flex justify-between mb-4">
					<span class="font-medium">Subtotal</span>
					<span id="carrito-subtotal" class="font-bold">$0</span>
				</div>
				<button id="checkoutBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Ir a pagar</button>
			</div>
		</div>

		<script>
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    const u = new URL(window.location.href);
                    const err = u.searchParams.get('error');
                    if (err === 'unauthorized_admin') {
                        const toast = document.createElement('div');
                        toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded shadow z-50';
                        toast.textContent = 'Acceso denegado: tu cuenta no tiene permisos de administración';
                        document.body.appendChild(toast);
                        setTimeout(() => { try { document.body.removeChild(toast); } catch {} }, 4000);
                        u.searchParams.delete('error');
                        const qs = u.searchParams.toString();
                        history.replaceState({}, '', u.pathname + (qs ? ('?' + qs) : '') + u.hash);
                    }
                } catch {}
                try {
                    const url = new URL(window.location.href);
                    const paid = url.searchParams.get('paid');
                    const clear = url.searchParams.get('clear') || url.searchParams.get('clearCart');
                    if (paid === '1' || clear === '1') {
                        try {
                            localStorage.removeItem('carrito');
                            localStorage.removeItem('checkout_items');
                            localStorage.removeItem('checkoutEntrega');
                        } catch {}
                        try { window.dispatchEvent(new Event('carrito:changed')); } catch {}
                        url.searchParams.delete('paid');
                        url.searchParams.delete('clear');
                        url.searchParams.delete('clearCart');
                        const qs = url.searchParams.toString();
                        history.replaceState({}, '', url.pathname + (qs ? ('?' + qs) : '') + url.hash);
                    }
                } catch {}
                try {
                    const url = new URL(window.location.href);
                    const status = url.searchParams.get('payment_status');
                    const reason = url.searchParams.get('reason');
                    const message = url.searchParams.get('message');
                    const bo = url.searchParams.get('bo');
                    if (status) {
                        const toast = document.createElement('div');
                        let cls = 'fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded shadow z-50 ';
                        let txt = 'Pago procesado';
                        if (status === 'AUTHORIZED') { cls += 'bg-green-600 text-white'; txt = 'Pago aprobado'; if (bo) txt += ` · Orden ${bo}`; }
                        else if (status === 'REJECTED' || status === 'FAILED') { cls += 'bg-red-600 text-white'; txt = 'Pago rechazado'; if (reason) txt += `: ${reason}`; }
                        else if (status === 'ABORTED') { cls += 'bg-yellow-500 text-white'; txt = 'Pago cancelado por el cliente'; }
                        else if (status === 'TIMEOUT') { cls += 'bg-yellow-600 text-white'; txt = 'Pago expirado por timeout'; }
                        else if (status === 'ERROR') { cls += 'bg-red-700 text-white'; txt = 'Error de autenticación'; if (message) txt += `: ${message}`; }
                        toast.className = cls;
                        toast.textContent = txt;
                        document.body.appendChild(toast);
                        setTimeout(() => { try { document.body.removeChild(toast); } catch {} }, 4500);
                        url.searchParams.delete('payment_status');
                        url.searchParams.delete('reason');
                        url.searchParams.delete('message');
                        url.searchParams.delete('bo');
                        const qs = url.searchParams.toString();
                        history.replaceState({}, '', url.pathname + (qs ? ('?' + qs) : '') + url.hash);
                    }
                } catch {}
			  const loginLink = document.getElementById('login-link');
		  const modal = document.getElementById('login-role-modal');
          const btnCliente = document.getElementById('btnLoginCliente');
          const btnTrabajador = document.getElementById('btnLoginTrabajador');
          const btnInvitado = document.getElementById('btnLoginInvitado');
		  const cerrarModalLogin = document.getElementById('cerrarModalLogin');
          const userLoggedContainer = document.getElementById('userLoggedContainer');
          const userNameDisplay = document.getElementById('userNameDisplay');
          const userIconContainer = document.getElementById('userIconContainer');
          const userMenuButton = document.getElementById('userMenuButton');
          const userMenuDropdown = document.getElementById('userMenuDropdown');
          const menuCerrarSesion = document.getElementById('menuCerrarSesion');

		  if (loginLink) {
		    loginLink.addEventListener('click', (e) => {
		      e.preventDefault();
		      modal.style.display = 'flex';
		    });
		  }
          const goToLogin = (tipo) => {
            localStorage.setItem('loginTipo', tipo);
            const dest = tipo === 'trabajador' ? '/login-trabajador' : (tipo === 'cliente' ? '/login-cliente' : '/orden-compra');
            window.location.href = dest;
          };
          btnCliente && btnCliente.addEventListener('click', () => goToLogin('cliente'));
          btnTrabajador && btnTrabajador.addEventListener('click', () => goToLogin('trabajador'));
          btnInvitado && btnInvitado.addEventListener('click', () => goToLogin('invitado'));
		  cerrarModalLogin && cerrarModalLogin.addEventListener('click', () => {
		    modal.style.display = 'none';
		  });

          // Mostrar nombre y tuerca si está logueado como cliente
          try {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const token = localStorage.getItem('token');
            const tipo = localStorage.getItem('loginTipo') || 'cliente';
            const userRaw = localStorage.getItem('user');
            const user = userRaw ? JSON.parse(userRaw) : null;
            const nombreUsuario = (user && user.nombre) || localStorage.getItem('nombreUsuario') || '';
            const rol = (user && (user.rol || user.role)) || 'cliente';

            if (isLoggedIn && token && (tipo === 'cliente' || rol !== 'admin')) {
              if (userNameDisplay) userNameDisplay.textContent = nombreUsuario || 'Cliente';
              if (userLoggedContainer) {
                userLoggedContainer.classList.remove('hidden');
                userLoggedContainer.classList.add('flex');
              }
              if (userIconContainer) userIconContainer.style.display = 'none';
            }
          } catch {}

          // Menú de usuario (toggle y cierre fuera)
          const toggleUserMenu = (open) => {
            if (!userMenuDropdown || !userMenuButton) return;
            const isOpen = open ?? userMenuDropdown.classList.contains('hidden');
            if (isOpen) {
              userMenuDropdown.classList.remove('hidden');
              userMenuButton.setAttribute('aria-expanded', 'true');
            } else {
              userMenuDropdown.classList.add('hidden');
              userMenuButton.setAttribute('aria-expanded', 'false');
            }
          };

          userMenuButton && userMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const hidden = userMenuDropdown?.classList.contains('hidden');
            toggleUserMenu(hidden);
          });

          document.addEventListener('click', (e) => {
            if (!userMenuDropdown || !userMenuButton) return;
            const within = userMenuDropdown.contains(e.target) || userMenuButton.contains(e.target);
            if (!within) toggleUserMenu(false);
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') toggleUserMenu(false);
          });

          // Acción de cerrar sesión
          menuCerrarSesion && menuCerrarSesion.addEventListener('click', () => {
            try {
              // Limpiar también sessionStorage por si el trabajador inició con sesión no persistente
              sessionStorage.removeItem('isLoggedIn');
              sessionStorage.removeItem('token');
              sessionStorage.removeItem('user');
              sessionStorage.removeItem('role');
              sessionStorage.removeItem('nombreUsuario');
            } catch {}
            try {
              localStorage.removeItem('isLoggedIn');
              localStorage.removeItem('token');
              localStorage.removeItem('user');
              localStorage.removeItem('role');
              // Mantener loginTipo para experiencia, opcionalmente limpiar si quieres: localStorage.removeItem('loginTipo')
              localStorage.removeItem('nombreUsuario');
            } catch {}
            toggleUserMenu(false);
            // Restaurar UI
            if (userLoggedContainer) {
              userLoggedContainer.classList.add('hidden');
              userLoggedContainer.classList.remove('flex');
            }
            if (userIconContainer) userIconContainer.style.display = '';
            // Redirigir al inicio
            window.location.href = '/';
          });

		  // Carrito
		  const carritoBtn = document.getElementById('carritoBtn');
		  const carritoPanel = document.getElementById('carrito-panel');
		  const cerrarCarrito = document.getElementById('cerrarCarrito');
		  const itemsContainer = document.getElementById('carrito-items');
		  const subtotalEl = document.getElementById('carrito-subtotal');
		  const checkoutBtn = document.getElementById('checkoutBtn');

			  const formatearPrecio = (precio) => precio.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');

			  const getCarrito = () => {
				try {
				  const c = JSON.parse(localStorage.getItem('carrito')) || [];
				  return Array.isArray(c) ? c : [];
				} catch {
				  return [];
				}
			  };

		  const setCarrito = (carrito) => {
			try { localStorage.setItem('carrito', JSON.stringify(carrito)); } catch {}
		  };

		  const eliminarItem = (id) => {
			const carrito = getCarrito().filter(i => String(i.id) !== String(id));
			setCarrito(carrito);
			renderCarrito();
			// Notificar otros componentes/páginas para sincronizar vista
			try { window.dispatchEvent(new Event('carrito:changed')); } catch {}
		  };

		  // Exponer eliminación al ámbito global para uso en botones inline
		  window.eliminarItem = eliminarItem;

		  const isPlaceholderImage = (url) => {
			if (!url) return true;
			const u = String(url);
			return u.includes('/images/logos/logo_bn.webp') || u.includes('/images/logos/herramientas.webp') || u.includes('placeholder');
		  };

          const getProductoInfo = async (id) => {
            try {
              const base = window.API_BASE || '/api';
              const res = await fetch(`${base}/productos/${id}`);
              if (!res.ok) return null;
              return await res.json();
            } catch { return null; }
          };

		  const normalizeCarrito = async (carrito) => {
			let changed = false;
			const updated = await Promise.all(carrito.map(async (item) => {
			  if (item.imagen_url && !isPlaceholderImage(item.imagen_url)) return item;
			  const info = await getProductoInfo(item.id);
			  if (info) {
				changed = true;
				return {
				  ...item,
				  imagen_url: info.imagen_url || item.imagen_url,
				  nombre: item.nombre ?? info.nombre,
				  precio_venta: item.precio_venta ?? info.precio_venta ?? info.precio
				};
			  }
			  return item;
			}));
			if (changed) localStorage.setItem('carrito', JSON.stringify(updated));
			return updated;
		  };

		  const renderCarrito = async () => {
		    const carrito = await normalizeCarrito(getCarrito());
		    if (!itemsContainer || !subtotalEl) return;
		    if (carrito.length === 0) {
		      itemsContainer.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';
		      subtotalEl.textContent = '$0';
		    } else {
				  itemsContainer.innerHTML = carrito.map(item => `
					<div class="flex items-center gap-3">
					  <img src="${item.imagen_url || '/images/logos/herramientas.webp'}" onerror="this.src='/images/logos/herramientas.webp';this.onerror=null;" class="w-12 h-12 object-cover rounded" alt="${item.nombre}">
					  <div class="flex-1">
						<p class="text-sm font-medium flex items-center gap-2">
						  <span class="truncate">${item.nombre}</span>
						  <button class="text-gray-500 hover:text-red-600" aria-label="Quitar" onclick="eliminarItem('${item.id}')">&times;</button>
						</p>
						<p class="text-xs text-gray-500">Cantidad: ${item.cantidad}</p>
					  </div>
					  <div class="text-sm font-semibold">$${formatearPrecio(Number(item.precio_venta ?? item.precio) * item.cantidad)}</div>
					</div>
				  `).join('');
		      const subtotal = carrito.reduce((acc, it) => acc + Number(it.precio_venta ?? it.precio) * it.cantidad, 0);
		      subtotalEl.textContent = `$${formatearPrecio(subtotal)}`;
		    }
		    // Actualizar badge si existe
		    const contador = document.getElementById('carrito-contador');
		    if (contador) {
		      const totalItems = carrito.reduce((t, it) => t + it.cantidad, 0);
		      contador.textContent = totalItems;
		      contador.style.display = totalItems > 0 ? 'block' : 'none';
		    }
		  };

		  const openCarrito = async () => {
		    await renderCarrito();
		    carritoPanel && (carritoPanel.style.transform = 'translateX(0)');
		  };
		  const closeCarrito = () => {
		    carritoPanel && (carritoPanel.style.transform = 'translateX(100%)');
		  };

		  carritoBtn && carritoBtn.addEventListener('click', openCarrito);
		  cerrarCarrito && cerrarCarrito.addEventListener('click', closeCarrito);
		  checkoutBtn && checkoutBtn.addEventListener('click', () => {
		    const carrito = getCarrito();
		    if (!carrito.length) {
		      alert('Tu carrito está vacío. Agrega productos antes de continuar.');
		      return;
		    }
		    // Opcional: sincronizar items para checkout
		    localStorage.setItem('checkout_items', JSON.stringify(carrito));
		    window.location.href = '/carrito';
		  });

		  // Actualizar badge y panel sin interacción:
		  // 1) Al cargar la página
		  renderCarrito();
		  // 2) Cuando cambia localStorage desde cualquier pestaña
		  window.addEventListener('storage', (e) => { if (e.key === 'carrito') renderCarrito(); });
		  // 3) Evento personalizado para cambios locales
		  window.addEventListener('carrito:changed', () => { renderCarrito(); });
		  // 4) Al volver a la pestaña
		  document.addEventListener('visibilitychange', () => { if (!document.hidden) renderCarrito(); });
		});
		</script>
	</body>
</html>
