<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Productos - Ferreter√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .producto-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .producto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .stock-bajo {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .stock-ok {
            background-color: #dcfce7;
            color: #16a34a;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold">üîß Ferreter√≠a Online</h1>
                <div class="flex items-center space-x-4">
                    <button id="btnLogin" class="bg-blue-500 hover:bg-blue-700 px-4 py-2 rounded">
                        Iniciar Sesi√≥n
                    </button>
                    <button id="btnLogout" class="bg-red-500 hover:bg-red-700 px-4 py-2 rounded hidden">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Filtros -->
    <section class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-64">
                    <input 
                        type="text" 
                        id="filtroNombre" 
                        placeholder="Buscar productos..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                <div>
                    <select id="filtroCategoria" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div>
                    <select id="filtroOrden" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="nombre">Ordenar por nombre</option>
                        <option value="precio_asc">Precio: menor a mayor</option>
                        <option value="precio_desc">Precio: mayor a menor</option>
                    </select>
                </div>
                <button 
                    id="btnFiltrar" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors"
                >
                    Filtrar
                </button>
            </div>
        </div>
    </section>

    <!-- Contenido Principal -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading -->
        <div id="loading" class="text-center py-8">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Cargando productos...</p>
        </div>

        <!-- Error -->
        <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <p id="errorMessage"></p>
            <button id="btnRecargar" class="mt-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                Intentar de nuevo
            </button>
        </div>

        <!-- Estad√≠sticas -->
        <div id="estadisticas" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Total Productos</h3>
                <p id="totalProductos" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Categor√≠as</h3>
                <p id="totalCategorias" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Stock Bajo</h3>
                <p id="stockBajo" class="text-3xl font-bold text-red-600">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold text-gray-700">Valor Total</h3>
                <p id="valorTotal" class="text-3xl font-bold text-purple-600">$0</p>
            </div>
        </div>

        <!-- Grid de Productos -->
        <div id="productosGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
        </div>

        <!-- Paginaci√≥n -->
        <div id="paginacion" class="hidden flex justify-center items-center space-x-4 mt-8">
            <button id="btnAnterior" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded disabled:opacity-50">
                ‚Üê Anterior
            </button>
            <span id="infoPagina" class="text-gray-600">P√°gina 1 de 1</span>
            <button id="btnSiguiente" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded disabled:opacity-50">
                Siguiente ‚Üí
            </button>
        </div>
    </main>

    <!-- Modal de Login -->
    <div id="modalLogin" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Iniciar Sesi√≥n</h2>
            <form id="formLogin">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input 
                        type="email" 
                        id="email" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="admin@ferreteria.com"
                    >
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label>
                    <input 
                        type="password" 
                        id="password" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="admin123"
                    >
                </div>
                <div class="flex space-x-4">
                    <button 
                        type="submit" 
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors"
                    >
                        Iniciar Sesi√≥n
                    </button>
                    <button 
                        type="button" 
                        id="btnCancelarLogin" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-md transition-colors"
                    >
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Producto -->
    <div id="modalProducto" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <h2 id="tituloProducto" class="text-2xl font-bold">Detalles del Producto</h2>
                <button id="btnCerrarModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="contenidoProducto">
                <!-- Contenido del producto se carga aqu√≠ -->
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la API
        const API_URL = 'http://localhost:8000/api';
        
        // Variables globales
        let productos = [];
        let categorias = [];
        let inventario = [];
        let paginaActual = 0;
        let productosPorPagina = 12;
        let totalPaginas = 1;
        let filtrosActivos = {};
        
        // Elementos del DOM
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const estadisticas = document.getElementById('estadisticas');
        const productosGrid = document.getElementById('productosGrid');
        const paginacion = document.getElementById('paginacion');
        const modalLogin = document.getElementById('modalLogin');
        const modalProducto = document.getElementById('modalProducto');
        
        // Funciones de utilidad
        function getAuthToken() {
            return localStorage.getItem('token');
        }
        
        function isAuthenticated() {
            return !!getAuthToken();
        }
        
        function updateAuthUI() {
            const btnLogin = document.getElementById('btnLogin');
            const btnLogout = document.getElementById('btnLogout');
            
            if (isAuthenticated()) {
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
            } else {
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
            }
        }
        
        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            const config = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` }),
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(`${API_URL}${url}`, config);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    updateAuthUI();
                }
                
                return response;
            } catch (err) {
                console.error('Error en request:', err);
                throw err;
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            error.classList.remove('hidden');
            loading.classList.add('hidden');
        }
        
        function hideError() {
            error.classList.add('hidden');
        }
        
        function showLoading() {
            loading.classList.remove('hidden');
            hideError();
        }
        
        function hideLoading() {
            loading.classList.add('hidden');
        }
        
        // Funciones de API
        async function login(email, password) {
            try {
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        username: email,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.access_token);
                    updateAuthUI();
                    modalLogin.classList.add('hidden');
                    await cargarDatos();
                } else {
                    const error = await response.json();
                    alert('Error de login: ' + error.detail);
                }
            } catch (err) {
                console.error('Error en login:', err);
                alert('Error de conexi√≥n');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            updateAuthUI();
            // Recargar solo productos p√∫blicos
            cargarProductos();
        }
        
        async function cargarCategorias() {
            try {
                const response = await fetchWithAuth('/categorias');
                if (response && response.ok) {
                    categorias = await response.json();
                    
                    const select = document.getElementById('filtroCategoria');
                    select.innerHTML = '<option value="">Todas las categor√≠as</option>';
                    
                    categorias.forEach(categoria => {
                        const option = new Option(categoria.nombre, categoria.id_categoria);
                        select.add(option);
                    });
                }
            } catch (err) {
                console.error('Error al cargar categor√≠as:', err);
            }
        }
        
        async function cargarProductos() {
            try {
                let url = '/productos?';
                const params = new URLSearchParams();
                
                params.append('skip', paginaActual * productosPorPagina);
                params.append('limit', productosPorPagina);
                
                if (filtrosActivos.categoria_id) {
                    params.append('categoria_id', filtrosActivos.categoria_id);
                }
                
                url += params.toString();
                
                const response = await fetchWithAuth(url);
                if (response && response.ok) {
                    productos = await response.json();
                    
                    // Filtrar por nombre en el frontend
                    if (filtrosActivos.nombre) {
                        productos = productos.filter(producto => 
                            producto.nombre.toLowerCase().includes(filtrosActivos.nombre.toLowerCase())
                        );
                    }
                    
                    // Ordenar productos
                    ordenarProductos();
                    
                    mostrarProductos();
                    actualizarPaginacion();
                } else {
                    throw new Error('Error al cargar productos');
                }
            } catch (err) {
                console.error('Error al cargar productos:', err);
                showError('Error al cargar productos. Verifique su conexi√≥n.');
            }
        }
        
        async function cargarInventario() {
            if (!isAuthenticated()) return;
            
            try {
                const response = await fetchWithAuth('/inventario');
                if (response && response.ok) {
                    inventario = await response.json();
                }
            } catch (err) {
                console.error('Error al cargar inventario:', err);
            }
        }
        
        function ordenarProductos() {
            const orden = filtrosActivos.orden || 'nombre';
            
            productos.sort((a, b) => {
                switch (orden) {
                    case 'precio_asc':
                        return a.precio - b.precio;
                    case 'precio_desc':
                        return b.precio - a.precio;
                    case 'nombre':
                    default:
                        return a.nombre.localeCompare(b.nombre);
                }
            });
        }
        
        function mostrarProductos() {
            productosGrid.innerHTML = '';
            
            if (productos.length === 0) {
                productosGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-gray-500 text-lg">No se encontraron productos</p>
                    </div>
                `;
            } else {
                productos.forEach(producto => {
                    const inventarioItem = inventario.find(item => item.id_producto === producto.id);
                    const stock = inventarioItem ? inventarioItem.cantidad_actual : 0;
                    const stockMinimo = inventarioItem ? inventarioItem.stock_minimo : 5;
                    const stockBajo = stock <= stockMinimo;
                    
                    const card = document.createElement('div');
                    card.className = 'producto-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer';
                    card.onclick = () => mostrarDetalleProducto(producto);
                    
                    card.innerHTML = `
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="text-lg font-semibold text-gray-800 line-clamp-2">${producto.nombre}</h3>
                                ${isAuthenticated() ? `
                                    <span class="px-2 py-1 text-xs rounded-full ${
                                        stockBajo ? 'stock-bajo' : 'stock-ok'
                                    }">
                                        Stock: ${stock}
                                    </span>
                                ` : ''}
                            </div>
                            
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                                ${producto.descripcion || 'Sin descripci√≥n'}
                            </p>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-blue-600">
                                    $${producto.precio.toLocaleString()}
                                </span>
                                <span class="text-sm text-gray-500">
                                    ${producto.categoria || 'Sin categor√≠a'}
                                </span>
                            </div>
                            
                            ${stockBajo && isAuthenticated() ? `
                                <div class="mt-3 p-2 bg-yellow-100 border border-yellow-300 rounded text-yellow-800 text-xs">
                                    ‚ö†Ô∏è Stock bajo - Reabastecer pronto
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    productosGrid.appendChild(card);
                });
            }
            
            productosGrid.classList.remove('hidden');
            hideLoading();
        }
        
        function mostrarDetalleProducto(producto) {
            const inventarioItem = inventario.find(item => item.id_producto === producto.id);
            const stock = inventarioItem ? inventarioItem.cantidad_actual : 'N/A';
            const stockMinimo = inventarioItem ? inventarioItem.stock_minimo : 'N/A';
            
            document.getElementById('tituloProducto').textContent = producto.nombre;
            
            const contenido = document.getElementById('contenidoProducto');
            contenido.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Informaci√≥n General</h3>
                        <div class="space-y-2">
                            <p><strong>Nombre:</strong> ${producto.nombre}</p>
                            <p><strong>Descripci√≥n:</strong> ${producto.descripcion || 'Sin descripci√≥n'}</p>
                            <p><strong>Categor√≠a:</strong> ${producto.categoria || 'Sin categor√≠a'}</p>
                            <p><strong>Precio:</strong> <span class="text-2xl font-bold text-blue-600">$${producto.precio.toLocaleString()}</span></p>
                        </div>
                    </div>
                    
                    ${isAuthenticated() ? `
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Informaci√≥n de Inventario</h3>
                            <div class="space-y-2">
                                <p><strong>Stock Actual:</strong> 
                                    <span class="${stock <= stockMinimo ? 'text-red-600' : 'text-green-600'} font-semibold">
                                        ${stock}
                                    </span>
                                </p>
                                <p><strong>Stock M√≠nimo:</strong> ${stockMinimo}</p>
                                <p><strong>Estado:</strong> 
                                    <span class="px-2 py-1 rounded-full text-xs ${
                                        stock <= stockMinimo ? 'stock-bajo' : 'stock-ok'
                                    }">
                                        ${stock <= stockMinimo ? 'Stock Bajo' : 'Stock OK'}
                                    </span>
                                </p>
                                ${producto.costo_bruto ? `<p><strong>Costo Bruto:</strong> $${producto.costo_bruto.toLocaleString()}</p>` : ''}
                                ${producto.porcentaje_utilidad ? `<p><strong>Utilidad:</strong> ${producto.porcentaje_utilidad}%</p>` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">¬øNecesitas m√°s informaci√≥n?</h3>
                            <p class="text-gray-600 mb-3">Inicia sesi√≥n para ver detalles de inventario y precios especiales.</p>
                            <button onclick="document.getElementById('modalProducto').classList.add('hidden'); document.getElementById('modalLogin').classList.remove('hidden');" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                Iniciar Sesi√≥n
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            modalProducto.classList.remove('hidden');
        }
        
        function actualizarEstadisticas() {
            if (!isAuthenticated()) {
                estadisticas.classList.add('hidden');
                return;
            }
            
            const totalProductos = productos.length;
            const totalCategorias = new Set(productos.map(p => p.categoria)).size;
            const stockBajo = inventario.filter(item => item.cantidad_actual <= item.stock_minimo).length;
            const valorTotal = productos.reduce((total, producto) => {
                const inventarioItem = inventario.find(item => item.id_producto === producto.id);
                const stock = inventarioItem ? inventarioItem.cantidad_actual : 0;
                return total + (producto.precio * stock);
            }, 0);
            
            document.getElementById('totalProductos').textContent = totalProductos;
            document.getElementById('totalCategorias').textContent = totalCategorias;
            document.getElementById('stockBajo').textContent = stockBajo;
            document.getElementById('valorTotal').textContent = `$${valorTotal.toLocaleString()}`;
            
            estadisticas.classList.remove('hidden');
        }
        
        function actualizarPaginacion() {
            const totalItems = productos.length;
            totalPaginas = Math.ceil(totalItems / productosPorPagina);
            
            document.getElementById('infoPagina').textContent = `P√°gina ${paginaActual + 1} de ${Math.max(1, totalPaginas)}`;
            document.getElementById('btnAnterior').disabled = paginaActual === 0;
            document.getElementById('btnSiguiente').disabled = paginaActual >= totalPaginas - 1;
            
            if (totalItems > productosPorPagina) {
                paginacion.classList.remove('hidden');
            } else {
                paginacion.classList.add('hidden');
            }
        }
        
        function aplicarFiltros() {
            filtrosActivos = {
                nombre: document.getElementById('filtroNombre').value,
                categoria_id: document.getElementById('filtroCategoria').value,
                orden: document.getElementById('filtroOrden').value
            };
            
            paginaActual = 0;
            showLoading();
            cargarProductos();
        }
        
        async function cargarDatos() {
            showLoading();
            
            try {
                await Promise.all([
                    cargarCategorias(),
                    cargarInventario()
                ]);
                
                await cargarProductos();
                actualizarEstadisticas();
            } catch (err) {
                console.error('Error al cargar datos:', err);
                showError('Error al cargar los datos iniciales');
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            cargarDatos();
        });
        
        // Botones de autenticaci√≥n
        document.getElementById('btnLogin').addEventListener('click', () => {
            modalLogin.classList.remove('hidden');
        });
        
        document.getElementById('btnLogout').addEventListener('click', logout);
        
        document.getElementById('btnCancelarLogin').addEventListener('click', () => {
            modalLogin.classList.add('hidden');
        });
        
        // Formulario de login
        document.getElementById('formLogin').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            login(email, password);
        });
        
        // Filtros
        document.getElementById('btnFiltrar').addEventListener('click', aplicarFiltros);
        
        document.getElementById('filtroNombre').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                aplicarFiltros();
            }
        });
        
        // Paginaci√≥n
        document.getElementById('btnAnterior').addEventListener('click', () => {
            if (paginaActual > 0) {
                paginaActual--;
                showLoading();
                cargarProductos();
            }
        });
        
        document.getElementById('btnSiguiente').addEventListener('click', () => {
            if (paginaActual < totalPaginas - 1) {
                paginaActual++;
                showLoading();
                cargarProductos();
            }
        });
        
        // Cerrar modales
        document.getElementById('btnCerrarModal').addEventListener('click', () => {
            modalProducto.classList.add('hidden');
        });
        
        document.getElementById('btnRecargar').addEventListener('click', () => {
            cargarDatos();
        });
        
        // Cerrar modales al hacer clic fuera
        modalLogin.addEventListener('click', (e) => {
            if (e.target === modalLogin) {
                modalLogin.classList.add('hidden');
            }
        });
        
        modalProducto.addEventListener('click', (e) => {
            if (e.target === modalProducto) {
                modalProducto.classList.add('hidden');
            }
        });
    </script>
</body>
</html>